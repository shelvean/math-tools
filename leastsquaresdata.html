<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Polynomial Least Squares Fitting Calculator | Online L2 Norm Curve Fitter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Free online polynomial least squares fitting tool. Fit polynomials to discrete points, functions on intervals, or uploaded data files. Visualize results, compute L² error, and evaluate the fitted curve. Supports degrees up to 14.">
  <meta name="keywords" content="polynomial least squares, curve fitting, polynomial regression calculator, online least squares fitter, L2 norm approximation, data fitting tool, polynomial interpolation">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Polynomial Least Squares Fitting Calculator | Online Tool">
  <meta property="og:description" content="Interactive free tool for polynomial least squares fitting with visualization, L² error calculation, and support for points, functions, and file uploads.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yourdomain.com/polynomial-ls-fitting.html"> <!-- Replace with actual URL if hosted -->
  <meta property="og:image" content="https://yourdomain.com/preview-image.png"> <!-- Optional: Add a preview screenshot URL -->
  <meta name="twitter:card" content="summary_large_image">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.9.1/lib/browser/math.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    #plot svg { background-color: #f7f7f7; }
    .grid line { stroke: #e0e0e0; stroke-opacity: 0.7; }
    .grid path { stroke: none; }
    .katex-display { margin: 0.5em 0; }
    .latex-eval td, .latex-eval th { padding: 0.3em 0.8em; border: 1px solid #90a4ae; }
    .latex-eval { border-collapse: collapse; margin: 0 auto; }
    #legend-bar { display: flex; justify-content:center; align-items:center; gap:1.5em; font-size:1em; margin: 12px 0 8px 0; }
    .legitem { display: flex; align-items: center; gap:0.4em;}
    .legicon-poly { display: inline-block; width:20px;height:3.5px;background:#2196f3;}
    .legicon-pts { display:inline-block;width:10px;height:10px;background:red; border:2px solid #111; border-radius:50%; }
    .legicon-fun { display:inline-block;width:20px;height:3.5px;background:#27AE60;}
  </style>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5B8PRB2WZT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-5B8PRB2WZT');
  </script>
</head>
<body class="bg-gray-100 text-gray-900">
<div class="bg-white shadow-sm py-6 px-4 sticky top-0 z-10">
    <h1 class="text-4xl text-black text-center mb-4 font-bold">Polynomial Least Squares Data Fitting</h1>
    <div class="text-center text-base mb-3 text-gray-600">Polynomial degree, L² error &mdash; Discrete, file, or function on interval</div>
</div>
<div class="bg-white p-6 rounded-lg shadow-md max-w-2xl w-full mx-auto mt-8 mb-8">
  <div class="flex justify-center space-x-8 mb-4">
    <label class="flex items-center"><input type="radio" name="input_type" value="discrete" checked class="mr-2">Discrete points</label>
    <label class="flex items-center"><input type="radio" name="input_type" value="function" class="mr-2">From function</label>
    <label class="flex items-center"><input type="radio" name="input_type" value="file" class="mr-2">From file</label>
  </div>
  <div id="input-discrete">
    <div>
      <label class="block text-gray-700 latex">$x$ values (comma separated):</label>
      <input type="text" id="x_values" class="w-full p-2 border rounded mb-2" placeholder="e.g., -2, -1, 0, 1, 2">
    </div>
    <div>
      <label class="block text-gray-700 latex">$y = f(x)$ values (comma separated):</label>
      <input type="text" id="y_values" class="w-full p-2 border rounded" placeholder="e.g., 1,0,-1,0,1">
    </div>
  </div>
  <div id="input-function" style="display:none;">
    <div>
      <label class="block text-gray-700">Function $f(x)$:</label>
      <input type="text" id="func" class="w-full p-2 border rounded mb-2" value="sin(x)">
    </div>
    <div class="flex space-x-2">
      <div class="w-1/2">
        <label class="block text-gray-700">Interval start $a$:</label>
        <input type="text" id="a" class="w-full p-2 border rounded" value="0">
      </div>
      <div class="w-1/2">
        <label class="block text-gray-700">Interval end $b$:</label>
        <input type="text" id="b" class="w-full p-2 border rounded" value="6.28">
      </div>
    </div>
  </div>
  <div id="input-file" style="display:none;">
    <label class="block text-gray-700">Upload file (txt, csv, xlsx, ods):</label>
    <input type="file" id="fileUpload" accept=".txt,.csv,.xlsx,.ods" class="w-full p-2 border rounded mb-2">
    <div id="colpick" style="display:none;" class="mt-2">
      <div class="flex space-x-2">
        <div class="w-1/2">
          <label class="block text-gray-700">X column:</label>
          <select id="xcol" class="w-full p-2 border rounded"></select>
        </div>
        <div class="w-1/2">
          <label class="block text-gray-700">Y column:</label>
          <select id="ycol" class="w-full p-2 border rounded"></select>
        </div>
      </div>
      <button id="loadcols" class="bg-blue-500 text-white px-4 py-1 rounded mt-2">Load Data</button>
    </div>
  </div>
  <div class="flex space-x-3 items-center mt-3 mb-2">
    <div>
      <label class="text-gray-700">Polynomial degree:</label>
      <select id="degree" class="p-1 border rounded w-24">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7" selected>7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
      </select>
    </div>
  </div>
  <div class="flex justify-center mt-3 space-x-3">
    <button id="compute" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">Fit Polynomial</button>
    <button id="clear" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">Clear All</button>
  </div>
  <div id="result" class="mt-6 bg-gray-50 rounded p-4 overflow-x-auto"></div>
  <div id="plot" class="mt-8 flex justify-center"></div>
  <div id="legend-bar" class="mb-4"></div>
  <div class="flex justify-center mt-3 mb-0">
      <button id="download-btn" class="bg-blue-400 text-white px-4 py-2 rounded hover:bg-blue-500" style="display:none;">Download Plot as PNG</button>
  </div>
  <div id="evaldiv" class="flex flex-col items-center mt-6" style="display:none;">
      <label class="block text-gray-700 mb-1">Evaluate at x (comma separated):</label>
      <div class="flex space-x-4">
        <input type="text" id="eval_x" class="w-80 p-2 border rounded" placeholder="e.g., 0, 1, 2">
        <button id="eval-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Evaluate</button>
      </div>
      <div id="eval-output" class="mt-4 p-3 bg-gray-50 rounded w-full"></div>
      <div id="l2-error-container" class="mt-6 text-center text-lg"></div>
  </div>
</div>

<footer class="text-center py-4 border-t mt-8 text-gray-600 text-sm">
    &copy; 2025 Shelvean Kapita: kapita@tamu.edu<br>
    All code released under the <a href="https://opensource.org/licenses/MIT" class="text-blue-600 hover:underline">MIT License</a>.<br>
    Last modified: December 18, 2025
</footer>

<script>
<!-- The entire original JavaScript code remains unchanged here -->
let selectedNodeType = 'equispaced';
document.querySelectorAll('input[name="input_type"]').forEach(r => r.addEventListener('change', updateInputMode));
updateInputMode();
function updateInputMode() {
  const mode = document.querySelector('input[name="input_type"]:checked').value;
  document.getElementById('input-discrete').style.display = mode === 'discrete' ? 'block' : 'none';
  document.getElementById('input-function').style.display = mode === 'function' ? 'block' : 'none';
  document.getElementById('input-file').style.display = mode === 'file' ? 'block' : 'none';
}
let fileTable = null;
document.getElementById('fileUpload').addEventListener('change', evt=>{
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    if (/csv|txt/.test(file.name)) {
      fileTable = Papa.parse(ev.target.result).data;
    } else {
      let wb = XLSX.read(ev.target.result, {type:'binary'});
      let ws = wb.Sheets[wb.SheetNames[0]];
      fileTable = XLSX.utils.sheet_to_json(ws, {header:1});
    }
    let cols = fileTable[0].map((h,j)=>"Col "+(j+1));
    let xcol = document.getElementById('xcol'), ycol = document.getElementById('ycol');
    xcol.innerHTML = ""; ycol.innerHTML = "";
    cols.forEach((v,i)=>{
      let o=document.createElement('option'); o.value=i; o.textContent=v; xcol.appendChild(o);
      let o2=document.createElement('option'); o2.value=i; o2.textContent=v; ycol.appendChild(o2);
    });
    document.getElementById('colpick').style.display = 'block';
  }
  reader.readAsBinaryString(file);
});
document.getElementById('loadcols').onclick = function(){
  let xi = +document.getElementById('xcol').value;
  let yi = +document.getElementById('ycol').value;
  let xs = [], ys = [];
  for (let i=1; i<fileTable.length; ++i) {
    let xv = fileTable[i][xi], yv = fileTable[i][yi];
    if (xv !== undefined && yv !== undefined && xv!=='' && yv!=='') {
      xs.push(xv); ys.push(yv);
    }
  }
  document.getElementById('x_values').value = xs.join(",");
  document.getElementById('y_values').value = ys.join(",");
  document.getElementById('colpick').style.display = 'none';
  document.querySelector('input[value=discrete]').checked = true;
  updateInputMode();
};
function gcd(a, b) {a=Math.abs(a);b=Math.abs(b);while(b){let t=b;b=a%b;a=t;}return a;}
function toFraction(num, tol=1e-10) {
  if (isNaN(num)) return '\\text{NaN}';
  if (!isFinite(num)) return num > 0 ? '\\infty' : '-\\infty';
  if (Math.abs(num) < 1e-13) return '0';
  const pi = Math.PI;
  const piTests = [pi, pi/2, pi/3, pi/4, pi/6].map((v,i)=>[v, ['\\pi','\\frac{\\pi}{2}','\\frac{\\pi}{3}','\\frac{\\pi}{4}','\\frac{\\pi}{6}'][i]]);
  for (let [v,s] of piTests) {
    if (Math.abs(num-v)<tol) return s;
    if (Math.abs(num+v)<tol) return '-'+s;
  }
  if (Math.abs(num) < 1e-3 && Math.abs(num)>=1e-13) {
    let sign = num<0 ? '-' : '';
    let absNum = Math.abs(num);
    let exp = Math.floor(Math.log10(absNum));
    let c = (absNum / Math.pow(10,exp)).toFixed(2);
    return `${sign}${c}\\cdot 10^{${exp}}`
  }
  let sign = num<0?'-':''; num=Math.abs(num);
  let h1=1,h2=0,k1=0,k2=1,b=num;
  for (let i=0; i<30;++i) {
    let a=Math.floor(b),h=a*h1+h2,k=a*k1+k2;
    if (Math.abs(num-h/k)<tol) {
      let g=gcd(h,k);h/=g;k/=g;
      if (k>50) break;
      return sign+(k==1?h:`\\dfrac{${h}}{${k}}`);
    }
    h2=h1;h1=h;k2=k1;k1=k; b=1/(b-a);
  }
  return sign+parseFloat(num).toFixed(6).replace(/\.?0+$/,'');
}
function lsfit_discrete(x, y, deg) {
  let n = x.length, m = deg+1;
  let A = Array.from({length: n}, (_,i)=>Array.from({length: m},(_,j)=>Math.pow(x[i],j)));
  let AT = Array.from({length: m},(_,j)=>A.map(r=>r[j]));
  let ATA = Array.from({length: m},(_,i)=>Array.from({length: m},(_,j)=>AT[i].reduce((a,v,k)=>a+v*A[k][j],0)));
  let ATb = Array.from({length: m},(_,j)=>AT[j].reduce((a,v,i)=>a+v*y[i],0));
  let M = ATA.map(r=>r.slice());
  let bvec = ATb.slice();
  for (let k=0; k<m; ++k){
    let maxr=k;
    for (let i=k+1;i<m;++i) if (Math.abs(M[i][k])>Math.abs(M[maxr][k])) maxr=i;
    [M[k],M[maxr]]=[M[maxr],M[k]]; [bvec[k],bvec[maxr]]=[bvec[maxr],bvec[k]];
    for (let i=k+1;i<m;++i){
      let f=M[i][k]/M[k][k];
      for (let j=k;j<m;++j) M[i][j]-=f*M[k][j];
      bvec[i]-=f*bvec[k];
    }
  }
  let xsol=new Array(m);
  for (let i=m-1;i>=0;--i){
    let s=0;
    for(let j=i+1;j<m;++j) s+=M[i][j]*xsol[j];
    xsol[i]=(bvec[i]-s)/M[i][i];
  }
  return xsol;
}
const GL3 = {
  nodes: [-0.7745966692414834,0,0.7745966692414834],
  weights: [0.5555555555555556,0.8888888888888888,0.5555555555555556]
};
function composite_gauss3(f, a, b) {
  const nPanels = Math.ceil(3 * Math.abs(b-a));
  const nodes = GL3.nodes, weights = GL3.weights;
  let res = 0;
  for (let p = 0; p < nPanels; ++p) {
    let x0 = a + (b - a) * p / nPanels, x1 = a + (b - a) * (p+1) / nPanels;
    let mid = (x0 + x1) / 2, halflen = (x1 - x0) / 2;
    for (let i=0; i<3; ++i)
      res += weights[i] * f(mid + halflen * nodes[i]) * halflen;
  }
  return res;
}
function lsfit_continuous(func, a, b, deg) {
  let m = deg+1;
  let M = Array.from({length:m},()=>Array(m));
  let rhs = Array(m);
  for (let i=0;i<m;++i) {
    for (let j=0;j<m;++j)
      M[i][j]=composite_gauss3(x=>Math.pow(x,i+j),a,b);
    rhs[i]=composite_gauss3(x=>func(x)*Math.pow(x,i),a,b);
  }
  let N = m, mat = M.map(r=>r.slice()), bvec = rhs.slice();
  for (let k=0;k<N;++k){
    let maxr=k;
    for(let i=k+1; i<N;++i) if (Math.abs(mat[i][k])>Math.abs(mat[maxr][k])) maxr=i;
    [mat[k],mat[maxr]]=[mat[maxr],mat[k]]; [bvec[k],bvec[maxr]]=[bvec[maxr],bvec[k]];
    for(let i=k+1;i<N;++i){
      let f=mat[i][k]/mat[k][k];
      for(let j=k;j<N;++j) mat[i][j]-=f*mat[k][j];
      bvec[i]-=f*bvec[k];
    }
  }
  let xsol = Array(N);
  for(let i=N-1;i>=0;--i){
    let s=0;
    for(let j=i+1;j<N;++j) s+=mat[i][j]*xsol[j];
    xsol[i]=(bvec[i]-s)/mat[i][i];
  }
  return xsol;
}
function l2_norm_error(f, p, a, b) {
  return Math.sqrt(composite_gauss3(x => {
    let fx = f(x), px = p(x);
    return (fx - px) * (fx - px);
  }, a, b));
}
function polyToLatex(coef) {
  let s="p(x) = ";
  let d=coef.length-1, first=true;
  for(let i=d;i>=0;--i){
    if (Math.abs(coef[i])<1e-12) continue;
    let c=toFraction(coef[i]);
    let sign = first? (c[0]=='-'?'-':'') : (c[0]=='-'?'-':'+');
    c=c.replace(/^\-/,'');
    let part = '';
    if (c=='1'&&i>0) part = '';
    else if (c=='0') continue;
    else part = c;
    if (i>1) s+=`${sign}${part}x^{${i}} `;
    else if(i==1) s+=`${sign}${part}x `;
    else s+= `${sign}${part} `;
    first=false;
  }
  if(first) s+='0';
  s=s.replace(/\+\-/g,'-'); return s;
}
let coeffs = null, origPtsX=null, origPtsY=null, fitShowX=null, fitShowY=null, origFuncEval=null, lastInputMode=null, l2error=null;
document.getElementById('compute').onclick = function(){
  document.getElementById('result').innerHTML = '';
  document.getElementById('plot').innerHTML = '';
  document.getElementById('legend-bar').innerHTML='';
  document.getElementById('evaldiv').style.display = "none";
  document.getElementById('l2-error-container').innerHTML = '';
  coeffs = null; origPtsX = null; origPtsY = null; fitShowX=null; fitShowY=null; origFuncEval=null; l2error = null;
  let deg = parseInt(document.getElementById('degree').value);
  let mode = document.querySelector('input[name="input_type"]:checked').value;
  lastInputMode = mode;
  let x=[], y=[], fun=null, a=0, b=1, nsamples=50;
  try {
    if (mode=="discrete") {
      x = document.getElementById('x_values').value.split(',').map(e=>math.evaluate(e.trim()));
      y = document.getElementById('y_values').value.split(',').map(e=>math.evaluate(e.trim()));
      if (!(x.length==y.length && x.length>=deg+1)) throw "Number of points must be >= degree+1 and match.";
      coeffs = lsfit_discrete(x,y,deg);
      origPtsX = x.slice();
      origPtsY = y.slice();
      let minx = Math.min(...x), maxx = Math.max(...x);
      fitShowX = [], fitShowY = [];
      for(let i=0;i<=200;++i) {
        let xx = minx + (maxx-minx)*i/200;
        fitShowX.push(xx);
        fitShowY.push(coeffs.reduce((s,c,j)=>s+c*Math.pow(xx,j),0));
      }
    } else if (mode=="function") {
      let funstr = document.getElementById('func').value.trim();
      fun = x=>math.evaluate(funstr, {x});
      a = math.evaluate(document.getElementById('a').value.trim());
      b = math.evaluate(document.getElementById('b').value.trim());
      nsamples = 50;
      let xs = [];
      for(let i=0;i<nsamples;++i) xs.push(a + (b-a)*i/(nsamples-1));
      coeffs = lsfit_continuous(fun, a, b, deg);
      origPtsX = xs.slice();
      origPtsY = xs.map(xx=>fun(xx));
      fitShowX=[],fitShowY=[],origFuncEval=[];
      for(let i=0;i<=250;++i) {
        let xx = a + (b-a)*i/250;
        fitShowX.push(xx);
        fitShowY.push(coeffs.reduce((s,c,j)=>s+c*Math.pow(xx,j),0));
        origFuncEval.push(fun(xx));
      }
      let pfun = x => coeffs.reduce((s,c,j)=>s+c*Math.pow(x,j),0);
      l2error = l2_norm_error(fun, pfun, a, b);
    } else if (mode=="file") {
      x = document.getElementById('x_values').value.split(',').map(e=>+e.trim());
      y = document.getElementById('y_values').value.split(',').map(e=>+e.trim());
      if (!(x.length==y.length && x.length>=deg+1)) throw "Number of points must be >= degree+1 and match.";
      coeffs = lsfit_discrete(x,y,deg);
      origPtsX = x.slice();
      origPtsY = y.slice();
      let minx = Math.min(...x), maxx = Math.max(...x);
      fitShowX = [], fitShowY = [];
      for(let i=0;i<=200;++i) {
        let xx = minx + (maxx-minx)*i/200;
        fitShowX.push(xx);
        fitShowY.push(coeffs.reduce((s,c,j)=>s+c*Math.pow(xx,j),0));
      }
    }
  } catch(e) {
    document.getElementById('result').innerHTML = '<div class="text-red-500">Input error: ' + e + '</div>';
    return;
  }
  let out = `<div class="mb-2 font-bold text-gray-700">Fitted Least Squares Polynomial (degree ${deg}):</div>
  <div id="poly-latex"></div>`;
  document.getElementById('result').innerHTML = out;
  setTimeout(()=>katex.render(polyToLatex(coeffs), document.getElementById('poly-latex'), {throwOnError:false, displayMode:true}),50);
  let legbar = `<span class="legitem"><span class="legicon-poly"></span>Fitted poly</span>`;
  if (origFuncEval)
    legbar += `<span class="legitem"><span class="legicon-fun"></span>Function</span>`;
  if (mode !== "function")
    legbar += `<span class="legitem"><span class="legicon-pts"></span>Data pts</span>`;
  document.getElementById('legend-bar').innerHTML = legbar;
  let allx = fitShowX.concat((mode!=="function" && origPtsX)?origPtsX:[]),
      ally = fitShowY.concat((mode!=="function"&&origPtsY)?origPtsY:[]);
  let minx = Math.min(...allx), maxx = Math.max(...allx);
  let miny = Math.min(...ally), maxy = Math.max(...ally);
  if (origFuncEval) {
    miny = Math.min(miny, ...origFuncEval);
    maxy = Math.max(maxy, ...origFuncEval);
  }
  let ypad = 0.05*(maxy-miny);
  if (ypad==0) ypad=0.1;
  let width = 400, height = 300, m={l:40,r:10,t:10,b:40};
  let svg = d3.select("#plot").html('').append("svg")
    .attr("width",width+m.l+m.r).attr("height",height+m.t+m.b)
    .append("g").attr("transform",`translate(${m.l},${m.t})`);
  let xScale = d3.scaleLinear().domain([minx, maxx]).range([0, width]);
  let yScale = d3.scaleLinear().domain([miny-ypad,maxy+ypad]).range([height, 0]);
  svg.append("g").attr("transform",`translate(0,${height})`).call(d3.axisBottom(xScale));
  svg.append("g").call(d3.axisLeft(yScale));
  svg.append('g').attr('class','grid').attr('transform', `translate(0,${height})`)
    .call(d3.axisBottom(xScale).tickSize(-height).tickFormat(''));
  svg.append('g').attr('class','grid')
    .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(''));
  svg.append("path")
    .datum(fitShowX.map((v,i)=>[v, fitShowY[i]]))
    .attr("fill","none").attr("stroke","blue").attr("stroke-width",2)
    .attr("d", d3.line()
      .x(d=>xScale(d[0]))
      .y(d=>yScale(d[1]))
    );
  if (mode!=="function") {
    svg.selectAll('circle.data')
      .data(origPtsX)
      .enter()
      .append('circle')
      .attr('cx',d=>xScale(d))
      .attr('cy',(d,i)=>yScale(origPtsY[i]))
      .attr('r',5)
      .attr('fill','red')
      .attr('stroke','#111');
  }
  if (origFuncEval) {
    svg.append("path")
      .datum(fitShowX.map((v,i)=>[v, origFuncEval[i]]))
      .attr("fill","none").attr("stroke","#27AE60").attr("stroke-width",2)
      .attr("d",d3.line()
        .x(d=>xScale(d[0]))
        .y(d=>yScale(d[1]))
      );
  }
  document.getElementById('download-btn').style.display = "";
  document.getElementById('download-btn').onclick = function(){
    let svgElem = document.querySelector('#plot svg');
    let src = (new XMLSerializer()).serializeToString(svgElem);
    let image = new Image();
    let canvas = document.createElement('canvas');
    canvas.width = svgElem.width.baseVal.value;
    canvas.height = svgElem.height.baseVal.value;
    image.onload = function() {
      let ctx = canvas.getContext('2d');
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(image, 0, 0);
      let a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'fitplot.png';
      a.click();
    };
    image.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(src)));
  };
  document.getElementById('evaldiv').style.display = '';
  if (mode=="function" && typeof l2error === "number") {
    setTimeout(()=>{
      document.getElementById('l2-error-container').innerHTML =
        `<span class="italic text-gray-800">L<sub>2</sub> error:&nbsp;</span>
         <span class="text-blue-800" id="l2-norm-latex"></span>`;
      katex.render(String.raw`\left\|f-p\right\|_{L^2} = ` + toFraction(l2error), document.getElementById('l2-norm-latex'), {throwOnError:false});
    }, 70);
  } else {
    document.getElementById('l2-error-container').innerHTML = '';
  }
};
document.getElementById('clear').onclick=() => {
  document.getElementById('x_values').value='';
  document.getElementById('y_values').value='';
  document.getElementById('func').value='sin(x)';
  document.getElementById('a').value='0';
  document.getElementById('b').value='6.28';
  document.getElementById('degree').value='7';
  document.getElementById('result').innerHTML='';
  document.getElementById('plot').innerHTML='';
  document.getElementById('evaldiv').style.display="none";
  document.getElementById('legend-bar').innerHTML='';
  document.getElementById('eval-output').innerHTML='';
  document.getElementById('l2-error-container').innerHTML='';
  // File upload and column picker reset
  document.getElementById('fileUpload').value = '';
  let colpick = document.getElementById('colpick');
  if (colpick) colpick.style.display = 'none';
};
document.getElementById('eval-btn').onclick=function(){
  if (!coeffs) {
    document.getElementById('eval-output').innerHTML='<div class="text-red-500">Fit a polynomial first.</div>';return;
  }
  let xs = document.getElementById('eval_x').value.split(',').map(s=>{try{return math.evaluate(s.trim());}catch(e){return NaN;}});
  let ys = xs.map(xi=>coeffs.reduce((s,c,i)=>s+c*Math.pow(xi,i),0));
  let err=null;
  let mode = document.querySelector('input[name="input_type"]:checked').value;
  let f = null;
  if (mode=='function') {
    try{let funstr = document.getElementById('func').value.trim();f = (x)=>math.evaluate(funstr,{x});}catch{}
    if (f) err = xs.map((x,i)=>Math.abs(f(x)-ys[i]));
  }
  let tbl = `<table class="latex-eval mt-2"><tr>
    <th class="th-x"></th>
    <th class="th-px"></th>`;
  if (err) tbl+='<th class="th-err"></th>';
  tbl+='</tr>';
  for(let i=0;i<xs.length;++i){
    tbl+=`<tr>
      <td class="xcell"></td>
      <td class="pxcell"></td>`;
    if (err) tbl+=`<td class="errcell"></td>`;
    tbl+='</tr>';
  }
  tbl+='</table>';
  document.getElementById('eval-output').innerHTML=tbl;
  // Render headers via KaTeX
  const ths = document.querySelectorAll('.latex-eval th');
  katex.render("x", ths[0], {throwOnError:false});
  katex.render("p(x)", ths[1], {throwOnError:false});
  if (err) katex.render("|f(x)-p(x)|", ths[2], {throwOnError:false});
  let tr = document.querySelectorAll("#eval-output tr");
  for (let i=1;i<tr.length;++i) {
    let tds = tr[i].querySelectorAll("td");
    katex.render(toFraction(xs[i-1]), tds[0], {throwOnError:false});
    katex.render(toFraction(ys[i-1]), tds[1], {throwOnError:false});
    if (err) katex.render(toFraction(err[i-1]), tds[2], {throwOnError:false});
  }
};
window.onload = ()=>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false}]});
</script>
</body>
</html>
