<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Polynomial Least Squares Fitting Calculator | Online L2 Norm Curve Fitter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Polynomial least squares fitting tool. Fit polynomials to discrete points, functions on intervals, or uploaded data files. Visualize results, compute relative L² error, and evaluate the fitted curve. Supports degrees up to 50.">
  <meta name="keywords" content="polynomial least squares, curve fitting, polynomial regression calculator, online least squares fitter, L2 norm approximation, data fitting tool, polynomial interpolation">
  <meta name="robots" content="index, follow">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.9.1/lib/browser/math.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    #plot svg { background-color: #f7f7f7; }
    .grid line { stroke: #f3f3f3; stroke-opacity: 0.8; }
    .grid path { stroke: none; }
    .katex-display { margin: 0.5em 0; }
    .latex-eval td, .latex-eval th { padding: 0.3em 0.8em; border: 1px solid #90a4ae; }
    .latex-eval { border-collapse: collapse; margin: 0 auto; }
    #legend-bar { display: flex; justify-content:center; align-items:center; gap:1.5em; font-size:1em; margin: 12px 0 8px 0; }
    .legitem { display: flex; align-items: center; gap:0.4em;}
    .legicon-poly { display: inline-block; width:20px;height:3.5px;background:#2196f3;}
    .legicon-pts { display:inline-block;width:10px;height:10px;background:red; border:2px solid #111; border-radius:50%; }
    .legicon-fun { display: inline-block; width:20px;height:3.5px;background:#db2114;}
    #error-table { margin-top: 1.5em; width: 100%; }
    #error-table td, #error-table th { padding: 0.6em 0.8em; text-align: center; border: 1px solid #90a4ae; }
    #error-table th { background-color: #f3f4f6; }

    /* Copy polynomial section */
    #copy-section {
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    #copy-controls {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    #format-select {
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background-color: white;
      font-size: 0.875rem;
    }
    #copy-btn {
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.2s;
    }
    #copy-btn:hover {
      background-color: #2563eb;
    }
    #copy-btn:active {
      background-color: #1d4ed8;
    }
    #copy-btn.copied {
      background-color: #10b981;
    }
    #poly-output {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.875rem;
      white-space: pre;
      background-color: white;
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.5;
      tab-size: 4;
    }

    /* About section - after main content */
    #about-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-top: 2rem;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    #about-section h3 {
      font-size: 1.5rem;
      text-align: center;
      color: #1e40af;
      margin-bottom: 1rem;
      font-weight: bold;
    }
    #about-section ul {
      margin-left: 1.2em;
      list-style: disc;
    }
    #about-section .text-sm {
      font-size: 0.875rem;
    }

    /* Examples sidebar - fixed right, hidden on small screens */
    #examples-sidebar {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 280px;
      background: white;
      padding: 1.5em;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 20;
    }
    #examples-sidebar h3 {
      font-size: 1.4em;
      text-align: center;
      color: #1e40af;
      margin-bottom: 1em;
    }
    .example-btn {
      display: block;
      width: 100%;
      margin-bottom: 0.8em;
      padding: 0.8em;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      text-align: center;
      transition: background 0.2s;
    }
    .example-btn:hover {
      background: #4338ca;
    }
    @media (max-width: 1024px) {
      #examples-sidebar { display: none; }
    }
  </style>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5B8PRB2WZT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-5B8PRB2WZT');
  </script>
</head>
<body class="bg-gray-100 text-gray-900">
<div id="preamble" class="status">
  <header class="bg-white shadow-sm py-6 px-4 sticky top-0 z-10">
    <h1 class="text-4xl text-black text-center mb-4 font-bold">
      <a href="index.html">Shelvean Kapita</a>
    </h1>
    <nav>
      <ul class="flex justify-center gap-8">
        <li><a href="index.html" class="text-indigo-500 text-opacity-100 hover:text-blue-600 transition-colors font-bold text-xl">Home</a></li>
        <li><a href="teaching.html" class="text-indigo-500 text-opacity-100 hover:text-blue-600 transition-colors font-bold text-xl">Teaching</a></li>
        <li><a href="projects.html" class="text-indigo-500 text-opacity-100 hover:text-blue-600 transition-colors font-bold text-xl">Diff Eq</a></li>
        <li><a href="linear.html" class="text-indigo-500 text-opacity-100 hover:text-blue-600 transition-colors font-bold text-xl">Linear Algebra</a></li>
        <li><a href="numerical.html" class="text-indigo-500 text-opacity-100 hover:text-blue-600 transition-colors font-bold text-xl">Numerical Methods</a></li>
      </ul>
    </nav>
    <h2 class="text-4xl text-black text-center mt-8 mb-4 font-bold">Polynomial Least Squares Data Fitting</h2>
    <div class="text-center text-base mb-3 text-gray-600 max-w-4xl mx-auto">
      Compute the least squares polynomial approximation of degree up to 50.<br>
      Supports discrete data points, uploaded files (CSV/TXT/XLSX/ODS), or the orthogonal projection of a continuous function onto the space of polynomials over a given interval.<br>
      Visualizes the fit, displays the relative L² error (for functions), and allows evaluation of the fitted polynomial.
    </div>
  </header>
</div>

<div class="bg-white p-6 rounded-lg shadow-md max-w-2xl w-full mx-auto mt-8 mb-8">
  <div class="flex justify-center space-x-8 mb-4">
    <label class="flex items-center"><input type="radio" name="input_type" value="discrete" checked class="mr-2">Discrete points</label>
    <label class="flex items-center"><input type="radio" name="input_type" value="function" class="mr-2">From function</label>
    <label class="flex items-center"><input type="radio" name="input_type" value="file" class="mr-2">From file</label>
  </div>
  <div id="input-discrete">
    <div>
      <label class="block text-gray-700 latex">$x$ values (comma separated):</label>
      <input type="text" id="x_values" class="w-full p-2 border rounded mb-2" placeholder="e.g., -2, -1, 0, 1, 2">
    </div>
    <div>
      <label class="block text-gray-700 latex">$y = f(x)$ values (comma separated):</label>
      <input type="text" id="y_values" class="w-full p-2 border rounded" placeholder="e.g., 1,0,-1,0,1">
    </div>
  </div>
  <div id="input-function" style="display:none;">
    <div>
      <label class="block text-gray-700">Function $f(x)$:</label>
      <input type="text" id="func" class="w-full p-2 border rounded mb-2" value="sin(x)">
    </div>
    <div class="flex space-x-2">
      <div class="w-1/2">
        <label class="block text-gray-700">Interval start $a$:</label>
        <input type="text" id="a" class="w-full p-2 border rounded" value="0">
      </div>
      <div class="w-1/2">
        <label class="block text-gray-700">Interval end $b$:</label>
        <input type="text" id="b" class="w-full p-2 border rounded" value="6.28">
      </div>
    </div>
  </div>
  <div id="input-file" style="display:none;">
    <label class="block text-gray-700">Upload file (txt, csv, xlsx, ods):</label>
    <input type="file" id="fileUpload" accept=".txt,.csv,.xlsx,.ods" class="w-full p-2 border rounded mb-2">
    <div id="colpick" style="display:none;" class="mt-2">
      <div class="flex space-x-2">
        <div class="w-1/2">
          <label class="block text-gray-700">X column:</label>
          <select id="xcol" class="w-full p-2 border rounded"></select>
        </div>
        <div class="w-1/2">
          <label class="block text-gray-700">Y column:</label>
          <select id="ycol" class="w-full p-2 border rounded"></select>
        </div>
      </div>
      <button id="loadcols" class="bg-blue-500 text-white px-4 py-1 rounded mt-2">Load Data</button>
    </div>
  </div>
  <div class="flex space-x-3 items-center mt-3 mb-2">
    <div>
      <label class="text-gray-700">Polynomial degree:</label>
      <input type="number" id="degree" min="0" max="50" value="3" class="p-1 border rounded w-24">
    </div>
  </div>
  <div class="flex justify-center mt-3 space-x-3">
    <button id="compute" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">Fit Polynomial</button>
    <button id="clear" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">Clear All</button>
  </div>
  <div id="result" class="mt-6 bg-gray-50 rounded p-4 overflow-x-auto"></div>
  
  <!-- Copy Polynomial Section -->
  <div id="copy-section" style="display: none;">
    <div id="copy-controls">
      <select id="format-select">
        <option value="latex">LaTeX format</option>
        <option value="python">Python function</option>
        <option value="numpy">NumPy polynomial</option>
        <option value="matlab">MATLAB polynomial</option>
      </select>
      <button id="copy-btn">Copy to clipboard</button>
    </div>
    <div id="poly-output"></div>
  </div>
  
  <div id="plot" class="mt-8 flex justify-center"></div>
  <div id="legend-bar" class="mb-4"></div>
  <div class="flex justify-center mt-3 mb-0">
    <button id="download-btn" class="bg-blue-400 text-white px-4 py-2 rounded hover:bg-blue-500" style="display:none;">Download Plot as PNG</button>
  </div>
  <div id="evaldiv" class="flex flex-col items-center mt-6" style="display:none;">
    <label class="block text-gray-700 mb-1">Evaluate at x (comma separated):</label>
    <div class="flex space-x-4">
      <input type="text" id="eval_x" class="w-80 p-2 border rounded" placeholder="e.g., 0, 1, 2">
      <button id="eval-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Evaluate</button>
    </div>
    <div id="eval-output" class="mt-4 p-3 bg-gray-50 rounded w-full"></div>
    <div id="error-container" class="mt-8 w-full flex justify-center"></div>
  </div>
</div>

<!-- Examples Sidebar -->
<div id="examples-sidebar">
  <h3>Examples</h3>
  <button class="example-btn" id="example-cubic">Cubic fit (noisy data)</button>
  <button class="example-btn" id="example-xlogx">f(x) = log(x) sin(2x) on [0.5, 5] (degree 5)</button>
  <button class="example-btn" id="example-sin">f(x) = sin(x) on [0, 2π] (degree 7)</button>
</div>

<!-- About Section -->
<div id="about-section">
  <h3>About This Tool</h3>
  <p class="text-sm text-gray-700 leading-relaxed mb-4">
    This interactive calculator computes the least-squares polynomial approximation of user-specified degree (up to 50) for either discrete data points or continuous functions over an interval $[a,b]$.
  </p>
  <div class="text-sm text-gray-700 leading-relaxed space-y-3">
    <p><strong>Discrete points</strong> (including uploaded CSV/TXT/XLSX/ODS files):</p>
    <ul>
      <li>Constructs the Vandermonde matrix $V$.</li>
      <li>Uses stable <strong>Householder QR decomposition</strong> to solve the overdetermined system $Vp = y$ (no normal equations).</li>
      <li>Numerically robust even for high degrees or poorly spaced points.</li>
    </ul>

    <p><strong>Continuous functions</strong> $f(x)$ on $[a,b]$:</p>
    <ul>
      <li>Finds the orthogonal projection of $f$ onto the space of polynomials of degree $\leq n$ with respect to the unweighted $L^2([a,b])$ inner product.</li>
      <li>Employs <strong>Legendre polynomials</strong> $P_k(x)$ (Jacobi polynomials with $\alpha=\beta=0$) as an orthogonal basis.</li>
      <li>Coefficients computed directly via high-order <strong>composite Gauss–Legendre quadrature</strong> (no matrix formation or normal equations).</li>
      <li>Legendre coefficients converted to monomial basis for display and evaluation.</li>
      <li>Extremely stable for high degrees (up to 50) and arbitrary intervals.</li>
    </ul>

    <p class="mt-4"><strong>Features</strong>:</p>
    <ul>
      <li>Interactive D3 visualization with data points, fitted polynomial, and original function.</li>
      <li>Relative and absolute $\|f-p\|_{L^2}$, $\|f-p\|_{L^1}$, $\|f-p\|_{L^\infty}$ error norms (for continuous case).</li>
      <li>Polynomial evaluation at arbitrary points.</li>
      <li>PNG plot download.</li>
      <li>Export fitted polynomial in LaTeX, Python, NumPy, or MATLAB format.</li>
      <li>All methods avoid ill-conditioned normal equations for maximum numerical stability.</li>
    </ul>
  </div>
</div>

<footer class="text-center py-4 border-t mt-8 text-gray-600 text-sm">
  &copy; 2025 Shelvean Kapita: kapita@tamu.edu<br>
  All code released under the <a href="https://opensource.org/licenses/MIT" class="text-blue-600 hover:underline">MIT License</a>.<br>
  Last modified: December 25, 2025
</footer>

<script>
let selectedNodeType = 'equispaced';
document.querySelectorAll('input[name="input_type"]').forEach(r => r.addEventListener('change', updateInputMode));
updateInputMode();
function updateInputMode() {
  const mode = document.querySelector('input[name="input_type"]:checked').value;
  document.getElementById('input-discrete').style.display = mode === 'discrete' ? 'block' : 'none';
  document.getElementById('input-function').style.display = mode === 'function' ? 'block' : 'none';
  document.getElementById('input-file').style.display = mode === 'file' ? 'block' : 'none';
}
document.getElementById('example-cubic').onclick = function() {
  document.querySelector('input[value="discrete"]').checked = true;
  updateInputMode();
  document.getElementById('x_values').value = '-2, -1.75, -1.5, -1.25, -1, -0.75, -0.5, -0.25, 0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 2.25, 2.5, 2.75, 3';
  document.getElementById('y_values').value = '-35.76, -28.25, -18.88, -10.79, -10.59, -7.12, -0.05, -0.30, -2.17, 1.20, -0.66, -0.01, 2.60, -1.56, 0.69, 6.13, 8.47, 16.38, 19.23, 25.38, 41.66';
  document.getElementById('degree').value = '3';
};
document.getElementById('example-xlogx').onclick = function() {
  document.querySelector('input[value="function"]').checked = true;
  updateInputMode();
  document.getElementById('func').value = 'log(x)*sin(2*x)';
  document.getElementById('a').value = '0.5';
  document.getElementById('b').value = '5';
  document.getElementById('degree').value = '5';
};
document.getElementById('example-sin').onclick = function() {
  document.querySelector('input[value="function"]').checked = true;
  updateInputMode();
  document.getElementById('func').value = 'sin(x)';
  document.getElementById('a').value = '0';
  document.getElementById('b').value = '2*pi';
  document.getElementById('degree').value = '7';
};
let fileTable = null;
document.getElementById('fileUpload').addEventListener('change', evt=>{
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    if (/csv|txt/.test(file.name)) {
      fileTable = Papa.parse(ev.target.result).data;
    } else {
      let wb = XLSX.read(ev.target.result, {type:'binary'});
      let ws = wb.Sheets[wb.SheetNames[0]];
      fileTable = XLSX.utils.sheet_to_json(ws, {header:1});
    }
    let cols = fileTable[0].map((h,j)=>"Col "+(j+1));
    let xcol = document.getElementById('xcol'), ycol = document.getElementById('ycol');
    xcol.innerHTML = ""; ycol.innerHTML = "";
    cols.forEach((v,i)=>{
      let o=document.createElement('option'); o.value=i; o.textContent=v; xcol.appendChild(o);
      let o2=document.createElement('option'); o2.value=i; o2.textContent=v; ycol.appendChild(o2);
    });
    document.getElementById('colpick').style.display = 'block';
  }
  reader.readAsBinaryString(file);
});
document.getElementById('loadcols').onclick = function(){
  let xi = +document.getElementById('xcol').value;
  let yi = +document.getElementById('ycol').value;
  let xs = [], ys = [];
  for (let i=1; i<fileTable.length; ++i) {
    let xv = fileTable[i][xi], yv = fileTable[i][yi];
    if (xv !== undefined && yv !== undefined && xv!=='' && yv!=='') {
      xs.push(xv); ys.push(yv);
    }
  }
  document.getElementById('x_values').value = xs.join(",");
  document.getElementById('y_values').value = ys.join(",");
  document.getElementById('colpick').style.display = 'none';
  document.querySelector('input[value=discrete]').checked = true;
  updateInputMode();
};
function gcd(a, b) {a=Math.abs(a);b=Math.abs(b);while(b){let t=b;b=a%b;a=t;}return a;}
function toFraction(num, tol=1e-10) {
  if (isNaN(num)) return '\\text{NaN}';
  if (!isFinite(num)) return num > 0 ? '\\infty' : '-\\infty';
  if (Math.abs(num) < 1e-13) return '0';
  const pi = Math.PI;
  const piTests = [pi, pi/2, pi/3, pi/4, pi/6].map((v,i)=>[v, ['\\pi','\\frac{\\pi}{2}','\\frac{\\pi}{3}','\\frac{\\pi}{4}','\\frac{\\pi}{6}'][i]]);
  for (let [v,s] of piTests) {
    if (Math.abs(num-v)<tol) return s;
    if (Math.abs(num+v)<tol) return '-'+s;
  }
  if (Math.abs(num) < 1e-3 && Math.abs(num)>=1e-13) {
    let sign = num<0 ? '-' : '';
    let absNum = Math.abs(num);
    let exp = Math.floor(Math.log10(absNum));
    let c = (absNum / Math.pow(10,exp)).toFixed(2);
    return `${sign}${c}\\cdot 10^{${exp}}`;
  }
  let sign = num<0?'-':'';
  num=Math.abs(num);
  let h1=1,h2=0,k1=0,k2=1,b=num;
  for (let i=0; i<30;++i) {
    let a=Math.floor(b),h=a*h1+h2,k=a*k1+k2;
    if (Math.abs(num-h/k)<tol) {
      let g=gcd(h,k);h/=g;k/=g;
      if (k>50) break;
      return sign+(k==1?h:`\\dfrac{${h}}{${k}}`);
    }
    h2=h1;h1=h;k2=k1;k1=k;
    b=1/(b-a);
  }
  return sign+parseFloat(num).toFixed(6).replace(/\.?0+$/,'');
}
// Gauss-Legendre quadrature nodes and weights (n=7)
const GL7 = {
  nodes: [-0.9491079123427585,-0.7415311855993944,-0.4058451513773972,0,0.4058451513773972,0.7415311855993944,0.9491079123427585],
  weights: [0.1294849661688697,0.2797053914892767,0.3818300505051188,0.4179591836734694,0.3818300505051188,0.2797053914892767,0.1294849661688697]
};
function composite_gauss7(f, a, b, deg = 0) {
  const basePanels = 30;
  const extraPanels = deg * 10;
  const nPanels = Math.max(basePanels, Math.ceil((basePanels + extraPanels) * Math.abs(b - a)));
  const nodes = GL7.nodes, weights = GL7.weights;
  let res = 0;
  for (let p = 0; p < nPanels; ++p) {
    let x0 = a + (b - a) * p / nPanels, x1 = a + (b - a) * (p + 1) / nPanels;
    let mid = (x0 + x1) / 2, halflen = (x1 - x0) / 2;
    for (let i = 0; i < 7; ++i) {
      res += weights[i] * f(mid + halflen * nodes[i]) * halflen;
    }
  }
  return res;
}
function legendreP(n, x) {
  if (n === 0) return 1;
  if (n === 1) return x;
  let p0 = 1;
  let p1 = x;
  for (let k = 2; k <= n; k++) {
    let pk = ((2 * k - 1) * x * p1 - (k - 1) * p0) / k;
    p0 = p1;
    p1 = pk;
  }
  return p1;
}
// Fixed: Compute Legendre coefficients for function on [a,b]
function lsfit_continuous_legendre(func, a, b, deg) {
  const n = deg + 1;
  const len = (b - a) / 2;
  const shift = (a + b) / 2;
  
  // Legendre polynomials are orthogonal on [-1,1] with weight 1
  // The inner product on [a,b] is ∫_a^b f(x)g(x)dx = (len) ∫_{-1}^1 f(shift + len*t) g(shift + len*t) dt
  
  let coeffs = Array(n).fill(0);
  for (let k = 0; k < n; k++) {
    // Compute c_k = (2k+1)/(2*len) * ∫_a^b f(x)*P_k((2x-(a+b))/(b-a)) dx
    // But actually simpler: c_k = (2k+1)/(2) * ∫_{-1}^1 f(shift + len*t) P_k(t) dt
    const integral = composite_gauss7(t => {
      const x = shift + len * t;
      return func(x) * legendreP(k, t);
    }, -1, 1, deg);
    
    coeffs[k] = (2 * k + 1) / 2 * integral;
  }
  return coeffs;
}
// Fixed: Convert Legendre coefficients to monomial coefficients on [a,b]
function legendreToMonomial(legendreCoeffs, a, b) {
  const n = legendreCoeffs.length;
  const len = (b - a) / 2;
  const shift = (a + b) / 2;
  
  // Build matrix for transformation from monomial basis to Legendre basis
  // We need to solve for monomial coefficients c such that:
  // Σ_{j=0}^{n-1} c_j * x^j = Σ_{k=0}^{n-1} d_k * P_k((2x-(a+b))/(b-a))
  
  // Create sample points (Chebyshev nodes for stability)
  const m = Math.max(2 * n, 50);
  const xs = Array.from({length: m}, (_, i) => {
    const theta = Math.PI * (i + 0.5) / m;
    return shift + len * Math.cos(theta); // Chebyshev nodes on [a,b]
  });
  
  // Evaluate Legendre polynomial at these points
  const fVals = xs.map(x => {
    const t = (2 * x - (a + b)) / (b - a);
    return legendreCoeffs.reduce((sum, dk, k) => sum + dk * legendreP(k, t), 0);
  });
  
  // Build Vandermonde matrix for monomials
  const V = xs.map(x => {
    const row = [];
    let power = 1;
    for (let j = 0; j < n; j++) {
      row.push(power);
      power *= x;
    }
    return row;
  });
  
  // Solve V * c = fVals using QR decomposition
  const { thinQ, thinR, rank } = householderQR(V);
  const QT = transpose(thinQ);
  const c_full = QT.map(row => dot(row, fVals));
  const c = c_full.slice(0, rank);
  const monoCoeffs = backSubstitution(thinR, c);
  
  // Pad with zeros if necessary
  const result = Array(n).fill(0);
  for (let i = 0; i < Math.min(rank, n); i++) {
    result[i] = monoCoeffs[i];
  }
  
  return result;
}
function transpose(M) {
  return M[0].map((_, i) => M.map(row => row[i]));
}
function dot(u, v) {
  return u.reduce((s, val, i) => s + val * v[i], 0);
}
function norm2(v) {
  return Math.sqrt(dot(v, v));
}
function householderQR(A) {
  const m = A.length, n = A[0].length;
  let R = A.map(row => row.slice());
  let Q = Array.from({length: m}, (_, i) => {
    const row = Array(m).fill(0); row[i] = 1; return row;
  });
  for (let k = 0; k < n; k++) {
    let x = R.slice(k).map(row => row[k]);
    let normx = norm2(x);
    if (normx < 1e-14) continue;
    let sign = x[0] >= 0 ? 1 : -1;
    x[0] += sign * normx;
    let vnorm = norm2(x);
    if (vnorm < 1e-14) continue;
    x = x.map(xi => xi / vnorm);
    for (let j = k; j < n; j++) {
      let sigma = dot(x, R.slice(k).map(row => row[j]));
      for (let i = 0; i < x.length; i++) {
        R[k + i][j] -= 2 * x[i] * sigma;
      }
    }
    for (let i = 0; i < m; i++) {
      let sigma = dot(x, Q[i].slice(k));
      for (let j = 0; j < x.length; j++) {
        Q[i][k + j] -= 2 * x[j] * sigma;
      }
    }
  }
  let rank = 0;
  for (let i = 0; i < Math.min(m, n); i++) {
    if (Math.abs(R[i][i]) > 1e-12) rank++;
  }
  const thinQ = Q.map(row => row.slice(0, rank));
  const thinR = R.slice(0, rank).map(row => row.slice(0, rank));
  return { thinQ, thinR, rank };
}
function backSubstitution(R, c) {
  const n = R.length;
  const x = Array(n).fill(0);
  for (let i = n - 1; i >= 0; i--) {
    let sum = 0;
    for (let j = i + 1; j < n; j++) sum += R[i][j] * x[j];
    x[i] = (c[i] - sum) / R[i][i];
  }
  return x;
}
function lsfit_discrete_QR(x, y, deg) {
  const m = x.length;
  const n = deg + 1;
  if (m < n) throw "Need at least deg+1 points";
  const A = Array.from({length: m}, (_, i) => Array.from({length: n}, (_, j) => Math.pow(x[i], j)));
  const { thinQ, thinR, rank } = householderQR(A);
  const QT = transpose(thinQ);
  const c_full = QT.map(row => dot(row, y));
  const c = c_full.slice(0, rank);
  if (rank < n) {
    const x = Array(n).fill(0);
    const x_reduced = backSubstitution(thinR, c);
    for (let i = 0; i < rank; i++) x[i] = x_reduced[i];
    return x;
  } else {
    return backSubstitution(thinR, c);
  }
}
function evalLegendre(coeffs, a, b, x) {
  const t = (2 * x - (a + b)) / (b - a);
  return coeffs.reduce((s, c, k) => s + c * legendreP(k, t), 0);
}
function l2_norm_error(f, p, a, b, deg) {
  return Math.sqrt(composite_gauss7(x => { 
    const fx = f(x), px = p(x); 
    return (fx - px) * (fx - px); 
  }, a, b, deg));
}
function l1_norm_error(f, p, a, b, deg) {
  return composite_gauss7(x => Math.abs(f(x) - p(x)), a, b, deg);
}
function l_inf_error(f, p, a, b, samples = 2000) {
  let maxErr = 0;
  for (let i = 0; i <= samples; ++i) {
    let x = a + (b - a) * i / samples;
    let err = Math.abs(f(x) - p(x));
    if (err > maxErr) maxErr = err;
  }
  return maxErr;
}
function l2_norm_f(f, a, b, deg) {
  return Math.sqrt(composite_gauss7(x => { 
    const fx = f(x); 
    return fx * fx; 
  }, a, b, deg));
}
function polyToLatex(coef) {
  let s="p(x) = ";
  let d=coef.length-1, first=true;
  for(let i=d;i>=0;--i){
    if (Math.abs(coef[i])<1e-12) continue;
    let c=toFraction(coef[i]);
    let sign = first? (c[0]=='-'?'-':'') : (c[0]=='-'?'-':'+');
    c=c.replace(/^\-/,'');
    let part = '';
    if (c=='1'&&i>0) part = '';
    else if (c=='0') continue;
    else part = c;
    if (i>1) s+=`${sign}${part}x^{${i}} `;
    else if(i==1) s+=`${sign}${part}x `;
    else s+= `${sign}${part} `;
    first=false;
  }
  if(first) s+='0';
  s=s.replace(/\+\-/g,'-');
  return s;
}
// New function: Format polynomial as Python function
function polyToPython(coef) {
  let d = coef.length - 1;
  let lines = [];
  lines.push("def p(x):");
  lines.push("    \"\"\"Fitted polynomial of degree " + d + "\"\"\"");
  
  // Build the polynomial expression
  let terms = [];
  for (let i = d; i >= 0; i--) {
    if (Math.abs(coef[i]) < 1e-12) continue;
    
    let coeffStr;
    if (Math.abs(coef[i] - Math.round(coef[i])) < 1e-10) {
      coeffStr = Math.round(coef[i]).toString();
    } else {
      coeffStr = coef[i].toFixed(12).replace(/\.?0+$/, '');
      // Ensure it's a float
      if (!coeffStr.includes('.')) coeffStr += '.0';
    }
    
    if (i === 0) {
      terms.push(coeffStr);
    } else if (i === 1) {
      terms.push(coeffStr + " * x");
    } else {
      terms.push(coeffStr + " * x**" + i);
    }
  }
  
  if (terms.length === 0) {
    lines.push("    return 0.0");
  } else if (terms.length === 1) {
    lines.push("    return " + terms[0]);
  } else {
    // Join terms with line continuation for readability
    let expr = "    return (";
    for (let i = 0; i < terms.length; i++) {
      if (i > 0) expr += " +\n        ";
      expr += terms[i];
    }
    expr += ")";
    lines.push(expr);
  }
  
  lines.push("");
  lines.push("# Usage example:");
  lines.push("# x_values = [0, 1, 2, 3]");
  lines.push("# y_values = [p(x) for x in x_values]");
  
  return lines.join('\n');
}
// New function: Format polynomial as NumPy polynomial
function polyToNumPy(coef) {
  let d = coef.length - 1;
  let lines = [];
  lines.push("import numpy as np");
  lines.push("");
  lines.push("# Coefficients in descending order (highest degree first)");
  
  // Format coefficients for NumPy
  let coeffList = [];
  for (let i = d; i >= 0; i--) {
    if (Math.abs(coef[i]) < 1e-12) {
      coeffList.push("0.0");
    } else {
      let val = coef[i];
      if (Math.abs(val - Math.round(val)) < 1e-10) {
        coeffList.push(Math.round(val).toString() + ".0");
      } else {
        coeffList.push(val.toFixed(12).replace(/\.?0+$/, ''));
      }
    }
  }
  
  lines.push("coefficients = np.array([" + coeffList.join(", ") + "])");
  lines.push("");
  lines.push("# Create polynomial function");
  lines.push("p = np.poly1d(coefficients)");
  lines.push("");
  lines.push("# Usage examples:");
  lines.push("# Evaluate at single point: p(2.5)");
  lines.push("# Evaluate at multiple points: p([0, 1, 2, 3])");
  lines.push("# Get derivative: p.deriv()");
  lines.push("# Get integral: p.integ()");
  
  return lines.join('\n');
}
// New function: Format polynomial as MATLAB polynomial
function polyToMATLAB(coef) {
  let d = coef.length - 1;
  let lines = [];
  lines.push("% Fitted polynomial of degree " + d);
  lines.push("% Coefficients in descending order (MATLAB convention)");
  
  // Format coefficients for MATLAB
  let coeffList = [];
  for (let i = d; i >= 0; i--) {
    if (Math.abs(coef[i]) < 1e-12) {
      coeffList.push("0");
    } else {
      let val = coef[i];
      if (Math.abs(val - Math.round(val)) < 1e-10) {
        coeffList.push(num2str(val));
      } else {
        coeffList.push(num2str(val));
      }
    }
  }
  
  lines.push("coeffs = [" + coeffList.join(", ") + "];");
  lines.push("");
  lines.push("% Create polynomial function");
  lines.push("p = @(x) polyval(coeffs, x);");
  lines.push("");
  lines.push("% Usage examples:");
  lines.push("% Evaluate at single point: p(2.5)");
  lines.push("% Evaluate at multiple points: p([0, 1, 2, 3])");
  lines.push("% Get derivative: polyder(coeffs)");
  lines.push("% Get roots: roots(coeffs)");
  
  return lines.join('\n');
}
// Helper function for MATLAB formatting
function num2str(num) {
  if (Math.abs(num) < 1e-12) return "0";
  if (Math.abs(num) > 1e6 || Math.abs(num) < 1e-6) {
    return num.toExponential(6).replace('e', 'e');
  }
  // Remove trailing zeros
  let str = num.toFixed(12).replace(/\.?0+$/, '');
  if (!str.includes('.') && !str.includes('e')) str += '.0';
  return str;
}
// Function to update polynomial output based on selected format
function updatePolyOutput(coef, format) {
  const outputElem = document.getElementById('poly-output');
  let output = '';
  
  switch(format) {
    case 'latex':
      output = polyToLatex(coef);
      break;
    case 'python':
      output = polyToPython(coef);
      break;
    case 'numpy':
      output = polyToNumPy(coef);
      break;
    case 'matlab':
      output = polyToMATLAB(coef);
      break;
    default:
      output = polyToLatex(coef);
  }
  
  outputElem.textContent = output;
  
  // If it's LaTeX, render it with KaTeX
  if (format === 'latex') {
    outputElem.innerHTML = '';
    katex.render(output, outputElem, {throwOnError: false, displayMode: true});
  }
}
let coeffs = null, monoCoeffs = null, origPtsX=null, origPtsY=null, fitShowX=null, fitShowY=null, origFuncEval=null, lastInputMode=null;
let fun = null, intervalA = null, intervalB = null;
let l2error = null, l1error = null, linferror = null, l2normf = null;
document.getElementById('compute').onclick = function(){
  document.getElementById('result').innerHTML = '';
  document.getElementById('plot').innerHTML = '';
  document.getElementById('legend-bar').innerHTML='';
  document.getElementById('evaldiv').style.display = "none";
  document.getElementById('error-container').innerHTML = '';
  document.getElementById('copy-section').style.display = 'none';
  coeffs = null; monoCoeffs = null; origPtsX = null; origPtsY = null; fitShowX=null; fitShowY=null; origFuncEval=null; l2error = null; l1error = null; linferror = null; l2normf = null; fun = null; intervalA = null; intervalB = null;
  let deg = parseInt(document.getElementById('degree').value);
  if (isNaN(deg) || deg < 0 || deg > 50) {
    document.getElementById('result').innerHTML = '<div class="text-red-500">Degree must be between 0 and 50.</div>';
    return;
  }
  let mode = document.querySelector('input[name="input_type"]:checked').value;
  lastInputMode = mode;
  try {
    if (mode=="discrete" || mode=="file") {
      let x = document.getElementById('x_values').value.split(',').map(e=>math.evaluate(e.trim()));
      let y = document.getElementById('y_values').value.split(',').map(e=>math.evaluate(e.trim()));
      if (!(x.length==y.length && x.length>=deg+1)) throw "Number of points must be >= degree+1 and match.";
      monoCoeffs = lsfit_discrete_QR(x, y, deg);
      coeffs = monoCoeffs; // For discrete case, coeffs are already monomial
      origPtsX = x.slice(); origPtsY = y.slice();
      let minx = Math.min(...x), maxx = Math.max(...x);
      fitShowX = [], fitShowY = [];
      for(let i=0;i<=200;++i) {
        let xx = minx + (maxx-minx)*i/200;
        fitShowX.push(xx);
        fitShowY.push(monoCoeffs.reduce((s,c,j)=>s+c*Math.pow(xx,j),0));
      }
    } else if (mode=="function") {
      let funstr = document.getElementById('func').value.trim();
      fun = x=>math.evaluate(funstr, {x});
      intervalA = math.evaluate(document.getElementById('a').value.trim());
      intervalB = math.evaluate(document.getElementById('b').value.trim());
      if (intervalA >= intervalB) throw "a must be < b";
      
      // Step 1: Compute Legendre coefficients
      coeffs = lsfit_continuous_legendre(fun, intervalA, intervalB, deg);
      
      // Step 2: Convert to monomial basis
      monoCoeffs = legendreToMonomial(coeffs, intervalA, intervalB);
      
      // Step 3: Prepare for plotting
      let xs = []; 
      for(let i=0;i<50;++i) xs.push(intervalA + (intervalB-intervalA)*i/(49));
      origPtsX = xs.slice(); 
      origPtsY = xs.map(xx=>fun(xx));
      
      fitShowX=[]; fitShowY=[]; origFuncEval=[];
      for(let i=0;i<=250;++i) {
        let xx = intervalA + (intervalB-intervalA)*i/250;
        fitShowX.push(xx);
        // Evaluate using monomial coefficients
        fitShowY.push(monoCoeffs.reduce((s,c,j)=>s+c*Math.pow(xx,j),0));
        origFuncEval.push(fun(xx));
      }
      
      // Step 4: Compute errors
      let pfun = x => monoCoeffs.reduce((s,c,j)=>s+c*Math.pow(x,j),0);
      l2error = l2_norm_error(fun, pfun, intervalA, intervalB, deg);
      l1error = l1_norm_error(fun, pfun, intervalA, intervalB, deg);
      linferror = l_inf_error(fun, pfun, intervalA, intervalB, 2000);
      l2normf = l2_norm_f(fun, intervalA, intervalB, deg);
    }
  } catch(e) {
    document.getElementById('result').innerHTML = '<div class="text-red-500">Input error: ' + e + '</div>';
    console.error(e); // For debugging
    return;
  }
  let out = `<div class="mb-2 font-bold text-gray-700">Fitted Least Squares Polynomial (degree ${deg}):</div> <div id="poly-latex"></div>`;
  document.getElementById('result').innerHTML = out;
  setTimeout(()=>katex.render(polyToLatex(monoCoeffs), document.getElementById('poly-latex'), {throwOnError:false, displayMode:true}),50);
  
  // Show copy section and update output
  document.getElementById('copy-section').style.display = 'block';
  updatePolyOutput(monoCoeffs, 'latex');
  
  let legbar = `<span class="legitem"><span class="legicon-poly"></span>Fitted poly</span>`;
  if (origFuncEval) legbar += `<span class="legitem"><span class="legicon-fun"></span>Function</span>`;
  if (mode !== "function") legbar += `<span class="legitem"><span class="legicon-pts"></span>Data pts</span>`;
  document.getElementById('legend-bar').innerHTML = legbar;
  let allx = fitShowX.concat((mode!=="function" && origPtsX)?origPtsX:[]), ally = fitShowY.concat((mode!=="function"&&origPtsY)?origPtsY:[]);
  let minx = Math.min(...allx), maxx = Math.max(...allx);
  let miny = Math.min(...ally), maxy = Math.max(...ally);
  if (origFuncEval) {
    miny = Math.min(miny, ...origFuncEval);
    maxy = Math.max(maxy, ...origFuncEval);
  }
  let ypad = 0.05*(maxy-miny); if (ypad==0) ypad=0.1;
  let width = 400, height = 300, m={l:40,r:10,t:10,b:40};
  let svg = d3.select("#plot").html('').append("svg")
    .attr("width",width+m.l+m.r).attr("height",height+m.t+m.b)
    .append("g").attr("transform",`translate(${m.l},${m.t})`);
  let xScale = d3.scaleLinear().domain([minx, maxx]).range([0, width]);
  let yScale = d3.scaleLinear().domain([miny-ypad,maxy+ypad]).range([height, 0]);
  svg.append("g").attr("transform",`translate(0,${height})`).call(d3.axisBottom(xScale));
  svg.append("g").call(d3.axisLeft(yScale));
  svg.append('g').attr('class','grid').attr('transform', `translate(0,${height})`)
    .call(d3.axisBottom(xScale).tickSize(-height).tickFormat(''));
  svg.append('g').attr('class','grid')
    .call(d3.axisLeft(yScale).tickSize(-width).tickFormat(''));
  svg.append("path")
    .datum(fitShowX.map((v,i)=>[v, fitShowY[i]]))
    .attr("fill","none").attr("stroke","blue").attr("stroke-width",2)
    .attr("d", d3.line().x(d=>xScale(d[0])).y(d=>yScale(d[1])));
  if (mode!=="function") {
    svg.selectAll('circle.data')
      .data(origPtsX)
      .enter()
      .append('circle')
      .attr('cx',d=>xScale(d))
      .attr('cy',(d,i)=>yScale(origPtsY[i]))
      .attr('r',5)
      .attr('fill','red')
      .attr('stroke','#111');
  }
  if (origFuncEval) {
    svg.append("path")
      .datum(fitShowX.map((v,i)=>[v, origFuncEval[i]]))
      .attr("fill","none").attr("stroke","#db2114").attr("stroke-width",2)
      .attr("d",d3.line().x(d=>xScale(d[0])).y(d=>yScale(d[1])));
  }
  document.getElementById('download-btn').style.display = "";
  document.getElementById('download-btn').onclick = function(){
    let svgElem = document.querySelector('#plot svg');
    let src = (new XMLSerializer()).serializeToString(svgElem);
    let image = new Image();
    let canvas = document.createElement('canvas');
    canvas.width = svgElem.width.baseVal.value;
    canvas.height = svgElem.height.baseVal.value;
    image.onload = function() {
      let ctx = canvas.getContext('2d');
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(image, 0, 0);
      let a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'fitplot.png';
      a.click();
    };
    image.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(src)));
  };
  document.getElementById('evaldiv').style.display = '';
  if (mode === "function" && l2normf > 0) {
    let rel_l2 = l2error / l2normf;
    let tableHTML = `
      <table id="error-table" class="latex-eval">
        <tr>
          <th><span class="header-latex" data-latex="\\dfrac{\\|f-p\\|_{L^2([a,b])}}{\\|f\\|_{L^2([a,b])}}"></span></th>
          <th><span class="header-latex" data-latex="\\|f-p\\|_{L^2([a,b])}"></span></th>
          <th><span class="header-latex" data-latex="\\|f-p\\|_{L^1([a,b])}"></span></th>
          <th><span class="header-latex" data-latex="\\|f-p\\|_{L^\\infty([a,b])}"></span></th>
        </tr>
        <tr>
          <td id="rel-l2-latex"></td>
          <td id="l2-latex"></td>
          <td id="l1-latex"></td>
          <td id="linf-latex"></td>
        </tr>
      </table>`;
    document.getElementById('error-container').innerHTML = tableHTML;
    setTimeout(() => {
      document.querySelectorAll('.header-latex').forEach(el => {
        katex.render(el.dataset.latex, el, {throwOnError: false, displayMode: false});
      });
      katex.render(toFraction(rel_l2), document.getElementById('rel-l2-latex'), {throwOnError:false});
      katex.render(toFraction(l2error), document.getElementById('l2-latex'), {throwOnError:false});
      katex.render(toFraction(l1error), document.getElementById('l1-latex'), {throwOnError:false});
      katex.render(toFraction(linferror), document.getElementById('linf-latex'), {throwOnError:false});
    }, 100);
  }
};
// Event listener for format selection change
document.getElementById('format-select').addEventListener('change', function() {
  if (monoCoeffs) {
    updatePolyOutput(monoCoeffs, this.value);
  }
});
// Copy to clipboard functionality
document.getElementById('copy-btn').addEventListener('click', function() {
  const outputElem = document.getElementById('poly-output');
  const format = document.getElementById('format-select').value;
  
  let textToCopy;
  if (format === 'latex') {
    // For LaTeX, get the actual LaTeX string, not the rendered HTML
    textToCopy = polyToLatex(monoCoeffs);
  } else {
    // For other formats, get the text content
    textToCopy = outputElem.textContent;
  }
  
  // Use the Clipboard API
  navigator.clipboard.writeText(textToCopy).then(() => {
    // Visual feedback
    const btn = document.getElementById('copy-btn');
    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    
    setTimeout(() => {
      btn.textContent = originalText;
      btn.classList.remove('copied');
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy: ', err);
    alert('Failed to copy to clipboard. Please select the text and copy manually.');
  });
});
document.getElementById('clear').onclick=() => {
  document.getElementById('x_values').value='';
  document.getElementById('y_values').value='';
  document.getElementById('func').value='sin(x)';
  document.getElementById('a').value='0';
  document.getElementById('b').value='6.28';
  document.getElementById('degree').value='3';
  document.getElementById('result').innerHTML='';
  document.getElementById('plot').innerHTML='';
  document.getElementById('evaldiv').style.display="none";
  document.getElementById('legend-bar').innerHTML='';
  document.getElementById('eval-output').innerHTML='';
  document.getElementById('error-container').innerHTML='';
  document.getElementById('copy-section').style.display = 'none';
  document.getElementById('fileUpload').value = '';
  let colpick = document.getElementById('colpick');
  if (colpick) colpick.style.display = 'none';
};
document.getElementById('eval-btn').onclick=function(){
  if (!monoCoeffs) {
    document.getElementById('eval-output').innerHTML='<div class="text-red-500">Fit a polynomial first.</div>';
    return;
  }
  let xs = document.getElementById('eval_x').value.split(',').map(s=>{try{return math.evaluate(s.trim());}catch(e){return NaN;}});
  let ys = xs.map(xi => monoCoeffs.reduce((s,c,i)=>s+c*Math.pow(xi,i),0));
  let relerr=null;
  if (lastInputMode === "function") {
    try {
      let funstr = document.getElementById('func').value.trim();
      let f = x => math.evaluate(funstr, {x});
      relerr = xs.map((x,i) => {
        let fx = f(x);
        return fx !== 0 ? Math.abs((fx - ys[i]) / fx) : (ys[i] === 0 ? 0 : Infinity);
      });
    } catch {}
  }
  let tbl = `<table class="latex-eval mt-2"><tr><th class="th-x"></th><th class="th-px"></th>`;
  if (relerr) tbl += '<th class="th-err"></th>';
  tbl += '</tr>';
  for(let i=0;i<xs.length;++i){
    tbl += `<tr><td class="xcell"></td><td class="pxcell"></td>`;
    if (relerr) tbl += `<td class="errcell"></td>`;
    tbl += '</tr>';
  }
  tbl += '</table>';
  document.getElementById('eval-output').innerHTML = tbl;
  const ths = document.querySelectorAll('.latex-eval th');
  katex.render("x", ths[0], {throwOnError:false});
  katex.render("p(x)", ths[1], {throwOnError:false});
  if (relerr) katex.render("\\left|\\frac{f(x)-p(x)}{f(x)}\\right|", ths[2], {throwOnError:false});
  let tr = document.querySelectorAll("#eval-output tr");
  for (let i=1;i<tr.length;++i) {
    let tds = tr[i].querySelectorAll("td");
    katex.render(toFraction(xs[i-1]), tds[0], {throwOnError:false});
    katex.render(toFraction(ys[i-1]), tds[1], {throwOnError:false});
    if (relerr) {
      let val = relerr[i-1];
      let display = isFinite(val) ? toFraction(val) : (val === Infinity ? '\\infty' : '\\text{NaN}');
      katex.render(display, tds[2], {throwOnError:false});
    }
  }
};
window.onload = ()=>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false}]});
</script>
</body>
</html>
