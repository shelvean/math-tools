
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="description" content="Linear Equation Solver">
    <meta name="keywords" content="Linear Equations, Matrix Solver, System of Equations, Gauss-Jordan, Ax=b, Compute Matrix Solution online, Solve Linear System online, Solve Matrix equation">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LEQE004C92"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-LEQE004C92');
    </script>
    <meta charset="UTF-8" />
    <title>Linear Equation Solver</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        .katex-display { margin: 1em 0; overflow-x: auto; }
        #result, #result * { color: #080808; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="nav-container w-full fixed top-0 z-10 bg-white shadow-md">
        <nav class="max-w-4xl mx-auto py-4">
            <ul class="flex justify-center gap-8">
                <li><a href="index.html" class="text-indigo-500 hover:text-blue-600 transition-colors font-bold text-xl">Home</a></li>
                <li><a href="teaching.html" class="text-indigo-500 hover:text-blue-600 transition-colors font-bold text-xl">Teaching</a></li>
                <li><a href="projects.html" class="text-indigo-500 hover:text-blue-600 font-bold text-xl">Diff Eq</a></li>
                <li><a href="linear.html" class="text-indigo-500 hover:text-blue-600 font-bold text-xl">Linear Algebra</a></li>
                <li><a href="numerical.html" class="text-indigo-500 hover:text-blue-600 font-bold text-xl">Numerical Methods</a></li>
            </ul>
        </nav>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md max-w-4xl w-full mt-16">
        <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Linear Equation Solver</h2>
        <p class="text-center text-gray-600 mb-6">Solve systems of linear equations $A\mathbf{x} = \mathbf{b}$ using row reduction with detailed step-by-step output.<br>
        <span class="text-sm">Handles consistent, inconsistent, and underdetermined systems.</span></p>

        <!-- About Linear Systems - Collapsible -->
        <div class="bg-blue-50 border border-blue-300 rounded-lg mb-6 overflow-hidden">
            <button onclick="toggleLinearConcepts()" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition duration-200">
                <h3 class="font-bold text-lg text-blue-800">About Linear Systems</h3>
                <span id="linearToggleIcon" class="text-blue-800 font-bold text-xl">−</span>
            </button>
            <div id="linearContent" class="px-4 pb-4">
                <p class="text-gray-700 mb-2 text-sm">A system of linear equations $A\mathbf{x} = \mathbf{b}$ can be:</p>
                <ul class="text-gray-700 text-sm mb-3 ml-6 list-disc">
                    <li><strong>Consistent with unique solution:</strong> Exactly one solution exists</li>
                    <li><strong>Consistent with infinitely many solutions:</strong> Free variables present (underdetermined)</li>
                    <li><strong>Inconsistent:</strong> No solution exists (contradictory equations)</li>
                </ul>
                <p class="text-gray-700 mb-2 text-sm">This solver uses <strong>Gauss-Jordan elimination</strong> to reduce $[A|\mathbf{b}]$ to RREF and determine the solution set.</p>
            </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg mb-6 flex justify-center items-center space-x-4">
            <span class="text-gray-700">Equations (rows, $m$):</span>
            <input type="number" id="m" min="1" required class="w-16 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="text-gray-700">Variables (columns, $n$):</span>
            <input type="number" id="n" min="1" required class="w-16 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="button" onclick="generateMatrix()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition duration-300">Generate Matrix</button>
            <button type="button" onclick="loadExample()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition duration-300">Load Example</button>
        </div>
        <div id="matrixInput" class="mb-6 overflow-x-auto"></div>
        <div class="flex justify-center mb-6 space-x-6">
            <span class="text-gray-700">Display Values as:</span>
            <label class="flex items-center">
                <input type="radio" name="displayMode" value="decimal" class="mr-2">
                <span>Decimal</span>
            </label>
            <label class="flex items-center">
                <input type="radio" name="displayMode" value="fraction" checked class="mr-2">
                <span>Fraction</span>
            </label>
        </div>
        <div class="flex justify-center space-x-4 mb-6">
            <button id="calcBtn" type="button" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition duration-300 w-1/3">Solve</button>
            <button id="clearBtn" type="button" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 transition duration-300 w-1/3">Clear All</button>
        </div>
        <div id="result" class="mt-6 p-4 bg-gray-50 rounded-lg"></div>
        <div class="mt-6 border-t pt-4 text-center text-gray-500 text-sm">
            © 2025 Shelvean Kapita: kapita@tamu.edu <br>
            Last modified: January 12, 2026 <br>
            Licensed under the <a href="https://opensource.org/licenses/MIT" target="_blank">MIT License</a>.
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ]
            });
        });

        var currentDisplayMode = "fraction";
        document.querySelectorAll('input[name="displayMode"]').forEach(function(radio) {
            radio.addEventListener("change", function () {
                currentDisplayMode = this.value;
            });
        });

        // Fraction class remains unchanged...
        class Fraction {
            constructor(numerator, denominator = 1) {
                if (denominator === 0) throw new Error('Denominator cannot be zero');
                const absNum = Math.abs(numerator);
                const absDen = Math.abs(denominator);
                const gcd = this.gcd(absNum, absDen);
                this.numerator = (numerator < 0 ? -absNum : absNum) / gcd * Math.sign(denominator);
                this.denominator = absDen / gcd;
                if (this.denominator < 0) {
                    this.numerator = -this.numerator;
                    this.denominator = -this.denominator;
                }
            }
            gcd(a, b) {
                while (b !== 0) {
                    const t = b;
                    b = a % b;
                    a = t;
                }
                return a;
            }
            add(other) {
                other = Fraction.from(other);
                const commonDen = this.denominator * other.denominator;
                const num1 = this.numerator * other.denominator;
                const num2 = other.numerator * this.denominator;
                return new Fraction(num1 + num2, commonDen);
            }
            subtract(other) {
                other = Fraction.from(other);
                const commonDen = this.denominator * other.denominator;
                const num1 = this.numerator * other.denominator;
                const num2 = other.numerator * this.denominator;
                return new Fraction(num1 - num2, commonDen);
            }
            multiply(other) {
                other = Fraction.from(other);
                return new Fraction(this.numerator * other.numerator, this.denominator * other.denominator);
            }
            divide(other) {
                other = Fraction.from(other);
                if (other.numerator === 0) throw new Error('Division by zero');
                return new Fraction(this.numerator * other.denominator, this.denominator * other.numerator);
            }
            toString() {
                if (this.denominator === 1) return this.numerator.toString();
                return this.numerator + '/' + this.denominator;
            }
            valueOf() {
                return this.numerator / this.denominator;
            }
            static from(value) {
                if (value instanceof Fraction) return value;
                if (typeof value === 'number') return Fraction.fromDecimal(value);
                return new Fraction(value);
            }
            static fromDecimal(decimal, maxDenominator = 1000) {
                if (Number.isInteger(decimal)) return new Fraction(decimal);
                let sign = decimal < 0 ? -1 : 1;
                decimal = Math.abs(decimal);
                let bestNum = 1, bestDen = 1, bestError = Math.abs(decimal - 1);
                for (let den = 1; den <= maxDenominator; den++) {
                    let num = Math.round(decimal * den);
                    let error = Math.abs(decimal - num / den);
                    if (error < bestError) {
                        bestNum = num;
                        bestDen = den;
                        bestError = error;
                    }
                }
                return new Fraction(sign * bestNum, bestDen);
            }
        }

        function generateMatrix() { /* unchanged - keeping original */ 
            var m = parseInt(document.getElementById("m").value, 10);
            var n = parseInt(document.getElementById("n").value, 10);
            if (isNaN(m) || m <= 0 || isNaN(n) || n <= 0) {
                alert("Please enter valid positive integers for m and n.");
                return;
            }
            var matrixDiv = document.getElementById("matrixInput");
            matrixDiv.innerHTML = "";
            var statementDiv = document.createElement("div");
            statementDiv.className = "text-center mb-4";
            var statement = document.createElement("div");
            statement.className = "latex";
            statement.textContent = "$$ \\text{Solve } A \\mathbf{x} = \\mathbf{b} \\text{ for } \\mathbf{x} $$";
            statementDiv.appendChild(statement);
            matrixDiv.appendChild(statementDiv);
            var flexDiv = document.createElement("div");
            flexDiv.className = "flex justify-center space-x-8";
            var aDiv = document.createElement("div");
            var aLabel = document.createElement("p");
            aLabel.className = "text-center font-semibold latex";
            aLabel.textContent = "$A$";
            aDiv.appendChild(aLabel);
            var aTable = document.createElement("table");
            aTable.className = "border-collapse";
            for (var i = 0; i < m; i++) {
                var tr = document.createElement("tr");
                for (var j = 0; j < n; j++) {
                    var td = document.createElement("td");
                    td.className = "p-1";
                    var input = document.createElement("input");
                    input.type = "text";
                    input.className = "matrix-cell w-16 p-2 text-center border-2 border-gray-300 hover:border-blue-500 hover:border-4 rounded-md focus:outline-none";
                    input.id = "cell_" + i + "_" + j;
                    td.appendChild(input);
                    tr.appendChild(td);
                }
                aTable.appendChild(tr);
            }
            aDiv.appendChild(aTable);
            flexDiv.appendChild(aDiv);
            var bDiv = document.createElement("div");
            var bLabel = document.createElement("p");
            bLabel.className = "text-center font-semibold latex";
            bLabel.textContent = "$\\mathbf{b}$";
            bDiv.appendChild(bLabel);
            var bTable = document.createElement("table");
            bTable.className = "border-collapse";
            for (var i = 0; i < m; i++) {
                var tr = document.createElement("tr");
                var td = document.createElement("td");
                td.className = "p-1";
                var input = document.createElement("input");
                input.type = "text";
                input.className = "matrix-cell w-16 p-2 text-center border-2 border-gray-300 hover:border-blue-500 hover:border-4 rounded-md focus:outline-none";
                input.id = "b_" + i;
                td.appendChild(input);
                tr.appendChild(td);
                bTable.appendChild(tr);
            }
            bDiv.appendChild(bTable);
            flexDiv.appendChild(bDiv);
            matrixDiv.appendChild(flexDiv);
            renderMathInElement(matrixDiv, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ]
            });
        }

        function clearAll() {
            document.getElementById("m").value = "";
            document.getElementById("n").value = "";
            document.getElementById("matrixInput").innerHTML = "";
            document.getElementById("result").innerHTML = "";
            document.querySelector('input[value="fraction"]').checked = true;
            currentDisplayMode = "fraction";
        }
        document.getElementById("clearBtn").addEventListener("click", clearAll);

        function parseFraction(str) { /* unchanged */ 
            str = str.trim();
            if (str === "") return new Fraction(0);
            if (str.includes('/')) {
                let parts = str.split('/');
                if (parts.length === 2) {
                    let numerator = parseFloat(parts[0]);
                    let denominator = parseFloat(parts[1]);
                    if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
                        return new Fraction(numerator, denominator);
                    }
                }
            }
            let num = parseFloat(str);
            if (!isNaN(num)) {
                return Fraction.fromDecimal(num);
            }
            alert("Please enter valid integers, decimals, or fractions in all cells.");
            return null;
        }

        function readMatrix() { /* unchanged */ 
            var m = parseInt(document.getElementById("m").value, 10);
            var n = parseInt(document.getElementById("n").value, 10);
            if (isNaN(m) || m <= 0 || isNaN(n) || n <= 0) {
                alert("Please enter valid positive integers for m and n.");
                return null;
            }
            var A = [];
            for (var i = 0; i < m; i++) {
                var row = [];
                for (var j = 0; j < n; j++) {
                    var cell = document.getElementById("cell_" + i + "_" + j);
                    var value = cell.value.trim();
                    var num = parseFraction(value);
                    if (num === null) return null;
                    row.push(num);
                }
                A.push(row);
            }
            var b = [];
            for (var i = 0; i < m; i++) {
                var cell = document.getElementById("b_" + i);
                var value = cell.value.trim();
                var num = parseFraction(value);
                if (num === null) return null;
                b.push(num);
            }
            return { A: A, b: b, m: m, n: n };
        }

        function formatNumber(num) { /* unchanged */ 
            var epsilon = 1e-10;
            if (num instanceof Fraction) {
                if (currentDisplayMode === "decimal") {
                    return parseFloat(num.valueOf().toFixed(3)).toString();
                } else {
                    return num.toString();
                }
            }
            if (Math.abs(num - Math.round(num)) < epsilon) {
                return Math.round(num).toString();
            }
            if (currentDisplayMode === "fraction") {
                return toFraction(num);
            }
            return parseFloat(num.toFixed(3)).toString();
        }

        function formatForLatex(val) {
            var formatted = formatNumber(val);
            if (formatted.includes('/')) {
                let parts = formatted.split('/');
                let numerator = parts[0];
                let sign = '';
                if (numerator.startsWith('-')) {
                    sign = '-';
                    numerator = numerator.slice(1);
                }
                let denominator = parts[1];
                return `${sign}\\frac{${numerator}}{${denominator}}`;
            } else {
                return formatted;
            }
        }

        function cloneMatrix(matrix) { /* unchanged */ 
            return matrix.map(row => row.map(cell => new Fraction(cell.numerator, cell.denominator)));
        }

        function matrixToLatex(matrix, numVars) { /* unchanged */ 
            if (matrix.length === 0 || matrix[0].length === 0) return "";
            var cols = matrix[0].length;
            var colSpec = Array(numVars).fill('c').join('') + '|c';
            var latex = "\\left[ \\begin{array}{" + colSpec + "}\n";
            latex += matrix
                .map(function (row) {
                    return row.map(function(num) {
                        return formatForLatex(num);
                    }).join(" & ");
                })
                .join(" \\\\ \n");
            latex += "\n\\end{array} \\right]";
            return latex;
        }

        function computeRREF(matrix) { /* unchanged - keeping your original */ 
            var m = matrix.length;
            if (m === 0) return { rref: matrix, steps: [] };
            var n = matrix[0].length;
            var lead = 0;
            var steps = [];
            steps.push({ desc: "Initial Augmented Matrix", matrix: cloneMatrix(matrix) });
            for (var r = 0; r < m; r++) {
                if (lead >= n) break;
                var i = r;
                while (Math.abs(matrix[i][lead].valueOf()) < 1e-10) {
                    i++;
                    if (i === m) {
                        i = r;
                        lead++;
                        if (lead === n) break;
                    }
                }
                if (lead === n) break;
                if (i !== r) {
                    var temp = matrix[r];
                    matrix[r] = matrix[i];
                    matrix[i] = temp;
                    steps.push({ desc: `R_{${r + 1}} \\leftrightarrow R_{${i + 1}}`, matrix: cloneMatrix(matrix) });
                }
                var pivotValue = matrix[r][lead];
                if (Math.abs(pivotValue.valueOf()) > 1e-10) {
                    var reciprocal = new Fraction(1).divide(pivotValue);
                    var latexScalar = formatForLatex(reciprocal);
                    for (var j = 0; j < n; j++) {
                        matrix[r][j] = matrix[r][j].multiply(reciprocal);
                    }
                    steps.push({ desc: `${latexScalar} R_{${r + 1}} \\to R_{${r + 1}}`, matrix: cloneMatrix(matrix) });
                }
                for (var i = 0; i < m; i++) {
                    if (i !== r) {
                        var factor = matrix[i][lead];
                        if (Math.abs(factor.valueOf()) > 1e-10) {
                            var isPositive = factor.valueOf() >= 0;
                            var absFactor = isPositive ? factor : factor.multiply(new Fraction(-1));
                            var absLatexFactor = formatForLatex(absFactor);
                            var operationSign = isPositive ? "-" : "+";
                            var msg = `R_{${i + 1}} ${operationSign} ${absLatexFactor} R_{${r + 1}} \\to R_{${i + 1}}`;
                            for (var j = 0; j < n; j++) {
                                matrix[i][j] = matrix[i][j].subtract(factor.multiply(matrix[r][j]));
                            }
                            steps.push({ desc: msg, matrix: cloneMatrix(matrix) });
                        }
                    }
                }
                lead++;
            }
            steps.push({ desc: "Final Reduced Row Echelon Form", matrix: cloneMatrix(matrix) });
            return { rref: matrix, steps: steps };
        }

        function findCommonDenominator(fractions) {
            // Find the least common multiple of all denominators
            let lcm = 1;
            for (const frac of fractions) {
                if (frac instanceof Fraction) {
                    const denom = Math.abs(frac.denominator);
                    lcm = (lcm * denom) / gcd(lcm, denom);
                }
            }
            
            // Check if all numerators are divisible by the LCM
            let allNumeratorsDivisible = true;
            for (const frac of fractions) {
                if (frac instanceof Fraction) {
                    const scaledNum = frac.numerator * (lcm / frac.denominator);
                    if (Math.abs(scaledNum - Math.round(scaledNum)) > 1e-10) {
                        allNumeratorsDivisible = false;
                        break;
                    }
                }
            }
            
            // If all numerators become integers when scaled by LCM, return LCM
            // Otherwise, return 1 (no common factor to factor out)
            return allNumeratorsDivisible ? lcm : 1;
            
            function gcd(a, b) {
                a = Math.abs(a);
                b = Math.abs(b);
                while (b !== 0) {
                    const t = b;
                    b = a % b;
                    a = t;
                }
                return a;
            }
        }

        function extractSolution(rref, n) {
            var m = rref.length;
            var hasNoSolution = false;
            for (var i = 0; i < m; i++) {
                var isZeroRow = true;
                for (var j = 0; j < n; j++) {
                    if (Math.abs(rref[i][j].valueOf()) > 1e-10) {
                        isZeroRow = false;
                        break;
                    }
                }
                if (isZeroRow && Math.abs(rref[i][n].valueOf()) > 1e-10) {
                    hasNoSolution = true;
                    break;
                }
            }
            if (hasNoSolution) {
                return {
                    type: "no_solution",
                    quick: "\\text{No solution}",
                    full: "\\text{The system has no solution because a row in the RREF is of the form } [0 \\cdots 0 | c] \\text{ where } c \\neq 0."
                };
            }

            var pivotColumns = [];
            var pivotRowMap = {};
            var currentCol = 0;
            for (var row = 0; row < m; row++) {
                while (currentCol < n && Math.abs(rref[row][currentCol].valueOf()) < 1e-10) {
                    currentCol++;
                }
                if (currentCol < n && Math.abs(rref[row][currentCol].valueOf() - 1) < 1e-10) {
                    pivotColumns.push(currentCol);
                    pivotRowMap[currentCol] = row;
                    currentCol++;
                }
            }
            var r = pivotColumns.length;

            if (r === n) {
                var x = [];
                for (var j = 0; j < n; j++) {
                    var row = pivotRowMap[j];
                    x.push(rref[row][n]);
                }
                
                // Check if we can factor out a common denominator
                var commonDen = findCommonDenominator(x);
                var latexQuick = "";
                
                if (commonDen > 1) {
                    // Factor out 1/commonDen
                    // Multiply each fraction by commonDen/denominator to get integer numerators
                    var factoredX = x.map(frac => {
                        if (frac instanceof Fraction) {
                            return new Fraction(frac.numerator * (commonDen / frac.denominator), 1);
                        }
                        return new Fraction(frac * commonDen, 1);
                    });
                    
                    latexQuick = "\\mathbf{x} = \\frac{1}{" + commonDen + "}\\begin{bmatrix} " + 
                                factoredX.map(frac => formatForLatex(frac.numerator)).join(" \\\\ ") + 
                                " \\end{bmatrix}";
                } else {
                    latexQuick = "\\mathbf{x} = \\begin{bmatrix} " + x.map(formatForLatex).join(" \\\\ ") + " \\end{bmatrix}";
                }
                
                var latexFull = "\\text{The RREF has a leading 1 in every column of } A\\text{, indicating a unique solution. The values of } \\mathbf{x} \\text{ are read from the last column:} \\\\ " + latexQuick;
                return { type: "unique", quick: latexQuick, full: latexFull };
            } else {
                var freeVars = [];
                for (var j = 0; j < n; j++) {
                    if (!pivotColumns.includes(j)) freeVars.push(j);
                }
                freeVars.sort((a, b) => a - b);

                var greekLetters = ["\\alpha", "\\beta", "\\gamma", "\\delta", "\\epsilon", "\\zeta", "\\eta", "\\theta", "\\iota", "\\kappa", "\\lambda", "\\mu", "\\nu", "\\xi", "\\pi", "\\rho", "\\sigma", "\\tau", "\\upsilon", "\\phi", "\\chi", "\\psi", "\\omega"];
                var particular = new Array(n).fill(new Fraction(0));
                var directionVectors = freeVars.map(() => new Array(n).fill(new Fraction(0)));

                for (var j = 0; j < n; j++) {
                    if (pivotColumns.includes(j)) {
                        var row = pivotRowMap[j];
                        particular[j] = rref[row][n];
                        for (var k = 0; k < freeVars.length; k++) {
                            var freeCol = freeVars[k];
                            directionVectors[k][j] = rref[row][freeCol].multiply(new Fraction(-1));
                        }
                    } else {
                        var freeVarIndex = freeVars.indexOf(j);
                        directionVectors[freeVarIndex][j] = new Fraction(1);
                    }
                }

                // Check if we can factor out a common denominator from particular solution only
                var commonDenParticular = findCommonDenominator(particular);
                
                var isZeroVector = particular.every(val => Math.abs(val.valueOf()) < 1e-10);
                var latexQuick = "\\mathbf{x} = ";
                
                if (!isZeroVector) {
                    if (commonDenParticular > 1) {
                        // Factor out common denominator from particular solution only
                        // Multiply each fraction by commonDenParticular/denominator to get integer numerators
                        var factoredParticular = particular.map(frac => {
                            if (frac instanceof Fraction) {
                                return new Fraction(frac.numerator * (commonDenParticular / frac.denominator), 1);
                            }
                            return new Fraction(frac * commonDenParticular, 1);
                        });
                        latexQuick += "\\frac{1}{" + commonDenParticular + "}\\begin{bmatrix} " + 
                                     factoredParticular.map(frac => formatForLatex(frac.numerator)).join(" \\\\ ") + 
                                     " \\end{bmatrix}";
                    } else {
                        latexQuick += "\\begin{bmatrix} " + particular.map(formatForLatex).join(" \\\\ ") + " \\end{bmatrix}";
                    }
                }
                
                freeVars.forEach((freeVar, k) => {
                    if (!isZeroVector || k > 0) latexQuick += " + ";
                    var param = k < greekLetters.length ? greekLetters[k] : "t_{" + (k - greekLetters.length + 1) + "}";
                    
                    // Do NOT factor out fractions from direction vectors (parameter vectors)
                    // The fraction is absorbed into the parameter
                    latexQuick += param + " \\begin{bmatrix} " + directionVectors[k].map(formatForLatex).join(" \\\\ ") + " \\end{bmatrix}";
                });

                var latexFull = "\\text{The RREF has free variables (columns without leading 1s), so there are infinitely many solutions. } \\\\ \\text{The solution is expressed in parametric form:} \\\\ \\begin{align*} " + latexQuick + " \\end{align*} \\\\ \\text{where } ";
                var params = freeVars.map((_, k) => k < greekLetters.length ? greekLetters[k] : "t_{" + (k - greekLetters.length + 1) + "}");
                if (params.length === 1) {
                    latexFull += params[0] + " \\in \\mathbb{R}.";
                } else if (params.length === 2) {
                    latexFull += params[0] + ", " + params[1] + " \\in \\mathbb{R}.";
                } else if (params.length >= 3) {
                    latexFull += params.slice(0, -1).join(", ") + ", " + params[params.length - 1] + " \\in \\mathbb{R}.";
                }

                return { type: "infinite_solutions", quick: latexQuick, full: latexFull };
            }
        }

        function renderSteps(steps, numVars) { /* mostly unchanged, but we skip initial explanation here */
            var resultDiv = document.getElementById("result");

            // Initial + Final matrices side by side
            if (steps.length > 0 && steps[0].matrix) {
                var matricesDiv = document.createElement("div");
                matricesDiv.className = "mb-8 border-b pb-6 flex justify-between gap-6";
                
                var initialDiv = document.createElement("div");
                initialDiv.className = "flex-1 text-center";
                initialDiv.innerHTML = `<p class="font-semibold mb-2">${steps[0].desc}</p><div class="latex">$$${matrixToLatex(steps[0].matrix, numVars)}$$</div>`;
                
                var finalDiv = document.createElement("div");
                finalDiv.className = "flex-1 text-center";
                finalDiv.innerHTML = `<p class="font-semibold mb-2">${steps[steps.length - 1].desc}</p><div class="latex">$$${matrixToLatex(steps[steps.length - 1].matrix, numVars)}$$</div>`;
                
                matricesDiv.appendChild(initialDiv);
                matricesDiv.appendChild(finalDiv);
                resultDiv.appendChild(matricesDiv);
            }

            // Transformation steps
            var stepsHeader = document.createElement("h3");
            stepsHeader.className = "text-lg font-semibold text-gray-800 mb-4 text-center mt-8";
            stepsHeader.textContent = "Transformation Steps:";
            resultDiv.appendChild(stepsHeader);

            for (var i = 1; i < steps.length - 1; i++) {
                var step = steps[i];
                var stepDiv = document.createElement("div");
                stepDiv.className = "mb-6 border-b pb-4";
                var operation = document.createElement("div");
                operation.className = "latex text-center text-lg font-medium mb-3";
                operation.innerHTML = "\\[" + step.desc + "\\]";
                stepDiv.appendChild(operation);
                if (step.matrix) {
                    var matrixDiv = document.createElement("div");
                    matrixDiv.className = "latex text-center";
                    matrixDiv.innerHTML = "$$" + matrixToLatex(step.matrix, numVars) + "$$";
                    stepDiv.appendChild(matrixDiv);
                }
                resultDiv.appendChild(stepDiv);
            }
        }

        function renderSolutionTop(solution) {
            var resultDiv = document.getElementById("result");
            var topDiv = document.createElement("div");
            topDiv.className = "text-center mb-10 pt-4 pb-6 bg-indigo-50 rounded-lg shadow-inner";
            topDiv.innerHTML = `<h3 class="text-xl font-bold text-indigo-800 mb-4">Solution</h3><div class="text-2xl latex">$$${solution.quick}$$</div>`;
            resultDiv.appendChild(topDiv);
        }

        function renderSolutionBottom(solution) {
            var resultDiv = document.getElementById("result");
            var bottomDiv = document.createElement("div");
            bottomDiv.className = "mt-12 pt-8 border-t";
            var header = document.createElement("h3");
            header.className = "text-lg font-semibold text-gray-800 mb-4 text-center";
            header.textContent = "Solution:";
            bottomDiv.appendChild(header);
            var content = document.createElement("div");
            content.className = "latex text-center text-base";
            content.innerHTML = "$$" + solution.full + "$$";
            bottomDiv.appendChild(content);
            resultDiv.appendChild(bottomDiv);
        }

        document.getElementById("calcBtn").addEventListener("click", function () {
            var input = readMatrix();
            if (input === null) return;

            var A = input.A;
            var b = input.b;
            var m = input.m;
            var n = input.n;

            var augmented = A.map((row, i) => row.concat([b[i]]));
            var computation = computeRREF(augmented);
            var rref = computation.rref;
            var steps = computation.steps;
            var solution = extractSolution(rref, n);

            var resultDiv = document.getElementById("result");
            resultDiv.innerHTML = "";

            // 1. Quick solution at the very top
            renderSolutionTop(solution);

            // 2. Initial + Final matrices
            renderSteps(steps, n);

            // 3. Detailed explanation at the bottom
            renderSolutionBottom(solution);

            renderMathInElement(resultDiv, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false },
                    { left: "\\[", right: "\\]", display: true }
                ]
            });
        });

        function toggleLinearConcepts() {
            var content = document.getElementById("linearContent");
            var icon = document.getElementById("linearToggleIcon");
            if (content.style.display === "none") {
                content.style.display = "block";
                icon.textContent = "−";
            } else {
                content.style.display = "none";
                icon.textContent = "+";
            }
        }

        function loadExample() {
            document.getElementById("m").value = "3";
            document.getElementById("n").value = "3";
            generateMatrix();
            setTimeout(() => {
                // Example: 3x3 system with unique solution
                document.getElementById("cell_0_0").value = "1";
                document.getElementById("cell_0_1").value = "2";
                document.getElementById("cell_0_2").value = "-1";
                document.getElementById("b_0").value = "3";
                document.getElementById("cell_1_0").value = "2";
                document.getElementById("cell_1_1").value = "4";
                document.getElementById("cell_1_2").value = "1";
                document.getElementById("b_1").value = "11";
                document.getElementById("cell_2_0").value = "1";
                document.getElementById("cell_2_1").value = "1";
                document.getElementById("cell_2_2").value = "1";
                document.getElementById("b_2").value = "5";
            }, 100);
        }
    </script>
</body>
</html>
