<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="An interactive visualizer for Newton's Method, demonstrating root-finding convergence, initial guesses, and modified Newton's method for multiple roots.">
  <meta name="keywords" content="Newton's Method, root-finding, numerical analysis, interactive visualizer, mathematics, function plotting, function-plot.js, calculus">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5B8PRB2WZT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-5B8PRB2WZT');
  </script>
  <title>Newton's Method Visualizer</title>
  <!-- KaTeX CDN links -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
  <!-- d3.js and function-plot.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/function-plot@1.22.4/dist/function-plot.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- decimal.js for 20+ decimal precision -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
    .katex-display { overflow-x: auto; padding: 0.25rem; }
    .katex { font-weight: 600 !important; }
    .katex-display { font-weight: 600 !important; }
    .current-function { font-size: 1.1rem; padding: 0.5rem; text-align: center; background-color: #f8f9fa; border-radius: 0.375rem; border: 1px solid #dee2e6; display: inline-block; }
    .control-panel { background-color: #ffffff; padding: 1rem; border-radius: 0.5rem; border: 1px solid #dee2e6; width: 100%; font-size: 0.875rem; }
    #graph { border: 1px solid #dee2e6; border-radius: 0.5rem; width: 100%; height: 500px; background-color: #ffffff; }
    .function-button { padding: 0.5rem 0.5rem; font-size: 0.875rem; font-weight: 600; text-align: left; line-height: 1.3; }
    .function-button .katex { font-weight: 600 !important; }
    .current-iteration-box { background-color: #e9ecef; color: #495057; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; display: inline-block; border: 1px solid #ced4da; }
    .convergence-box { background-color: #e9ecef; color: #495057; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; display: inline-block; border: 1px solid #ced4da; }
    .btn-primary { background-color: #6c757d; color: white; }
    .btn-primary:hover { background-color: #5a6268; }
    .btn-secondary { background-color: #e9ecef; color: #495057; border: 1px solid #ced4da; }
    .btn-secondary:hover { background-color: #dae0e5; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-success:hover { background-color: #218838; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-danger:hover { background-color: #c82333; }
    .animate-btn.running { background-color: #218838 !important; }
    .converged-message { background-color: #d4edda; color: #155724; padding: 0.5rem 1rem; border-radius: 0.375rem; text-align: center; font-size: 0.75rem; display: none; border: 1px solid #c3e6cb; }
    .converged-message.show { display: block; }
    .tolerance-input { font-family: monospace; }
    .ratio-col { background-color: #f8f9fa; }
    .compact-table { font-size: 0.75rem; }
    .compact-table th, .compact-table td { padding: 0.25rem 0.5rem; }
    .compact-table .katex { font-weight: 600 !important; }
    .status-bar { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 0.5rem; }
    .nav-bar { padding: 0.5rem 0; font-size: 0.875rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; }
    .function-button.selected { background-color: #495057; color: white; border-color: #343a40; }
    .mono-font { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; }
    .table-scroll-btn { background-color: #6c757d; color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; border: none; cursor: pointer; transition: background-color 0.2s; width: 100%; margin-top: 0.5rem; }
    .table-scroll-btn:hover { background-color: #5a6268; }
    .control-panel h3 { font-weight: 600; font-size: 0.875rem; }
    .equation-container .katex-display { font-size: 1.05em !important; }
    .control-panel label { font-weight: 500; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="fixed top-0 left-0 w-full bg-white shadow-sm z-10 nav-bar">
    <div class="max-w-4xl mx-auto px-4">
      <ul class="flex justify-center space-x-4">
        <li><a href="index.html" class="text-gray-700 hover:text-gray-900 font-medium">Home</a></li>
        <li><a href="teaching.html" class="text-gray-700 hover:text-gray-900 font-medium">Teaching</a></li>
        <li><a href="projects.html" class="text-gray-700 hover:text-gray-900 font-medium">Diff Eq</a></li>
        <li><a href="linear.html" class="text-gray-700 hover:text-gray-900 font-medium">Linear Algebra</a></li>
        <li><a href="numerical.html" class="text-gray-700 hover:text-gray-900 font-medium">Numerical Methods</a></li>
      </ul>
    </div>
  </div>
  <div class="container mt-12">
    <header class="text-center mb-4">
      <h1 class="text-2xl font-bold text-gray-800">Newton's Method Visualizer</h1>
      <p class="text-gray-600 text-sm mt-1">Interactive visualization of root-finding convergence</p>
    </header>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
      <div class="p-3 bg-white rounded border border-gray-200">
        <h3 class="font-semibold text-gray-700 text-sm mb-1">Newton's Method</h3>
        <div class="equation-container">
          <div class="text-base text-gray-600">\[ x_{n+1} = x_n - \frac{f(x_n)}{f'(x_n)} \]</div>
        </div>
        <p class="text-xs text-gray-500 mt-1 text-center">Quadratic convergence for simple roots</p>
      </div>
      <div class="p-3 bg-white rounded border border-gray-200">
        <h3 class="font-semibold text-gray-700 text-sm mb-1">Modified Newton's Method</h3>
        <div class="equation-container">
          <div class="text-base text-gray-600">\[ x_{n+1} = x_n - m \cdot \frac{f(x_n)}{f'(x_n)} \]</div>
        </div>
        <p class="text-xs text-gray-500 mt-1 text-center">For roots with multiplicity \( m \)</p>
      </div>
      <div class="p-3 bg-white rounded border border-gray-200 flex flex-col justify-center items-center">
        <div class="status-bar justify-center mb-2">
          <div class="current-iteration-box"> Iteration: <span id="current-iteration" class="mono-font">0</span> </div>
          <div class="convergence-box"> Error: <span id="current-error" class="mono-font">1.00e+0</span> </div>
        </div>
        <button onclick="scrollToTable()" class="table-scroll-btn"> See Full Error Table </button>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
      <div class="lg:col-span-3">
        <div class="bg-white rounded border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-3">
            <div class="flex items-start gap-4">
              <div id="current-function" class="current-function text-sm">\[ f(x) = e^{x-1} - 1 \]</div>
              <div class="grid grid-cols-2 gap-2 ml-4">
                <button onclick="runSimpleRoot()" class="px-2 py-1 btn-success rounded text-xs transition-colors">simple root</button>
                <button onclick="runRepeatedNewton()" class="px-2 py-1 btn-success rounded text-xs transition-colors">repeated \( (m=2) \) Newton</button>
                <button onclick="runModifiedNewton()" class="px-2 py-1 btn-success rounded text-xs transition-colors">repeated \( (m=2) \) modified Newton</button>
                <button onclick="runNonConvergent()" class="px-2 py-1 btn-success rounded text-xs transition-colors">non-convergent (oscillations)</button>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="resetIterations()" class="px-3 py-1 btn-secondary rounded text-sm transition-colors">Reset</button>
              <button onclick="performIterationManual()" class="px-3 py-1 btn-primary rounded text-sm transition-colors">Step</button>
              <button id="animate-btn" onclick="toggleAnimation()" class="px-3 py-1 btn-success rounded text-sm transition-colors">Animate</button>
              <button id="stop-btn" onclick="stopAnimation()" class="px-3 py-1 btn-danger rounded text-sm transition-colors hidden">Stop</button>
            </div>
          </div>
          <div id="graph-container">
            <div id="graph"></div>
          </div>
          <div id="converged-message" class="converged-message mt-2"> ✓ Convergence achieved! Absolute error ≤ 1e-13 </div>
        </div>
      </div>
      <div class="lg:col-span-1">
        <div class="control-panel">
          <div class="mb-3">
            <h3 class="text-sm font-medium text-gray-700 mb-2">Select Function</h3>
            <div class="space-y-1" id="function-buttons">
              <button onclick="selectFunction(0)" class="function-button selected bg-gray-50 hover:bg-gray-100 text-gray-700 rounded border border-gray-300 w-full">\[ e^{x-1} - 1 \]</button>
              <button onclick="selectFunction(1)" class="function-button bg-gray-50 hover:bg-gray-100 text-gray-700 rounded border border-gray-300 w-full">\[ (x-1)^2 e^{x-2} \]</button>
              <button onclick="selectFunction(2)" class="function-button bg-gray-50 hover:bg-gray-100 text-gray-700 rounded border border-gray-300 w-full">\[ x^3 - 2x + 2 \]</button>
              <button onclick="selectFunction(3)" class="function-button bg-gray-50 hover:bg-gray-100 text-gray-700 rounded border border-gray-300 w-full">\[ (\sin(x) - x + 1)^2 \]</button>
              <button onclick="selectFunction(4)" class="function-button bg-gray-50 hover:bg-gray-100 text-gray-700 rounded border border-gray-300 w-full">\[ (e^{x-2} - 1)^3 \]</button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Initial Guess \( x_0 \)</label>
              <input type="number" id="x0" value="2.5" step="0.1" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-gray-400">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Multiplicity \( m \)</label>
              <select id="multiplicity" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-gray-400">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <div class="flex items-center mb-2">
              <input type="checkbox" id="modifiedMethod" class="rounded text-gray-600 focus:ring-gray-400">
              <span class="ml-2 text-xs text-gray-700">Use Modified Newton's Method</span>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Tolerance</label>
              <input type="text" id="convergence-tolerance" value="1e-13" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-gray-400 tolerance-input mono-font">
            </div>
          </div>
          <div class="mb-3">
            <label class="block text-xs font-medium text-gray-700 mb-1">Animation Speed</label>
            <div class="flex items-center">
              <span class="text-xs text-gray-500 mr-2">Fast</span>
              <input type="range" id="animation-speed" min="200" max="2000" value="600" step="100" class="flex-1">
              <span class="text-xs text-gray-500 ml-2">Slow</span>
            </div>
            <div class="text-center text-xs text-gray-500 mt-1 mono-font" id="speed-display">600 ms</div>
          </div>
          <div id="error-message" class="p-2 bg-red-50 text-red-700 rounded text-xs hidden border border-red-200"></div>
        </div>
      </div>
    </div>
    <div id="iteration-table-container" class="bg-white rounded border border-gray-200 p-4">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">Iteration Details</h2>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse compact-table">
          <thead>
            <tr class="bg-gray-50">
              <th class="border border-gray-300 px-2 py-1 text-center font-semibold text-xs">n</th>
              <th class="border border-gray-300 px-2 py-1 text-center font-semibold text-xs">\( x_n \)</th>
              <th class="border border-gray-300 px-2 py-1 text-center font-semibold text-xs">\( f(x_n) \)</th>
              <th class="border border-gray-300 px-2 py-1 text-center font-semibold text-xs">\( f'(x_n) \)</th>
              <th class="border border-gray-300 px-2 py-1 text-center font-semibold text-xs">Error \( e_n \)</th>
              <th class="border border-gray-300 px-2 py-1 text-center font-semibold text-xs ratio-col">\( e_{n+1}/e_n \)</th>
              <th class="border border-gray-300 px-2 py-1 text-center font-semibold text-xs ratio-col">\( e_{n+1}/e_n^2 \)</th>
            </tr>
          </thead>
          <tbody id="iteration-data"></tbody>
        </table>
      </div>
    </div>
    <div class="mt-4 text-center text-gray-500 text-xs">
    &copy; 2025 Shelvean Kapita: kapita@tamu.edu<br>
    All code released under the <a href="https://opensource.org/licenses/MIT">MIT License</a>.<br>
    Last modified: December 14, 2025
     </div>
  </div>
  <script>
    // Set decimal.js to high precision (20+ digits)
    Decimal.set({ precision: 30, rounding: Decimal.ROUND_HALF_UP });

    const functions = [
      { 
        f: x => x.minus(1).exp().minus(1), 
        df: x => x.minus(1).exp(), 
        fStr: "e^{x-1} - 1", 
        plotFn: "exp(x-1) - 1", 
        root: new Decimal("1"), 
        multiplicity: 1 
      },
      { 
        f: x => x.minus(1).pow(2).times(x.minus(2).exp()), 
        df: x => {
          const t1 = new Decimal(2).times(x.minus(1)).times(x.minus(2).exp());
          const t2 = x.minus(1).pow(2).times(x.minus(2).exp());
          return t1.plus(t2);
        }, 
        fStr: "(x-1)^2 e^{x-2}", 
        plotFn: "(x-1)^2 * exp(x-2)", 
        root: new Decimal("1"), 
        multiplicity: 2 
      },
      { 
        f: x => x.pow(3).minus(x.times(2)).plus(2), 
        df: x => x.pow(2).times(3).minus(2), 
        fStr: "x^3 - 2x + 2", 
        plotFn: "x^3 - 2*x + 2", 
        root: new Decimal("-1.7692923542386314"), 
        multiplicity: 1 
      },
      { 
        f: x => {
          const inner = x.sin().minus(x).plus(1);
          return inner.pow(2);
        }, 
        df: x => {
          const inner = x.sin().minus(x).plus(1);
          const dInner = x.cos().minus(1);
          return new Decimal(2).times(inner).times(dInner);
        }, 
        fStr: "(\\sin(x) - x + 1)^2", 
        plotFn: "(sin(x) - x + 1)^2", 
        root: new Decimal("1.934563210752024"), 
        multiplicity: 2 
      },
      { 
        f: x => {
          const inner = x.minus(2).exp().minus(1);
          return inner.pow(3);
        }, 
        df: x => {
          const inner = x.minus(2).exp().minus(1);
          return new Decimal(3).times(inner.pow(2)).times(x.minus(2).exp());
        }, 
        fStr: "(e^{x-2} - 1)^3", 
        plotFn: "(exp(x-2) - 1)^3", 
        root: new Decimal("2"), 
        multiplicity: 3 
      }
    ];

    let currentFunction = functions[0];
    let iterations = [];
    let currentIteration = 0;
    let xMin = -2, xMax = 5;
    let yMin = -5, yMax = 10;
    const tangentColor = '#8B4513';
    let animationInterval = null;
    let isAnimating = false;
    let CONVERGENCE_TOLERANCE = new Decimal("1e-13");

    function scrollToTable() {
      document.getElementById('iteration-table-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function updateStatusDisplay() {
      if (iterations.length > 0) {
        const lastIter = iterations[iterations.length - 1];
        document.getElementById('current-iteration').textContent = lastIter.n;
        document.getElementById('current-error').textContent = lastIter.error.toExponential(2);
      }
    }

    function updateFunctionButtons(selectedIndex) {
      const buttons = document.querySelectorAll('#function-buttons .function-button');
      buttons.forEach((button, index) => {
        if (index === selectedIndex) {
          button.classList.add('selected', 'bg-gray-800', 'text-white');
          button.classList.remove('bg-gray-50', 'text-gray-700');
        } else {
          button.classList.remove('selected', 'bg-gray-800', 'text-white');
          button.classList.add('bg-gray-50', 'text-gray-700');
        }
      });
    }

    function renderKaTeX() {
      renderMathInElement(document.body, {
        delimiters: [
          {left: "$$", right: "$$", display: true},
          {left: "\\[", right: "\\]", display: true},
          {left: "\\(", right: "\\)", display: false}
        ],
        throwOnError: false
      });
    }

    function parseTolerance(value) {
      value = value.trim();
      try {
        return new Decimal(value);
      } catch (e) {
        return new Decimal("1e-13");
      }
    }

    function init() {
      const speedSlider = document.getElementById('animation-speed');
      const speedDisplay = document.getElementById('speed-display');
      const toleranceInput = document.getElementById('convergence-tolerance');

      speedSlider.addEventListener('input', () => speedDisplay.textContent = `${speedSlider.value} ms`);
      toleranceInput.addEventListener('blur', () => {
        CONVERGENCE_TOLERANCE = parseTolerance(toleranceInput.value);
        toleranceInput.value = CONVERGENCE_TOLERANCE.toExponential();
        updateConvergenceMessage();
      });

      document.getElementById('modifiedMethod').addEventListener('change', resetIterations);
      document.getElementById('x0').addEventListener('change', resetIterations);
      document.getElementById('multiplicity').addEventListener('change', resetIterations);

      updateFunctionButtons(0);
      speedDisplay.textContent = "600 ms";
      resetIterations();
      renderKaTeX();
      drawGraph();
    }

    function selectFunction(index) {
      currentFunction = functions[index];
      document.getElementById('current-function').innerHTML = `\\[ f(x) = ${currentFunction.fStr} \\]`;
      document.getElementById('multiplicity').value = currentFunction.multiplicity;
      updateFunctionButtons(index);
      document.getElementById('modifiedMethod').checked = false;
      resetIterations();
      stopAnimation();
      renderKaTeX();
    }

    function getAbsoluteError(x) {
      return x.minus(currentFunction.root).abs();
    }

    function hasConverged() {
      if (iterations.length === 0) return false;
      return iterations[iterations.length - 1].error.lte(CONVERGENCE_TOLERANCE);
    }

    function updateConvergenceMessage() {
      const msg = document.getElementById('converged-message');
      if (hasConverged() && iterations.length > 0) {
        const lastError = iterations[iterations.length - 1].error;
        const iterCount = iterations.length - 1;
        msg.innerHTML = `✓ Convergence achieved after ${iterCount} iterations! Absolute error = ${lastError.toExponential(2)} ≤ ${CONVERGENCE_TOLERANCE.toExponential(2)}`;
        msg.classList.add('show');
      } else {
        msg.classList.remove('show');
      }
    }

    function resetIterations() {
      stopAnimation();
      const x0Str = document.getElementById('x0').value;
      let x0;
      try { x0 = new Decimal(x0Str); } catch (e) {
        showError("Invalid initial guess");
        return;
      }

      iterations = [{
        n: 0,
        x: x0,
        fx: currentFunction.f(x0),
        dfx: currentFunction.df(x0),
        error: getAbsoluteError(x0),
        prevRatioLinear: "-",
        prevRatioQuadratic: "-"
      }];
      currentIteration = 0;
      updateTable();
      updateConvergenceMessage();
      updateStatusDisplay();
      drawGraph();
      hideError();
    }

    function performIteration() {
      if (currentIteration >= 50) { showError("Maximum iterations (50) reached"); stopAnimation(); return; }
      if (hasConverged()) { stopAnimation(); return; }

      const modified = document.getElementById('modifiedMethod').checked;
      const m = modified ? parseInt(document.getElementById('multiplicity').value) : 1;
      const multDec = new Decimal(m);

      const last = iterations[iterations.length - 1];
      if (last.dfx.abs().lt("1e-15")) { showError("Derivative near zero"); stopAnimation(); return; }

      const xNext = last.x.minus(multDec.times(last.fx).div(last.dfx));
      const fxNext = currentFunction.f(xNext);
      const dfxNext = currentFunction.df(xNext);
      const errorNext = getAbsoluteError(xNext);

      let ratioL = "-", ratioQ = "-";
      if (iterations.length > 1) {
        const prevError = iterations[iterations.length - 2].error;
        if (prevError.gt(0)) {
          ratioL = errorNext.div(prevError).toFixed(10);
          ratioQ = errorNext.div(prevError.pow(2)).toFixed(10);
        }
      }

      iterations.push({
        n: iterations.length,
        x: xNext,
        fx: fxNext,
        dfx: dfxNext,
        error: errorNext,
        prevRatioLinear: ratioL,
        prevRatioQuadratic: ratioQ
      });

      currentIteration++;
      updateTable();
      updateConvergenceMessage();
      updateStatusDisplay();
      drawGraph();
      hideError();

      if (hasConverged() || currentIteration >= 50) stopAnimation();
    }

    function performIterationManual() { stopAnimation(); performIteration(); }

    function toggleAnimation() { isAnimating ? stopAnimation() : startAnimation(); }

    function startAnimation() {
      if (isAnimating || hasConverged()) return;
      isAnimating = true;
      document.getElementById('animate-btn').classList.add('hidden', 'running');
      document.getElementById('stop-btn').classList.remove('hidden');
      const speed = parseInt(document.getElementById('animation-speed').value);
      animationInterval = setInterval(performIteration, speed);
    }

    function stopAnimation() {
      if (!isAnimating) return;
      isAnimating = false;
      document.getElementById('animate-btn').classList.remove('hidden', 'running');
      document.getElementById('stop-btn').classList.add('hidden');
      clearInterval(animationInterval);
      animationInterval = null;
    }

    function updateTable() {
      const tbody = document.getElementById('iteration-data');
      tbody.innerHTML = '';
      iterations.forEach(iter => {
        const converged = iter.error.lte(CONVERGENCE_TOLERANCE);
        const bg = converged ? 'bg-green-50' : '';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="border border-gray-300 px-2 py-1 text-center ${bg} mono-font">${iter.n}</td>
          <td class="border border-gray-300 px-2 py-1 text-center ${bg} mono-font text-xs">${iter.x.toFixed(12)}</td>
          <td class="border border-gray-300 px-2 py-1 text-center ${bg} mono-font text-xs">${iter.fx.toExponential(8)}</td>
          <td class="border border-gray-300 px-2 py-1 text-center ${bg} mono-font text-xs">${iter.dfx.toExponential(8)}</td>
          <td class="border border-gray-300 px-2 py-1 text-center ${bg} mono-font text-xs">${iter.error.toExponential(8)}</td>
          <td class="border border-gray-300 px-2 py-1 text-center ${bg} ratio-col mono-font text-xs">${iter.prevRatioLinear}</td>
          <td class="border border-gray-300 px-2 py-1 text-center ${bg} ratio-col mono-font text-xs">${iter.prevRatioQuadratic}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function calculateGraphBounds() {
      xMin = -2; xMax = 5; yMin = -5; yMax = 10;
      if (currentFunction.fStr.includes("\\sin")) { xMin = 0; xMax = 4; yMin = -0.5; yMax = 4; }
      if (currentFunction.fStr.includes("e^{x-2} - 1)^3")) { xMin = 0; xMax = 4; yMin = -2; yMax = 2; }

      if (iterations.length > 1) {
        const prev = iterations[iterations.length - 2];
        const curr = iterations[iterations.length - 1];
        const slope = Number(prev.dfx);
        const intercept = Number(prev.fx.minus(prev.dfx.times(prev.x)));
        const allX = [];
        const allY = [];
        for (let dx = -2; dx <= 2; dx += 0.5) {
          const tx = Number(prev.x) + dx;
          allX.push(tx);
          allY.push(slope * tx + intercept);
        }
        const center = (Number(prev.x) + Number(curr.x)) / 2;
        const range = Math.max(Math.abs(Number(prev.x) - Number(curr.x)) * 3, 3);
        for (let dx = -range; dx <= range; dx += 0.5) {
          const fx = center + dx;
          allX.push(fx);
          allY.push(Number(currentFunction.f(new Decimal(fx))));
        }
        allX.push(Number(prev.x), Number(curr.x), Number(currentFunction.root));
        allY.push(Number(prev.fx), 0, 0);

        const paddingX = Math.max((Math.max(...allX) - Math.min(...allX)) * 0.3, 0.5);
        const paddingY = Math.max((Math.max(...allY) - Math.min(...allY)) * 0.3, 0.5);
        xMin = Math.max(Math.min(...allX) - paddingX, -10);
        xMax = Math.min(Math.max(...allX) + paddingX, 10);
        yMin = Math.max(Math.min(...allY) - paddingY, -15);
        yMax = Math.min(Math.max(...allY) + paddingY, 15);
      }
    }

    function drawGraph() {
      calculateGraphBounds();
      document.getElementById('graph').innerHTML = '';

      const rootPoint = { points: [[Number(currentFunction.root), 0]], fnType: 'points', graphType: 'scatter', color: '#dc3545', attr: { r: 8 } };
      let tangent = [];
      if (iterations.length > 1) {
        const prev = iterations[iterations.length - 2];
        const slope = Number(prev.dfx);
        const intercept = Number(prev.fx.minus(prev.dfx.times(prev.x)));
        tangent = [{ fn: `${slope.toFixed(10)}*x + ${intercept.toFixed(10)}`, color: tangentColor, sampler: 'builtIn', graphType: 'polyline', attr: {'stroke-width': 2} }];
      }

      let verticals = [];
      iterations.slice(1).forEach((it, i) => {
        const col = i === iterations.length - 2 ? '#dc3545' : '#6c757d';
        verticals.push({ points: [[Number(it.x), 0], [Number(it.x), Number(it.fx)]], fnType: 'points', graphType: 'polyline', color: col, attr: {'stroke-dasharray': '5 5', 'stroke-width': 1.5} });
      });

      const prevPoints = iterations.slice(0, -1).map(it => [Number(it.x), 0]);
      const prevScatter = prevPoints.length ? { points: prevPoints, fnType: 'points', graphType: 'scatter', color: '#6c757d', attr: { r: 5 } } : null;

      const lastScatter = iterations.length ? { points: [[Number(iterations[iterations.length-1].x), 0]], fnType: 'points', graphType: 'scatter', color: '#dc3545', attr: { r: 6 } } : null;

      let data = [
        { fn: currentFunction.plotFn, color: '#495057', sampler: 'builtIn', graphType: 'polyline', nSamples: 400, attr: {'stroke-width': 3} },
        rootPoint
      ];
      data = data.concat(verticals).concat(tangent);
      if (prevScatter) data.push(prevScatter);
      if (lastScatter) data.push(lastScatter);

      functionPlot({
        target: '#graph',
        width: 1050,
        height: 500,
        xAxis: { domain: [xMin, xMax] },
        yAxis: { domain: [yMin, yMax] },
        grid: true,
        disableZoom: false,
        data: data
      });

      renderMathInElement(document.getElementById('graph'), {
        delimiters: [{left: "$$", right: "$$", display: true}, {left: "\\[", right: "\\]", display: true}, {left: "\\(", right: "\\)", display: false}],
        throwOnError: false
      });
    }

    function showError(msg) {
      const el = document.getElementById('error-message');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('error-message').classList.add('hidden');
    }

    function runSimpleRoot() { selectFunction(2); document.getElementById('x0').value = 3; document.getElementById('modifiedMethod').checked = false; resetIterations(); startAnimation(); }
    function runRepeatedNewton() { selectFunction(3); document.getElementById('x0').value = 3; document.getElementById('modifiedMethod').checked = false; resetIterations(); startAnimation(); }
    function runModifiedNewton() { selectFunction(3); document.getElementById('x0').value = 3; document.getElementById('modifiedMethod').checked = true; resetIterations(); startAnimation(); }
    function runNonConvergent() { selectFunction(2); document.getElementById('x0').value = 10; document.getElementById('modifiedMethod').checked = false; resetIterations(); startAnimation(); }

    window.addEventListener('load', init);
  </script>
</body>
</html>
