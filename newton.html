<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="An interactive visualizer for Newton's Method, demonstrating root-finding convergence, initial guesses, and modified Newton's method for multiple roots.">
  <meta name="keywords" content="Newton's Method, root-finding, numerical analysis, interactive visualizer, mathematics, function plotting, function-plot.js, calculus">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5B8PRB2WZT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-5B8PRB2WZT');
  </script>
  <title>Newton's Method Visualizer</title>
  <!-- KaTeX CDN links -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
  <!-- Decimal.js for high precision arithmetic -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
  <!-- d3.js and function-plot.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/function-plot@1.22.4/dist/function-plot.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
    .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
    .katex-display { overflow-x: auto; padding: 0.25rem; }
    /* Make all KaTeX math bolder and larger */
    .katex { font-weight: 600 !important; }
    .katex-display { font-weight: 600 !important; }
    .current-function { font-size: 1.1rem; padding: 0.5rem; text-align: center; background-color: #f8f9fa; border-radius: 0.375rem; border: 1px solid #dee2e6; display: inline-block; }
    .control-panel { background-color: #ffffff; padding: 1.25rem; border-radius: 0.5rem; border: 1px solid #dee2e6; width: 100%; font-size: 0.875rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    #graph { border: 1px solid #dee2e6; border-radius: 0.5rem; width: 100%; height: 500px; background-color: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .function-button { padding: 0.5rem 0.5rem; font-size: 0.875rem; font-weight: 600; text-align: left; line-height: 1.3; }
    .function-button .katex { font-weight: 600 !important; }
    .current-iteration-box { background-color: #e9ecef; color: #495057; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; display: inline-block; border: 1px solid #ced4da; }
    .ce-box { background-color: #e9ecef; color: #495057; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; display: inline-block; border: 1px solid #ced4da; }
    .btn-primary { background-color: #6c757d; color: white; }
    .btn-primary:hover { background-color: #5a6268; }
    .btn-secondary { background-color: #e9ecef; color: #495057; border: 1px solid #ced4da; }
    .btn-secondary:hover { background-color: #dae0e5; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-success:hover { background-color: #218838; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-danger:hover { background-color: #c82333; }
    .animate-btn.running { background-color: #218838 !important; }
    .converged-message { background-color: #d4edda; color: #155724; padding: 0.75rem 1rem; border-radius: 0.375rem; text-align: center; font-size: 0.875rem; display: none; border: 1px solid #c3e6cb; }
    .converged-message.show { display: block; }
    .tolerance-input { font-family: monospace; }
    .ratio-col { background-color: #f8f9fa; }
    .compact-table { font-size: 0.75rem; }
    .compact-table th, .compact-table td { padding: 0.5rem 0.75rem; }
    .compact-table .katex { font-weight: 600 !important; }
    .status-bar { display: flex; gap: 0.75rem; align-items: center; margin-bottom: 0.5rem; }
    .nav-bar { padding: 0.75rem 0; font-size: 1rem; background-color: #ffffff; border-bottom: 2px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .function-button.selected { background-color: #495057; color: white; border-color: #343a40; }
    .mono-font { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; }
    .table-scroll-btn { background-color: #1e40af; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; border: none; cursor: pointer; transition: background-color 0.2s; margin-top: 0.5rem; }
    .table-scroll-btn:hover { background-color: #1e3a8a; }
    .control-panel h3 { font-weight: 600; font-size: 0.875rem; color: #374151; }
    /* Make equation boxes larger */
    .equation-container .katex-display { font-size: 1.1em !important; }
    /* Make input labels bolder */
    .control-panel label { font-weight: 600; color: #4b5563; }
    .method-card { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; }
    .nav-link { color: #1e40af; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.2s; }
    .nav-link:hover { background-color: #f0f9ff; color: #1d4ed8; }
    .header-section { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-bottom: 1px solid #cbd5e1; padding: 1.5rem 0; margin-bottom: 1.5rem; }
    .section-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem; }
    .demo-button { padding: 0.5rem 0.75rem; font-size: 0.875rem; border-radius: 0.375rem; transition: all 0.2s; }
    .info-box { background-color: #f0f9ff; border: 1px solid #bae6fd; border-radius: 0.5rem; padding: 1rem; }
    .info-title { color: #0369a1; font-weight: 600; margin-bottom: 0.5rem; }
    .iteration-highlight { background-color: #fef3c7 !important; }
    .active-iteration { background-color: #dcfce7 !important; }
    .nav-active { color: #1d4ed8; font-weight: 600; }
  </style>
</head>
<body class="bg-gray-50">
  <!-- White Navigation Bar with Blue Links -->
  <div class="fixed top-0 left-0 w-full z-50 nav-bar">
    <div class="max-w-7xl mx-auto px-6">
      <div class="flex justify-center">
        <ul class="flex space-x-6">
          <li><a href="index.html" class="nav-link">Home</a></li>
          <li><a href="teaching.html" class="nav-link">Teaching</a></li>
          <li><a href="projects.html" class="nav-link">Diff Eq</a></li>
          <li><a href="linear.html" class="nav-link">Linear Algebra</a></li>
          <li><a href="numerical.html" class="nav-link nav-active">Numerical Methods</a></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="container mt-24">
    <!-- Header Section -->
    <header class="header-section rounded-lg mb-6">
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-800">Newton's Method Visualizer</h1>
        <p class="text-gray-600 text-base mt-2 max-w-3xl mx-auto">Interactive Newton's Method Visualizer: Explore root-finding ce through automated demonstrations and detailed iteration analysis.</p>
      </div>
    </header>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
      <!-- Left Column: Method Information and Controls -->
      <div class="lg:col-span-1 space-y-6">
        <!-- Method Selection Card -->
        <div class="method-card">
          <h3 class="section-title">Select Function</h3>
          <div class="space-y-2" id="function-buttons">
            <button onclick="selectFunction(0)" class="function-button selected bg-gray-800 text-white rounded border border-gray-300 w-full text-left p-3 hover:bg-gray-700 transition-colors">
              \[ f(x) = e^{x-1} - 1 \]
            </button>
            <button onclick="selectFunction(1)" class="function-button bg-gray-50 hover:bg-gray-100 text-gray-700 rounded border border-gray-300 w-full text-left p-3 transition-colors">
              \[ f(x) = (x-1)^2 e^{x-2} \]
            </button>
            <button onclick="selectFunction(2)" class="function-button bg-gray-50 hover:bg-gray-100 text-gray-700 rounded border border-gray-300 w-full text-left p-3 transition-colors">
              \[ f(x) = x^3 - 2x + 2 \]
            </button>
            <button onclick="selectFunction(3)" class="function-button bg-gray-50 hover:bg-gray-100 text-gray-700 rounded border border-gray-300 w-full text-left p-3 transition-colors">
              \[ f(x) = (\sin(x) - x + 1)^2 \]
            </button>
            <button onclick="selectFunction(4)" class="function-button bg-gray-50 hover:bg-gray-100 text-gray-700 rounded border border-gray-300 w-full text-left p-3 transition-colors">
              \[ f(x) = (e^{x-2} - 1)^3 \]
            </button>
          </div>
        </div>

        <!-- Current Function Display -->
        <div class="method-card">
          <h3 class="section-title">Current Function</h3>
          <div id="current-function" class="current-function text-base w-full text-center p-3 bg-white">
            \[ f(x) = e^{x-1} - 1 \]
          </div>
        </div>

        <!-- Quick Demo Buttons -->
        <div class="method-card">
          <h3 class="section-title">Quick Demos</h3>
          <div class="grid grid-cols-2 gap-2">
            <button onclick="runSimpleRoot()" class="demo-button btn-success text-sm">
              Simple Root
            </button>
            <button onclick="runRepeatedNewton()" class="demo-button btn-success text-sm">
              Repeated (m=2) Newton
            </button>
            <button onclick="runModifiedNewton()" class="demo-button btn-success text-sm">
              Modified Newton
            </button>
            <button onclick="runNonConvergent()" class="demo-button btn-success text-sm">
              Non-Convergent
            </button>
          </div>
        </div>
      </div>

      <!-- Center Column: Graph and Main Controls -->
      <div class="lg:col-span-2">
        <!-- Graph Container -->
        <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm mb-6">
          <div id="graph"></div>
        </div>

        <!-- Convergence Status -->
        <div id="converged-message" class="converged-message mb-4">
          ‚úì Convergence achieved! Absolute error ‚â§ 1e-13
        </div>

        <!-- Iteration Controls -->
        <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm mb-6">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button onclick="resetIterations()" class="btn-secondary py-2 px-4 rounded text-base font-medium">
              Reset
            </button>
            <button onclick="performIterationManual()" class="btn-primary py-2 px-4 rounded text-base font-medium">
              Step
            </button>
            <button id="animate-btn" onclick="toggleAnimation()" class="btn-success py-2 px-4 rounded text-base font-medium">
              Animate
            </button>
            <button id="stop-btn" onclick="stopAnimation()" class="btn-danger py-2 px-4 rounded text-base font-medium hidden">
              Stop
            </button>
          </div>
        </div>
      </div>

      <!-- Right Column: Parameters and Information -->
      <div class="lg:col-span-1">
        <!-- Control Panel -->
        <div class="control-panel mb-6">
          <h3 class="text-base font-semibold text-gray-800 mb-4">Parameters</h3>
          
          <div class="space-y-4">
            <!-- Initial Guess -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Initial Guess \( x_0 \)</label>
              <input type="number" id="x0" value="2.5" step="0.1" class="w-full px-3 py-2 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            <!-- Multiplicity -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Multiplicity \( m \)</label>
              <select id="multiplicity" class="w-full px-3 py-2 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="1">1 (Simple Root)</option>
                <option value="2">2 (Double Root)</option>
                <option value="3">3 (Triple Root)</option>
              </select>
            </div>

            <!-- Modified Method Checkbox -->
            <div class="flex items-center">
              <input type="checkbox" id="modifiedMethod" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
              <label for="modifiedMethod" class="ml-2 block text-sm text-gray-700">
                Use Modified Newton's Method
              </label>
            </div>

            <!-- Tolerance -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Convergence Tolerance</label>
              <input type="text" id="convergence-tolerance" value="1e-13" class="w-full px-3 py-2 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent tolerance-input mono-font">
            </div>

            <!-- Animation Speed -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Animation Speed</label>
              <div class="flex items-center mb-2">
                <span class="text-sm text-gray-600 mr-3">Fast</span>
                <input type="range" id="animation-speed" min="200" max="2000" value="600" step="100" class="flex-1">
                <span class="text-sm text-gray-600 ml-3">Slow</span>
              </div>
              <div class="text-center text-sm text-gray-600 mono-font" id="speed-display">600 ms</div>
            </div>
          </div>
        </div>

        <!-- Current Status -->
        <div class="info-box">
          <div class="info-title">Current Status</div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-700">Iteration:</span>
              <span id="current-iteration" class="text-base font-bold mono-font">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-700">Current Error:</span>
              <span id="current-error" class="text-base font-bold mono-font">1.00e+0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-700">Function Value:</span>
              <span id="current-fx" class="text-base font-bold mono-font">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Method Explanation Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="method-card">
        <h3 class="section-title flex items-center">
          <span class="text-blue-600 mr-2">üìà</span>
          Newton's Method
        </h3>
        <div class="equation-container mb-3">
          <div class="text-lg text-gray-700">\[ x_{n+1} = x_n - \frac{f(x_n)}{f'(x_n)} \]</div>
        </div>
        <p class="text-sm text-gray-600">Quadratic convergence for simple roots (\(m=1\)). Convergence rate: \(e_{n+1} \propto e_n^2\)</p>
      </div>
      
      <div class="method-card">
        <h3 class="section-title flex items-center">
          <span class="text-green-600 mr-2">‚ö°</span>
          Modified Newton's Method
        </h3>
        <div class="equation-container mb-3">
          <div class="text-lg text-gray-700">\[ x_{n+1} = x_n - m \cdot \frac{f(x_n)}{f'(x_n)} \]</div>
        </div>
        <p class="text-sm text-gray-600">For roots with multiplicity \(m > 1\). Restores quadratic convergence for multiple roots. Convergence rate: \[e_{n+1} \propto \frac{m-1}{m} e_n\]</p>
      </div>
      
      <div class="method-card">
        <h3 class="section-title flex items-center">
          <span class="text-purple-600 mr-2">üîç</span>
          Convergence Analysis
        </h3>
        <div class="space-y-2">
          <p class="text-sm text-gray-600"><span class="font-semibold">Linear:</span> \(e_{n+1}/e_n \to \text{constant}\)</p>
          <p class="text-sm text-gray-600"><span class="font-semibold">Quadratic:</span> \(e_{n+1}/e_n^2 \to \text{constant}\)</p>
          <p class="text-sm text-gray-600"><span class="font-semibold">Precision:</span> 50-digit calculations</p>
        </div>
      </div>
    </div>

    <!-- Iteration Table (Scroll to view) -->
    <div id="iteration-table-container" class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Iteration Details</h2>
        <div class="flex items-center space-x-3">
          <span class="text-sm text-gray-600">Current iteration highlighted in green</span>
          <button onclick="scrollToTable()" class="table-scroll-btn py-2 px-4">
            Jump to Latest
          </button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse compact-table">
          <thead>
            <tr class="bg-gray-50">
              <th class="border border-gray-300 px-3 py-2 text-left font-semibold text-sm">n</th>
              <th class="border border-gray-300 px-3 py-2 text-left font-semibold text-sm">\( x_n \)</th>
              <th class="border border-gray-300 px-3 py-2 text-left font-semibold text-sm">\( f(x_n) \)</th>
              <th class="border border-gray-300 px-3 py-2 text-left font-semibold text-sm">\( f'(x_n) \)</th>
              <th class="border border-gray-300 px-3 py-2 text-left font-semibold text-sm">Error \( e_n \)</th>
              <th class="border border-gray-300 px-3 py-2 text-left font-semibold text-sm ratio-col">\( e_{n+1}/e_n \)</th>
              <th class="border border-gray-300 px-3 py-2 text-left font-semibold text-sm ratio-col">\( e_{n+1}/e_n^2 \)</th>
            </tr>
          </thead>
          <tbody id="iteration-data"></tbody>
        </table>
      </div>
      <div class="mt-4 text-sm text-gray-500 text-center">
        Showing all iterations. Scroll down to see more.
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 pt-6 border-t border-gray-200 text-center text-gray-500 text-sm">
      <p class="mb-2">&copy; 2025 Shelvean Kapita: kapita@tamu.edu</p>
      <p class="mb-2">All code released under the <a href="https://opensource.org/licenses/MIT" class="text-blue-600 hover:underline">MIT License</a>.</p>
      <p>Last modified: December 14, 2025 | High-precision calculations using Decimal.js</p>
    </div>
  </div>

  <script>
    // Set Decimal.js precision to 50 digits (20 decimal places + buffer)
    Decimal.set({ precision: 50 });

    // Helper function to convert Decimal to number for display and plotting
    function decimalToNumber(d) {
      return d.toNumber();
    }

    // Helper function to format Decimal for display
    function formatDecimal(d, decimals = 12) {
      return d.toDecimalPlaces(decimals).toString();
    }

    // Helper function to format Decimal in scientific notation
    function formatDecimalScientific(d, decimals = 8) {
      return d.toExponential(decimals);
    }

    const functions = [
      { 
        f: x => {
          const xd = new Decimal(x);
          return xd.minus(1).exp().minus(1);
        }, 
        df: x => {
          const xd = new Decimal(x);
          return xd.minus(1).exp();
        }, 
        fStr: "e^{x-1} - 1", 
        plotFn: "exp(x-1) - 1", 
        root: new Decimal(1), 
        multiplicity: 1 
      },
      { 
        f: x => {
          const xd = new Decimal(x);
          const term1 = xd.minus(1).pow(2);
          const term2 = xd.minus(2).exp();
          return term1.times(term2);
        }, 
        df: x => {
          const xd = new Decimal(x);
          const term1 = new Decimal(2).times(xd.minus(1)).times(xd.minus(2).exp());
          const term2 = xd.minus(1).pow(2).times(xd.minus(2).exp());
          return term1.plus(term2);
        }, 
        fStr: "(x-1)^2 e^{x-2}", 
        plotFn: "(x-1)^2 * exp(x-2)", 
        root: new Decimal(1), 
        multiplicity: 2 
      },
      { 
        f: x => {
          const xd = new Decimal(x);
          return xd.pow(3).minus(new Decimal(2).times(xd)).plus(2);
        }, 
        df: x => {
          const xd = new Decimal(x);
          return new Decimal(3).times(xd.pow(2)).minus(2);
        }, 
        fStr: "x^3 - 2x + 2", 
        plotFn: "x^3 - 2*x + 2", 
        root: new Decimal(-1.769292354238631415240409), 
        multiplicity: 1 
      },
      { 
        f: x => {
          const xd = new Decimal(x);
          const inner = xd.sin().minus(xd).plus(1);
          return inner.pow(2);
        }, 
        df: x => {
          const xd = new Decimal(x);
          const inner = xd.sin().minus(xd).plus(1);
          const innerDeriv = xd.cos().minus(1);
          return new Decimal(2).times(inner).times(innerDeriv);
        }, 
        fStr: "(\\sin(x) - x + 1)^2", 
        plotFn: "(sin(x) - x + 1)^2", 
        root: new Decimal(1.934563210752024), 
        multiplicity: 2 
      },
      { 
        f: x => {
          const xd = new Decimal(x);
          const inner = xd.minus(2).exp().minus(1);
          return inner.pow(3);
        }, 
        df: x => {
          const xd = new Decimal(x);
          const inner = xd.minus(2).exp().minus(1);
          return new Decimal(3).times(inner.pow(2)).times(xd.minus(2).exp());
        }, 
        fStr: "(e^{x-2} - 1)^3", 
        plotFn: "(exp(x-2) - 1)^3", 
        root: new Decimal(2), 
        multiplicity: 3 
      }
    ];

    let currentFunction = functions[0];
    let iterations = [];
    let currentIteration = 0;
    let xMin = -2, xMax = 5;
    let yMin = -5, yMax = 10;
    const tangentColor = '#8B4513';
    let animationInterval = null;
    let isAnimating = false;
    let CONVERGENCE_TOLERANCE = new Decimal(1e-13);

    function scrollToTable() {
      const tableContainer = document.getElementById('iteration-table-container');
      tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function updateStatusDisplay() {
      if (iterations.length > 0) {
        const lastIter = iterations[iterations.length - 1];
        document.getElementById('current-iteration').textContent = lastIter.n;
        document.getElementById('current-error').textContent = formatDecimalScientific(lastIter.error, 2);
        document.getElementById('current-fx').textContent = formatDecimalScientific(lastIter.fx, 4);
      }
    }

    function updateFunctionButtons(selectedIndex) {
      const buttons = document.querySelectorAll('#function-buttons .function-button');
      buttons.forEach((button, index) => {
        if (index === selectedIndex) {
          button.classList.add('selected', 'bg-gray-800', 'text-white');
          button.classList.remove('bg-gray-50', 'text-gray-700', 'hover:bg-gray-100');
        } else {
          button.classList.remove('selected', 'bg-gray-800', 'text-white');
          button.classList.add('bg-gray-50', 'text-gray-700', 'hover:bg-gray-100');
        }
      });
    }

    function renderKaTeX() {
      renderMathInElement(document.body, {
        delimiters: [
          {left: "$$", right: "$$", display: true},
          {left: "\\[", right: "\\]", display: true},
          {left: "\\(", right: "\\)", display: false}
        ],
        throwOnError: false,
        output: 'html'
      });
    }

    function parseTolerance(value) {
      value = value.trim();
      if (value === '') return new Decimal(1e-13);
      
      try {
        const decimalValue = new Decimal(value);
        if (decimalValue.gt(0)) {
          return decimalValue;
        }
      } catch (e) {
        // If parsing fails, try to parse scientific notation manually
        const sciMatch = value.match(/^([0-9]+(?:\.[0-9]+)?)[eE]([+-]?[0-9]+)$/);
        if (sciMatch) {
          try {
            const coefficient = new Decimal(sciMatch[1]);
            const exponent = parseInt(sciMatch[2]);
            return coefficient.times(new Decimal(10).pow(exponent));
          } catch (e2) {
            // Fall through
          }
        }
      }
      
      return new Decimal(1e-13);
    }

    function init() {
      const modifiedCheckbox = document.getElementById('modifiedMethod');
      const speedSlider = document.getElementById('animation-speed');
      const speedDisplay = document.getElementById('speed-display');
      const toleranceInput = document.getElementById('convergence-tolerance');

      function updateSpeedDisplay() {
        speedDisplay.textContent = `${speedSlider.value} ms`;
      }

      function updateTolerance() {
        const value = toleranceInput.value;
        const parsed = parseTolerance(value);
        CONVERGENCE_TOLERANCE = parsed;
        if (value !== '' && value !== parsed.toString() && value !== parsed.toExponential()) {
          setTimeout(() => { toleranceInput.value = parsed.toExponential(); }, 100);
        }
        updateConvergenceMessage();
      }

      modifiedCheckbox.addEventListener('change', resetIterations);
      document.getElementById('x0').addEventListener('change', resetIterations);
      document.getElementById('multiplicity').addEventListener('change', resetIterations);
      speedSlider.addEventListener('input', updateSpeedDisplay);
      toleranceInput.addEventListener('blur', updateTolerance);
      toleranceInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          updateTolerance();
          toleranceInput.blur();
        }
      });

      updateFunctionButtons(0);
      resetIterations();
      updateSpeedDisplay();
      updateTolerance();
      renderKaTeX();
      drawGraph();
    }

    function selectFunction(index) {
      currentFunction = functions[index];
      const currentFunctionDiv = document.getElementById('current-function');
      currentFunctionDiv.innerHTML = `\\[ f(x) = ${currentFunction.fStr} \\]`;
      document.getElementById('multiplicity').value = currentFunction.multiplicity || 1;
      updateFunctionButtons(index);
      resetIterations();
      document.getElementById('modifiedMethod').checked = false;
      stopAnimation();
      renderKaTeX();
    }

    function getAbsoluteError(x) {
      const xd = new Decimal(x);
      return xd.minus(currentFunction.root).abs();
    }

    function hasConverged() {
      if (iterations.length === 0) return false;
      const lastError = iterations[iterations.length - 1].error;
      return lastError.lte(CONVERGENCE_TOLERANCE);
    }

    function updateConvergenceMessage() {
      const messageDiv = document.getElementById('converged-message');
      if (hasConverged() && iterations.length > 0) {
        const lastError = iterations[iterations.length - 1].error;
        const scientificNotation = lastError.toExponential(2);
        const toleranceScientific = CONVERGENCE_TOLERANCE.toExponential(2);
        const iterationCount = iterations.length - 1;
        messageDiv.innerHTML = `‚úì Convergence achieved after ${iterationCount} iterations! Absolute error = ${scientificNotation} ‚â§ ${toleranceScientific}`;
        messageDiv.classList.add('show');
      } else {
        messageDiv.classList.remove('show');
      }
    }

    function resetIterations() {
      stopAnimation();
      const x0Value = document.getElementById('x0').value;
      let x0;
      try {
        x0 = new Decimal(x0Value);
      } catch (e) {
        showError("Invalid initial guess");
        return;
      }
      
      const fx0 = currentFunction.f(x0);
      const dfx0 = currentFunction.df(x0);
      const error = getAbsoluteError(x0);
      
      iterations = [{
        n: 0,
        x: x0,
        fx: fx0,
        dfx: dfx0,
        error: error,
        prevRatioLinear: "-",
        prevRatioQuadratic: "-",
        ratioLinear: "-",
        ratioQuadratic: "-"
      }];
      currentIteration = 0;
      updateTable();
      updateConvergenceMessage();
      updateStatusDisplay();
      drawGraph();
    }

    function performIteration() {
      if (currentIteration >= 50) {
        showError("Maximum iterations (50) reached");
        stopAnimation();
        return;
      }
      if (hasConverged()) {
        stopAnimation();
        return;
      }
      const modified = document.getElementById('modifiedMethod').checked;
      let multiplicity = modified ? currentFunction.multiplicity || parseInt(document.getElementById('multiplicity').value) : 1;
      const lastIteration = iterations[iterations.length - 1];
      
      // Check if derivative is zero (or very close to zero)
      if (lastIteration.dfx.abs().lt(new Decimal(1e-30))) {
        showError("Newton's method failed: derivative is zero");
        stopAnimation();
        return;
      }
      
      // Perform Newton's method with high precision
      const m = new Decimal(multiplicity);
      const xNext = lastIteration.x.minus(m.times(lastIteration.fx).div(lastIteration.dfx));
      const fxNext = currentFunction.f(xNext);
      const dfxNext = currentFunction.df(xNext);
      const error = getAbsoluteError(xNext);
      
      let ratioLinear = "-";
      let ratioQuadratic = "-";
      if (iterations.length > 0) {
        const prevError = iterations[iterations.length - 1].error;
        if (prevError.gt(0)) {
          ratioLinear = error.div(prevError).toDecimalPlaces(10).toString();
          ratioQuadratic = error.div(prevError.pow(2)).toDecimalPlaces(10).toString();
        } else if (error.eq(0)) {
          ratioLinear = "0";
          ratioQuadratic = "0";
        }
      }
      
      iterations.push({
        n: iterations.length,
        x: xNext,
        fx: fxNext,
        dfx: dfxNext,
        error: error,
        prevRatioLinear: ratioLinear,
        prevRatioQuadratic: ratioQuadratic,
        ratioLinear: "-",
        ratioQuadratic: "-"
      });
      currentIteration++;
      updateTable();
      updateConvergenceMessage();
      updateStatusDisplay();
      drawGraph();
      if (hasConverged()) {
        stopAnimation();
        return;
      }
      if (currentIteration >= 50) {
        showError("Maximum iterations (50) reached");
        stopAnimation();
      }
    }

    function performIterationManual() {
      stopAnimation();
      performIteration();
    }

    function toggleAnimation() {
      if (isAnimating) {
        stopAnimation();
      } else {
        startAnimation();
      }
    }

    function startAnimation() {
      if (isAnimating) return;
      if (hasConverged()) {
        showError("Already converged! Reset to start animation.");
        return;
      }
      isAnimating = true;
      const animateBtn = document.getElementById('animate-btn');
      const stopBtn = document.getElementById('stop-btn');
      animateBtn.classList.add('running');
      animateBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');
      const speed = parseInt(document.getElementById('animation-speed').value);
      animationInterval = setInterval(() => {
        if (hasConverged()) {
          stopAnimation();
          return;
        }
        if (currentIteration >= 50) {
          stopAnimation();
          return;
        }
        performIteration();
      }, speed);
    }

    function stopAnimation() {
      if (!isAnimating) return;
      isAnimating = false;
      const animateBtn = document.getElementById('animate-btn');
      const stopBtn = document.getElementById('stop-btn');
      animateBtn.classList.remove('running');
      animateBtn.classList.remove('hidden');
      stopBtn.classList.add('hidden');
      if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
      }
    }

    function updateTable() {
      const tableBody = document.getElementById('iteration-data');
      tableBody.innerHTML = '';
      iterations.forEach((iter, index) => {
        const row = document.createElement('tr');
        const isConverged = iter.error.lte(CONVERGENCE_TOLERANCE);
        const isCurrent = index === iterations.length - 1;
        const isPrevious = index === iterations.length - 2;
        
        let bgColor = '';
        if (isConverged) bgColor = 'bg-green-50';
        else if (isCurrent) bgColor = 'active-iteration';
        else if (isPrevious) bgColor = 'iteration-highlight';
        
        // Convert Decimal values to numbers for display
        const xDisplay = formatDecimal(iter.x, 12);
        const fxDisplay = formatDecimalScientific(iter.fx, 8);
        const dfxDisplay = formatDecimalScientific(iter.dfx, 8);
        const errorDisplay = formatDecimalScientific(iter.error, 8);
        
        row.innerHTML = `
          <td class="border border-gray-300 px-3 py-2 ${bgColor} mono-font font-medium">${iter.n}</td>
          <td class="border border-gray-300 px-3 py-2 ${bgColor} mono-font text-sm">${xDisplay}</td>
          <td class="border border-gray-300 px-3 py-2 ${bgColor} mono-font text-sm">${fxDisplay}</td>
          <td class="border border-gray-300 px-3 py-2 ${bgColor} mono-font text-sm">${dfxDisplay}</td>
          <td class="border border-gray-300 px-3 py-2 ${bgColor} mono-font text-sm">${errorDisplay}</td>
          <td class="border border-gray-300 px-3 py-2 ${bgColor} ratio-col mono-font text-sm">${iter.prevRatioLinear}</td>
          <td class="border border-gray-300 px-3 py-2 ${bgColor} ratio-col mono-font text-sm">${iter.prevRatioQuadratic}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function calculateGraphBounds() {
      xMin = -2; xMax = 5;
      yMin = -5; yMax = 10;
      
      // Function-specific bounds
      if (currentFunction.fStr === "(\\sin(x) - x + 1)^2") {
        xMin = 0; xMax = 4; yMin = -0.5; yMax = 4;
      } else if (currentFunction.fStr === "(e^{x-2} - 1)^3") {
        xMin = 0; xMax = 4; yMin = -2; yMax = 2;
      }
      
      // Adjust bounds based on iterations
      if (iterations.length > 1) {
        const lastIter = iterations[iterations.length - 2];
        const currentIter = iterations[iterations.length - 1];
        
        // Convert Decimal to numbers for bounds calculation
        const lastX = decimalToNumber(lastIter.x);
        const currentX = decimalToNumber(currentIter.x);
        const rootX = decimalToNumber(currentFunction.root);
        const lastFx = decimalToNumber(lastIter.fx);
        
        const slope = decimalToNumber(lastIter.dfx);
        const intercept = lastFx - slope * lastX;
        
        // Calculate bounds that include all relevant points
        const xValues = [lastX, currentX, rootX];
        const xMinVal = Math.min(...xValues);
        const xMaxVal = Math.max(...xValues);
        
        // Add padding
        const xRange = xMaxVal - xMinVal;
        const xPadding = Math.max(xRange * 0.3, 0.5);
        
        xMin = Math.min(xMin, xMinVal - xPadding);
        xMax = Math.max(xMax, xMaxVal + xPadding);
        
        // Ensure reasonable limits
        xMin = Math.max(xMin, -10);
        xMax = Math.min(xMax, 10);
        yMin = Math.max(yMin, -15);
        yMax = Math.min(yMax, 15);
      }
    }

    function drawGraph() {
      calculateGraphBounds();
      const graphContainer = document.getElementById('graph');
      graphContainer.innerHTML = '';
      
      // Convert root to number for plotting
      const rootNumber = decimalToNumber(currentFunction.root);
      let rootScatter = { 
        points: [[rootNumber, 0]], 
        fnType: 'points', 
        graphType: 'scatter', 
        color: '#dc3545', 
        attr: { r: 8 } 
      };
      
      let tangentData = [];
      if (iterations.length > 1) {
        const iter = iterations[iterations.length - 2];
        const slope = decimalToNumber(iter.dfx);
        const intercept = decimalToNumber(iter.fx) - slope * decimalToNumber(iter.x);
        const tanFn = `${slope.toFixed(10)} * x + ${intercept.toFixed(10)}`;
        tangentData.push({ 
          fn: tanFn, 
          color: tangentColor, 
          sampler: 'builtIn', 
          graphType: 'polyline', 
          attr: { 'stroke-width': 2 } 
        });
      }
      
      let verticals = [];
      iterations.forEach((iter, index) => {
        if (index > 0) {
          const col = index === iterations.length - 1 ? '#dc3545' : '#6c757d';
          const xNum = decimalToNumber(iter.x);
          const fxNum = decimalToNumber(iter.fx);
          verticals.push({ 
            points: [[xNum, 0], [xNum, fxNum]], 
            fnType: 'points', 
            graphType: 'polyline', 
            color: col, 
            attr: { 'stroke-dasharray': '5 5', 'stroke-width': 1.5 } 
          });
        }
      });
      
      let prevPoints = iterations.slice(0, -1).map(iter => [decimalToNumber(iter.x), 0]);
      let prevScatter = { 
        points: prevPoints, 
        fnType: 'points', 
        graphType: 'scatter', 
        color: '#6c757d', 
        attr: { r: 5 } 
      };
      
      let lastScatter = null;
      if (iterations.length > 0) {
        const lastIter = iterations[iterations.length - 1];
        lastScatter = { 
          points: [[decimalToNumber(lastIter.x), 0]], 
          fnType: 'points', 
          graphType: 'scatter', 
          color: '#dc3545', 
          attr: { r: 6 } 
        };
      }
      
      let data = [
        { 
          fn: currentFunction.plotFn, 
          color: '#495057', 
          sampler: 'builtIn', 
          graphType: 'polyline', 
          nSamples: 400, 
          attr: { 'stroke-width': 3 } 
        },
        rootScatter
      ];
      
      data = data.concat(verticals);
      data = data.concat(tangentData);
      if (prevPoints.length > 0) { data.push(prevScatter); }
      if (lastScatter) { data.push(lastScatter); }
      
      try {
        functionPlot({
          target: '#graph',
          width: 1050,
          height: 500,
          xAxis: { domain: [xMin, xMax] },
          yAxis: { domain: [yMin, yMax] },
          grid: true,
          disableZoom: false,
          data: data,
          annotations: []
        });
        
        const graphElement = document.getElementById('graph');
        renderMathInElement(graphElement, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "\\(", right: "\\)", display: false}
          ],
          throwOnError: false,
          output: 'html'
        });
      } catch (e) {
        console.error('Graph rendering error:', e);
      }
    }

    function showError(message) {
      alert(message); // Simple alert for errors
    }

    function runSimpleRoot() {
      selectFunction(2);
      document.getElementById('x0').value = 3;
      document.getElementById('modifiedMethod').checked = false;
      document.getElementById('multiplicity').value = 1;
      document.getElementById('convergence-tolerance').value = '1e-13';
      resetIterations();
      startAnimation();
    }

    function runRepeatedNewton() {
      selectFunction(3);
      document.getElementById('x0').value = 3;
      document.getElementById('modifiedMethod').checked = false;
      document.getElementById('multiplicity').value = 2;
      document.getElementById('convergence-tolerance').value = '1e-13';
      resetIterations();
      startAnimation();
    }

    function runModifiedNewton() {
      selectFunction(3);
      document.getElementById('x0').value = 3;
      document.getElementById('modifiedMethod').checked = true;
      document.getElementById('multiplicity').value = 2;
      document.getElementById('convergence-tolerance').value = '1e-13';
      resetIterations();
      startAnimation();
    }

    function runNonConvergent() {
      selectFunction(2);
      document.getElementById('x0').value = 10;
      document.getElementById('modifiedMethod').checked = false;
      document.getElementById('multiplicity').value = 1;
      document.getElementById('convergence-tolerance').value = '1e-13';
      resetIterations();
      startAnimation();
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>



