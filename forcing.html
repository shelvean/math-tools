<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="description" content="Mass Spring Simulation with Forcing">
  <meta name="keywords" content="Mass, Spring, Spring Constant, Damping, System, Spring-Mass-Damper System, Second Order Differential Equations, Mechanical Systems, Simulation, Damping, Resonance, Beats, Simulation">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5B8PRB2WZT"></script>
  <script>
    function gtag(){dataLayer.push(arguments)}
    window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-5B8PRB2WZT")
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Spring-Mass-Damper System with Forcing</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <style>
    :root {
      --primary: #6c5ce7;
      --secondary: #4a47a3;
      --background: #f8f9fa;
      --surface: #e9ecef;
      --text: #212529;
      --accent: #00b4d8;
      --wood: #8B4513;
      --metal: #A0A0A0;
      --green: #28a745;
      --dark-blue: #2b2d6f;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 30px;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      justify-content: center;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    .main-container {
      max-width: 1500px;
      width: 100%;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 1.5rem;
      color: black;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .general-equation {
      text-align: center;
      margin: 1.5rem 0;
      font-size: 1.4rem;
    }
    .content-wrapper {
      display: flex;
      flex-wrap: nowrap;
      gap: 20px;
      justify-content: center;
      width: 100%;
      max-width: 100%;
      align-items: flex-start;
    }
    .controls-wrapper {
      flex: 0 0 350px;
      min-width: 250px;
      max-width: 350px;
    }
    .button-container {
      flex: 0 0 200px;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      width: 200px;
      margin: 0 5px;
    }
    .button-container h3 {
      color: var(--dark-blue);
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .center-column {
      flex: 0 0 500px;
    }
    .right-column {
      flex: 0 0 350px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .right-column h2 {
      color: var(--secondary);
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    .right-column p {
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    .right-column strong {
      font-weight: bold;
      color: #000;
    }
    .inline-equation {
      font-size: 0.95em;
    }
    .controls {
      width: 100%;
      padding: 0.8rem;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    canvas {
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 2px solid var(--surface);
      background: white;
    }
    #simulationCanvas {
      width: 500px;
      height: 600px;
      max-width: 100%;
    }
    .controls input {
      width: 40px;
      padding: 0.3rem;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background: white;
      color: var(--text);
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }
    .controls input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--primary);
      background: rgba(255,255,255,0.15);
    }
    .controls label {
      color: var(--secondary);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
    }
    .controls input[type="range"] {
      width: 100%;
      margin: 5px 0;
    }
    button {
      padding: 0.5rem 0.2rem;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.8rem;
    }
    button:hover {
      background: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
    }
    .green-button {
      background: var(--green);
      padding: 0.4rem 0.2rem;
      font-size: 0.7rem;
      text-transform: none;
    }
    .green-button:hover {
      background: #218838;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    #equation {
      font-size: 1em;
      margin: 0.5rem 0;
      padding: 0.5rem;
      background: rgba(233,236,239,0.6);
      color: var(--primary);
      border-radius: 8px;
      font-family: monospace;
      text-align: center;
    }
    .graph-container {
      width: 100%;
      background: white;
      border: 1px solid var(--surface);
      border-radius: 16px;
      padding: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }
    .graph-container h2 {
      color: var(--secondary);
      margin-bottom: 1rem;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .footer {
      margin-top: 20px;
      padding: 10px 0;
      text-align: center;
      color: var(--text);
      font-size: 0.8rem;
      border-top: 1px solid var(--surface);
      width: 100%;
    }
    nav a {
      color: var(--text);
      text-decoration: none;
    }
    nav a:hover {
      color: var(--primary);
    }
    .control-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .slider-container {
      flex: 1;
      margin-left: 10px;
    }
    .slider-container input {
      width: 100%;
    }
    #forcingFunction {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    @media (max-width: 1300px) {
      .content-wrapper {
        flex-wrap: wrap;
        gap: 30px;
      }
      .controls-wrapper {
        flex: 1;
        max-width: 350px;
      }
      .button-container {
        flex: 1;
        max-width: 200px;
      }
      .center-column {
        flex: 0 0 auto;
        max-width: 500px;
      }
      .right-column {
        flex: 1;
        max-width: 350px;
      }
    }
    @media (max-width: 1024px) {
      .content-wrapper {
        flex-direction: column;
        align-items: center;
        gap: 40px;
      }
      .controls-wrapper, .button-container, .center-column, .right-column {
        width: 100%;
        max-width: 100%;
      }
      #simulationCanvas {
        height: auto;
        aspect-ratio: 5 / 6;
      }
    }
    nav a {
    font-size: 1.5 rem;
    font-weight: semibold;
}
  </style>
</head>
<body>
  <div class="main-container">
    <nav class="flex justify-center mb-4">
      <a href="index.html" class="font-bold text-xl mx-4" style="color: var(--primary);">Home</a>
      <a href="teaching.html" class="font-bold text-xl mx-4" style="color: var(--primary);">Teaching</a>
      <a href="projects.html" class="font-bold text-xl mx-4" style="color: var(--primary);">Diff Eq</a>
      <a href="linear.html" class="font-bold text-xl mx-4" style="color: var(--primary);">Linear Algebra</a>
      <a href="numerical.html" class="font-bold text-xl mx-4" style="color: var(--primary);">Numerical Methods</a>
    </nav>
    <h1>Mass Spring System with an External Force</h1>
    <!--<div class="general-equation" id="equationGeneral"></div> -->
    <p id="equation"></p>
    <div class="content-wrapper">
      <div class="controls-wrapper">
        <div class="controls">
          <div class="control-group">
            <label for="mass">Mass (<span class="katex">m</span>) [kg]:</label>
            <div class="slider-container">
              <input type="range" id="massSlider" min="0.1" max="20" step="0.1" value="1">
            </div>
            <input type="number" id="mass" value="1" step="0.1" min="0.1">
          </div>
          <div class="control-group">
            <label for="damping">Damping (<span class="katex">c</span>) [N·s/m]:</label>
            <div class="slider-container">
              <input type="range" id="dampingSlider" min="0" max="10" step="0.1" value="0.3">
            </div>
            <input type="number" id="damping" value="0.3" step="0.1">
          </div>
          <div class="control-group">
            <label for="springConstant">Spring Constant (<span class="katex">k</span>) [N/m]:</label>
            <div class="slider-container">
              <input type="range" id="springConstantSlider" min="1" max="100" step="1" value="4">
            </div>
            <input type="number" id="springConstant" value="4" step="1">
          </div>
          <div class="control-group">
            <label for="initialDisplacement">Initial Displacement (<span class="katex">y_0</span>) [m]:</label>
            <div class="slider-container">
              <input type="range" id="initialDisplacementSlider" min="-2" max="2" step="0.05" value="0">
            </div>
            <input type="number" id="initialDisplacement" value="0" step="0.05">
          </div>
          <div class="control-group">
            <label for="initialVelocity">Initial Velocity (<span class="katex">v_0</span>) [m/s]:</label>
            <div class="slider-container">
              <input type="range" id="initialVelocitySlider" min="-5" max="5" step="0.1" value="0">
            </div>
            <input type="number" id="initialVelocity" value="0" step="0.1">
          </div>
          <div class="control-group">
            <label for="endTime">End Time (<span class="katex">T</span>) [s]:</label>
            <div class="slider-container">
              <input type="range" id="endTimeSlider" min="10" max="200" step="1" value="60">
            </div>
            <input type="number" id="endTime" value="60" step="1" min="10" max="200">
          </div>
          <label for="forcingFunction">Forcing Function <span class="katex">F(t)</span>:</label>
          <input type="text" id="forcingFunction" value="5*delta(t-10)+u(t-35)*cos(2*(t-35))" placeholder="e.g., 3*cos(3*t) or delta(t-10) or u(t-5)">
          <button onclick="resetSimulation()">Reset Simulation</button>
          <button onclick="togglePause()" id="pauseButton">Pause</button>
        </div>
        <div class="graph-container">
          <h2>Displacement (<span class="katex">y</span>) vs Time (<span class="katex">t</span>)</h2>
          <canvas id="graphCanvas" width="350" height="200"></canvas>
        </div>
      </div>
      <div class="button-container">
        <h3>Examples</h3>
        <button class="green-button" onclick="setUnderdamped()">Underdamped</button>
        <button class="green-button" onclick="setCriticallyDamped()">Critically Damped</button>
        <button class="green-button" onclick="setOverdamped()">Overdamped</button>
        <button class="green-button" onclick="setDeltaImpulse()">&delta; impulse (Dirac Delta)</button>
        <button class="green-button" onclick="setTransientsSteady()">steady state</button>
        <button class="green-button" onclick="setDelayedResponse()">delayed (Heaviside)</button>
        <button class="green-button" onclick="setResonanceDamped()">resonance (damped)</button>
        <button class="green-button" onclick="setResonanceUndamped()">resonance (undamped)</button>
        <button class="green-button" onclick="setBeats()">beats</button>
      </div>
      <div class="center-column">
        <canvas id="simulationCanvas" width="500" height="600"></canvas>
      </div>
      <div class="right-column">
        <h2>About This Simulation</h2>
        <p>This interactive tool visualizes the motion of a mass-spring-damper system with external forcing governed by the second-order differential equation <span class="katex inline-equation">m \ddot{y} + c \dot{y} + k y = F(t)</span>.</p>
        <p>Adjust parameters <span class="katex">m</span>, <span class="katex">c</span>, <span class="katex">k</span>, initial conditions <span class="katex">y_0</span>, <span class="katex">v_0</span>, and the forcing function <span class="katex">F(t)</span> to observe behaviors such as transients, steady-state response, resonance, and beats.</p>
        <p><strong>Definitions:</strong> <span class="katex">\delta(t-c)</span> is the Dirac delta function at <span class="katex">t=c</span>, modeling an instantaneous impulse. <span class="katex">u(t-c)</span> (or Heaviside step function) is 0 for <span class="katex">t < c</span> and 1 for <span class="katex">t \geq c</span>.</p>
        <p><strong>Impulse handling:</strong> When <span class="katex">t</span> is within <span class="katex">\Delta t / 2</span> of a delta function time <span class="katex">t=c</span>, the velocity is instantly increased by <span class="katex">\Delta v = A / m</span>, where <span class="katex">A</span> is the amplitude of the impulse <span class="katex">F(t) = A \delta(t-c)</span>.</p>
        <p><strong>Numerical methods:</strong> The simulation employs adaptive integration. For most cases, it uses the <strong>velocity Verlet</strong> method, which conserves energy well in undamped systems. For stiff systems (high damping or high frequency), it switches to implicit methods: <strong>backward Euler</strong> for the first step and <strong>BDF-2</strong> thereafter. The forcing term <span class="katex">F(t)</span> is incorporated appropriately in each integrator. Dirac delta impulses are handled separately by direct velocity update.</p>
      </div>
    </div>
    <div class="footer">
      &copy; 2025 Shelvean Kapita: kapita@tamu.edu<br>
      All code released under the <a href="https://opensource.org/licenses/MIT">MIT License</a>.<br>
      Last modified: December 20, 2025
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script>
    const canvas = document.getElementById('simulationCanvas');
    const ctx = canvas.getContext('2d');
    const graphCanvas = document.getElementById('graphCanvas');
    const graphCtx = graphCanvas.getContext('2d');
    // Simulation parameters
    let m = 1; // Mass (kg)
    let k = 4; // Spring constant (N/m)
    let c = 0.2; // Damping coefficient (N·s/m)
    let y0 = 0; // Initial displacement (m)
    let v0 = 0; // Initial velocity (m/s)
    let g = 9.81; // Gravity (m/s²)
    let graphMaxTime = 60; // End time in seconds (now adjustable)
    // Simulation state
    let y = y0;
    let v = v0;
    let t = 0;
    const dt = 0.01; // Time step (seconds)
    let isSimulationRunning = true;
    let isPaused = false;
    const graphData = [];
    const STIFF_THRESHOLD = 5; // Threshold for stiffness
    let firstStep = true;
    let prevState = null;
    let currentState = null;
    const stepsPerFrame = 10; // Number of steps per frame to speed up animation
    // Spring visualization parameters
    const springLength = 200;
    const springCoils = 8; // Number of coils
    const springRadius = 15;
    const ballRadius = 20;
    const canvasCenterX = canvas.width / 2;
    // Forcing function related
    let forcingFunction = "5*delta(t-10)+u(t-35)*cos(2*(t-35))";
    let alertBox = null;
    function setupInputLinks() {
      document.getElementById('massSlider').addEventListener('input', function() {
        document.getElementById('mass').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('mass').addEventListener('input', function() {
        document.getElementById('massSlider').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('springConstantSlider').addEventListener('input', function() {
        document.getElementById('springConstant').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('springConstant').addEventListener('input', function() {
        document.getElementById('springConstantSlider').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('dampingSlider').addEventListener('input', function() {
        document.getElementById('damping').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('damping').addEventListener('input', function() {
        document.getElementById('dampingSlider').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('initialDisplacementSlider').addEventListener('input', function() {
        document.getElementById('initialDisplacement').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('initialDisplacement').addEventListener('input', function() {
        document.getElementById('initialDisplacementSlider').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('initialVelocitySlider').addEventListener('input', function() {
        document.getElementById('initialVelocity').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('initialVelocity').addEventListener('input', function() {
        document.getElementById('initialVelocitySlider').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('endTimeSlider').addEventListener('input', function() {
        document.getElementById('endTime').value = this.value;
        updateSimulationParameters();
      });
      document.getElementById('endTime').addEventListener('input', function() {
        document.getElementById('endTimeSlider').value = this.value;
        updateSimulationParameters();
      });
    }
    function updateSimulationParameters() {
      m = parseFloat(document.getElementById('mass').value) || 1;
      k = parseFloat(document.getElementById('springConstant').value) || 4;
      const userC = parseFloat(document.getElementById('damping').value) || 0;
      c = (userC === 0) ? 0.000001 : userC;
      y0 = parseFloat(document.getElementById('initialDisplacement').value) || 0;
      v0 = parseFloat(document.getElementById('initialVelocity').value) || 0;
      forcingFunction = document.getElementById('forcingFunction').value;
      graphMaxTime = parseFloat(document.getElementById('endTime').value) || 60;
      const equationElement = document.getElementById('equation');
      if (equationElement) {
        try {
          let displayForcing = forcingFunction
            .replace(/u\(t(?:\s*-\s*([\d.]+))?\)/gi, (match, a) => a ? `u_{${a}}(t)` : `u(t)`)
            .replace(/heaviside\(t(?:\s*-\s*([\d.]+))?\)/gi, (match, a) => a ? `u_{${a}}(t)` : `u(t)`)
            .replace(/delta/gi, '\\delta')
            .replace(/\*/g, ' \\cdot ')
            .replace(/(cos|sin|tan|exp|log|sqrt)/g, '\\$1');
          katex.render(`${m.toFixed(1)}\\ddot{y} + ${userC.toFixed(1)}\\dot{y} + ${k.toFixed(1)}y = ${displayForcing}`, equationElement, { throwOnError: false });
        } catch (error) {
          console.error('KaTeX error:', error);
          equationElement.textContent = `${m.toFixed(1)}\\ddot{y} + ${userC.toFixed(1)}\\dot{y} + ${k.toFixed(1)}y = ${forcingFunction}`;
        }
      }
    }
    function calculateDiscriminant(c_calc) {
      return c_calc * c_calc - 4 * m * k;
    }
    function isStiffSystem(c_calc) {
      const discriminant = calculateDiscriminant(c_calc);
      return discriminant > STIFF_THRESHOLD && discriminant > 0;
    }
    function backwardEulerStep(state, dt, m, c, k) {
      const [y, v] = state;
      const F = evaluateForcingFunction(y, t + dt);
      const h = dt;
      const den = 1 + (c / m) * h + (k / m) * h * h;
      const nextY = (y * (1 + (c / m) * h) + h * v + (F * h * h) / m) / den;
      const nextV = (nextY - y) / h;
      return [nextY, nextV];
    }
    function bdf2Step(prevState, currentState, dt, m, c, k) {
      const [y_prev, v_prev] = prevState;
      const [y_curr, v_curr] = currentState;
      const F = evaluateForcingFunction(y_curr, t + dt);
      const h = dt;
      const b1 = 4 * y_curr - y_prev + (2 * h * h * F) / m;
      const b2 = 4 * v_curr - v_prev;
      const a11 = 3;
      const a12 = -2 * h;
      const a21 = (2 * h * k) / m;
      const a22 = 3 + (2 * h * c) / m;
      const det = a11 * a22 - a12 * a21;
      const y_next = (a22 * b1 - a12 * b2) / det;
      const v_next = (a11 * b2 - a21 * b1) / det;
      return [y_next, v_next];
    }
    function updatePhysicsVerletStormer(c_calc) {
      const F = evaluateForcingFunction(y, t);
      const a = (-c_calc * v - k * y + F) / m;
      const nextY = y + v * dt + 0.5 * a * dt * dt;
      const nextF = evaluateForcingFunction(nextY, t + dt);
      const nextA = (-c_calc * v - k * nextY + nextF) / m;
      const nextV = v + 0.5 * (a + nextA) * dt;
      y = isNaN(nextY) ? y : nextY;
      v = isNaN(nextV) ? v : nextV;
    }
    function applyDeltaImpulse() {
      const matches = forcingFunction.match(/(?:(\d*\.?\d*)\*)?delta\(t(?:-([\d.]+))?\)/gi);
      if (matches) {
        for (const match of matches) {
          const [, amplitudeStr, timeStr] = match.match(/(?:(\d*\.?\d*)\*)?delta\(t(?:-([\d.]+))?\)/i) || [null, "1", "0"];
          const deltaTime = parseFloat(timeStr) || 0;
          const deltaAmplitude = parseFloat(amplitudeStr) || 1;
          if (Math.abs(t - deltaTime) < dt / 2) {
            v += deltaAmplitude / m;
            return true;
          }
        }
      }
      return false;
    }
    function updatePhysics() {
      if (!isSimulationRunning || isPaused) return;
      const c_calc = (c === 0) ? 0.0000001 : c;
      const impulseApplied = applyDeltaImpulse();
      if (!impulseApplied) {
        if (isStiffSystem(c_calc)) {
          if (firstStep) {
            const nextState = backwardEulerStep(currentState, dt, m, c_calc, k);
            prevState = currentState;
            currentState = nextState;
            firstStep = false;
          } else {
            const nextState = bdf2Step(prevState, currentState, dt, m, c_calc, k);
            prevState = currentState;
            currentState = nextState;
          }
          y = currentState[0];
          v = currentState[1];
        } else {
          updatePhysicsVerletStormer(c_calc);
        }
      }
      t += dt;
      if (y > 4 || y < -2.7) {
        isSimulationRunning = false;
        showAlert("Displacement has exceeded the maximum.");
      }
    }
    function evaluateForcingFunction(y, t) {
      let F = 0;
      const func = document.getElementById('forcingFunction').value;
      try {
        let safeFunc = func
          .replace(/delta\(t\)/g, 'delta(t-0)')
          .replace(/u\(t\)/g, 'u(t-0)')
          .replace(/heaviside\(t\)/g, 'heaviside(t-0)')
          .replace(/delta\(t-[\d.-]+\)/gi, '0')
          .replace(/u\(t-([\d.-]+)\)/gi, (match, a) => {
            const heavisideTime = parseFloat(a);
            return t >= heavisideTime ? "1" : "0";
          })
          .replace(/heaviside\(t-([\d.-]+)\)/gi, (match, a) => {
            const heavisideTime = parseFloat(a);
            return t >= heavisideTime ? "1" : "0";
          })
          .replace(/([a-zA-Z]+)(?=\()/g, 'Math.$1')
          .replace(/(\d)(\()/g, '$1*$2')
          .replace(/(\))(\d)/g, '$1*$2')
          .replace(/([a-zA-Z])(\d)/g, '$1*$2')
          .replace(/(\d)([a-zA-Z])/g, '$1*$2');
        F = new Function('t', 'y', `return ${safeFunc}`)(t, y);
      } catch (e) {
        console.error('Error evaluating forcing function:', e);
        F = 0;
      }
      return F;
    }
    function drawHelicalSpring(startY, endY) {
      const totalLength = endY - startY;
      const coils = springCoils;
      const radius = springRadius;
      ctx.save();
      const points = [];
      const segmentsPerCoil = 20;
      for (let i = 0; i <= coils * segmentsPerCoil; i++) {
        const progress = i / (coils * segmentsPerCoil);
        const yPos = startY + progress * totalLength;
        const angle = progress * Math.PI * 2 * coils;
        const x = canvasCenterX + radius * Math.cos(angle);
        const y = yPos;
        points.push({x, y});
      }
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      for (let i = 0; i < points.length; i++) {
        if (i === 0) ctx.moveTo(points[i].x + 2, points[i].y + 2);
        else ctx.lineTo(points[i].x + 2, points[i].y + 2);
      }
      ctx.stroke();
      ctx.beginPath();
      ctx.strokeStyle = '#181b59';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      for (let i = 0; i < points.length; i++) {
        if (i === 0) ctx.moveTo(points[i].x, points[i].y);
        else ctx.lineTo(points[i].x, points[i].y);
      }
      ctx.stroke();
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
      ctx.lineWidth = 1;
      for (let i = 0; i < points.length; i++) {
        const angle = (i / (coils * segmentsPerCoil)) * Math.PI * 2 * coils;
        if (Math.cos(angle) > 0) {
          if (i === 0 || Math.cos(((i-1) / (coils * segmentsPerCoil)) * Math.PI * 2 * coils) <= 0) {
            ctx.moveTo(points[i].x - 1, points[i].y - 1);
          } else {
            ctx.lineTo(points[i].x - 1, points[i].y - 1);
          }
        }
      }
      ctx.stroke();
      ctx.restore();
    }
    function drawRealisticMass(massY) {
      const sideLength = ballRadius * 2;
      const x = canvasCenterX - ballRadius;
      const y = massY - ballRadius;
      ctx.save();
      ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
      ctx.shadowBlur = 10;
      ctx.shadowOffsetY = 5;
      const gradient = ctx.createLinearGradient(x, y, x, y + sideLength);
      gradient.addColorStop(0, '#A0522D');
      gradient.addColorStop(0.5, '#8B4513');
      gradient.addColorStop(1, '#654321');
      ctx.fillStyle = gradient;
      ctx.fillRect(x, y, sideLength, sideLength);
      ctx.strokeStyle = '#5D4037';
      ctx.lineWidth = 2;
      ctx.strokeRect(x, y, sideLength, sideLength);
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(x + 5, y + 5);
      ctx.lineTo(x + sideLength - 5, y + 5);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x + 5, y + sideLength - 5);
      ctx.lineTo(x + sideLength - 5, y + sideLength - 5);
      ctx.stroke();
      ctx.restore();
    }
    function drawRealisticSupport() {
      const supportWidth = 120;
      const supportHeight = 40;
      const supportX = canvasCenterX - supportWidth / 2;
      const supportY = 20;
      ctx.save();
      ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
      ctx.shadowBlur = 10;
      ctx.shadowOffsetY = 5;
      const gradient = ctx.createLinearGradient(supportX, supportY, supportX, supportY + supportHeight);
      gradient.addColorStop(0, '#B0B0B0');
      gradient.addColorStop(0.5, '#909090');
      gradient.addColorStop(1, '#707070');
      ctx.fillStyle = gradient;
      ctx.fillRect(supportX, supportY, supportWidth, supportHeight);
      ctx.strokeStyle = '#606060';
      ctx.lineWidth = 2;
      ctx.strokeRect(supportX, supportY, supportWidth, supportHeight);
      ctx.fillStyle = '#404040';
      for (let i = 0; i < 3; i++) {
        const holeX = supportX + 20 + i * 40;
        const holeY = supportY + supportHeight / 2;
        ctx.beginPath();
        ctx.arc(holeX, holeY, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#505050';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(holeX - 3, holeY);
        ctx.lineTo(holeX + 3, holeY);
        ctx.moveTo(holeX, holeY - 3);
        ctx.lineTo(holeX, holeY + 3);
        ctx.stroke();
      }
      ctx.restore();
      ctx.fillStyle = '#303030';
      ctx.beginPath();
      ctx.arc(canvasCenterX, supportY + supportHeight, 5, 0, Math.PI * 2);
      ctx.fill();
    }
    function drawSpringMass() {
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#E3F2FD');
      gradient.addColorStop(1, '#BBDEFB');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#795548';
      ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
      ctx.strokeStyle = '#6D4C41';
      ctx.lineWidth = 2;
      for (let i = 0; i < canvas.width; i += 20) {
        ctx.beginPath();
        ctx.moveTo(i, canvas.height - 50);
        ctx.lineTo(i, canvas.height);
        ctx.stroke();
      }
      drawRealisticSupport();
      const supportBottom = 20 + 40;
      const displacement = y * 80;
      const springEnd = supportBottom + springLength + displacement;
      drawHelicalSpring(supportBottom, springEnd);
      drawRealisticMass(springEnd);
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(50, supportBottom + springLength);
      ctx.lineTo(canvas.width - 50, supportBottom + springLength);
      ctx.stroke();
      ctx.setLineDash([]);
    }
    function drawGraph() {
      graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
      const gradient = graphCtx.createLinearGradient(0, 0, 0, graphCanvas.height);
      gradient.addColorStop(0, '#f8f9fa');
      gradient.addColorStop(1, '#e9ecef');
      graphCtx.fillStyle = gradient;
      graphCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);
      graphCtx.strokeStyle = '#ddd';
      graphCtx.lineWidth = 0.5;
      for (let i = 1; i < 7; i++) {
        const x = 50 + (i * (graphCanvas.width - 70)) / 6;
        graphCtx.beginPath();
        graphCtx.moveTo(x, 20);
        graphCtx.lineTo(x, graphCanvas.height - 20);
        graphCtx.stroke();
      }
      for (let i = 1; i < 5; i++) {
        const y = 20 + (i * (graphCanvas.height - 40)) / 4;
        graphCtx.beginPath();
        graphCtx.moveTo(50, y);
        graphCtx.lineTo(graphCanvas.width - 20, y);
        graphCtx.stroke();
      }
      graphCtx.beginPath();
      graphCtx.moveTo(50, 20);
      graphCtx.lineTo(50, graphCanvas.height - 20);
      graphCtx.lineTo(graphCanvas.width - 20, graphCanvas.height - 20);
      graphCtx.strokeStyle = '#333';
      graphCtx.lineWidth = 2;
      graphCtx.stroke();
      if (graphData.length === 0) return;
      const maxY = Math.max(...graphData.map(d => d.y));
      const minY = Math.min(...graphData.map(d => d.y));
      const yRange = maxY - minY || 0.1;
      const scaleY = (graphCanvas.height - 60) / yRange;
      const lineGradient = graphCtx.createLinearGradient(0, 0, graphCanvas.width, 0);
      lineGradient.addColorStop(0, '#6c5ce7');
      lineGradient.addColorStop(1, '#00b4d8');
      graphCtx.beginPath();
      graphCtx.strokeStyle = lineGradient;
      graphCtx.lineWidth = 2;
      for (let i = 0; i < graphData.length; i++) {
        const point = graphData[i];
        const x = 50 + (point.t / graphMaxTime) * (graphCanvas.width - 70);
        const y = graphCanvas.height - 40 - (point.y - minY) * scaleY;
        if (i === 0) graphCtx.moveTo(x, y);
        else graphCtx.lineTo(x, y);
      }
      graphCtx.stroke();
      drawDisplacementScaleOnGraph(scaleY, maxY, minY);
      drawTimeScaleOnGraph();
    }
    function drawDisplacementScaleOnGraph(scaleY, maxY, minY) {
      graphCtx.strokeStyle = '#000';
      graphCtx.fillStyle = '#000';
      graphCtx.font = '10px Arial';
      graphCtx.textAlign = 'right';
      graphCtx.textBaseline = 'middle';
      const marks = 5;
      const yStep = (maxY - minY) / marks;
      for (let i = 0; i <= marks; i++) {
        const yVal = minY + i * yStep;
        const yPos = graphCanvas.height - 40 - (yVal - minY) * scaleY;
        graphCtx.beginPath();
        graphCtx.moveTo(50, yPos);
        graphCtx.lineTo(40, yPos);
        graphCtx.stroke();
        graphCtx.fillText(yVal.toFixed(2), 38, yPos);
      }
    }
    function drawTimeScaleOnGraph() {
      graphCtx.strokeStyle = '#000';
      graphCtx.fillStyle = '#000';
      graphCtx.font = '10px Arial';
      graphCtx.textAlign = 'center';
      graphCtx.textBaseline = 'top';
      const marks = 7;
      const step = (graphCanvas.width - 70) / (marks - 1);
      for (let i = 0; i < marks; i++) {
        const xPos = 50 + i * step;
        const value = (i * graphMaxTime) / (marks - 1);
        graphCtx.beginPath();
        graphCtx.moveTo(xPos, graphCanvas.height - 20);
        graphCtx.lineTo(xPos, graphCanvas.height - 10);
        graphCtx.stroke();
        graphCtx.fillText(value.toFixed(1), xPos, graphCanvas.height - 8);
      }
    }
    function showAlert(message) {
      if (!alertBox) {
        alertBox = document.createElement('div');
        alertBox.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; padding: 10px 20px; border-radius: 5px; z-index: 1000;`;
        const closeButton = document.createElement('button');
        closeButton.textContent = 'X';
        closeButton.style.cssText = `float: right; background: transparent; border: none; font-size: 16px; cursor: pointer; color: #721c24;`;
        closeButton.onclick = hideAlert;
        alertBox.appendChild(closeButton);
        alertBox.appendChild(document.createTextNode(message));
        document.body.appendChild(alertBox);
      }
    }
    function hideAlert() {
      if (alertBox) {
        document.body.removeChild(alertBox);
        alertBox = null;
      }
    }
    function togglePause() {
      isPaused = !isPaused;
      document.getElementById('pauseButton').textContent = isPaused ? 'Resume' : 'Pause';
    }
    function setUnderdamped() {
      document.getElementById('mass').value = 1;
      document.getElementById('massSlider').value = 1;
      document.getElementById('springConstant').value = 9;
      document.getElementById('springConstantSlider').value = 9;
      document.getElementById('damping').value = 0.1;
      document.getElementById('dampingSlider').value = 0.1;
      document.getElementById('initialDisplacement').value = 2;
      document.getElementById('initialDisplacementSlider').value = 2;
      document.getElementById('initialVelocity').value = 0;
      document.getElementById('initialVelocitySlider').value = 0;
      document.getElementById('forcingFunction').value = '0';
      resetSimulation();
    }
    function setCriticallyDamped() {
      document.getElementById('mass').value = 1;
      document.getElementById('massSlider').value = 1;
      document.getElementById('springConstant').value = 1;
      document.getElementById('springConstantSlider').value = 1;
      document.getElementById('damping').value = 2;
      document.getElementById('dampingSlider').value = 2;
      document.getElementById('initialDisplacement').value = 4;
      document.getElementById('initialDisplacementSlider').value = 4;
      document.getElementById('initialVelocity').value = 0;
      document.getElementById('initialVelocitySlider').value = 0;
      document.getElementById('forcingFunction').value = '0';
      resetSimulation();
    }
    function setOverdamped() {
      document.getElementById('mass').value = 1;
      document.getElementById('massSlider').value = 1;
      document.getElementById('springConstant').value = 9;
      document.getElementById('springConstantSlider').value = 9;
      document.getElementById('damping').value = 50;
      document.getElementById('dampingSlider').value = 50;
      document.getElementById('initialDisplacement').value = 4;
      document.getElementById('initialDisplacementSlider').value = 4;
      document.getElementById('initialVelocity').value = 0;
      document.getElementById('initialVelocitySlider').value = 0;
      document.getElementById('forcingFunction').value = '0';
      resetSimulation();
    }
    function setDeltaImpulse() {
      document.getElementById('mass').value = 1;
      document.getElementById('massSlider').value = 1;
      document.getElementById('springConstant').value = 4;
      document.getElementById('springConstantSlider').value = 4;
      document.getElementById('damping').value = 0;
      document.getElementById('dampingSlider').value = 0;
      document.getElementById('initialDisplacement').value = 0;
      document.getElementById('initialDisplacementSlider').value = 0;
      document.getElementById('initialVelocity').value = 0;
      document.getElementById('initialVelocitySlider').value = 0;
      document.getElementById('forcingFunction').value = '2*delta(t-10)';
      resetSimulation();
    }
    function setTransientsSteady() {
      document.getElementById('mass').value = 1;
      document.getElementById('massSlider').value = 1;
      document.getElementById('springConstant').value = 81;
      document.getElementById('springConstantSlider').value = 81;
      document.getElementById('damping').value = 0.2;
      document.getElementById('dampingSlider').value = 0.2;
      document.getElementById('initialDisplacement').value = 0;
      document.getElementById('initialDisplacementSlider').value = 0;
      document.getElementById('initialVelocity').value = 0;
      document.getElementById('initialVelocitySlider').value = 0;
      document.getElementById('forcingFunction').value = '100*cos(2.5*t)';
      resetSimulation();
    }
    function setDelayedResponse() {
      document.getElementById('mass').value = 1;
      document.getElementById('massSlider').value = 1;
      document.getElementById('springConstant').value = 81;
      document.getElementById('springConstantSlider').value = 81;
      document.getElementById('damping').value = 0.2;
      document.getElementById('dampingSlider').value = 0.2;
      document.getElementById('initialDisplacement').value = 0;
      document.getElementById('initialDisplacementSlider').value = 0;
      document.getElementById('initialVelocity').value = 0;
      document.getElementById('initialVelocitySlider').value = 0;
      document.getElementById('forcingFunction').value = '100*cos(2.5*(t-10))*u(t-10)';
      resetSimulation();
    }
    function setResonanceDamped() {
      document.getElementById('mass').value = 1;
      document.getElementById('massSlider').value = 1;
      document.getElementById('springConstant').value = 9;
      document.getElementById('springConstantSlider').value = 9;
      document.getElementById('damping').value = 0.7;
      document.getElementById('dampingSlider').value = 0.7;
      document.getElementById('initialDisplacement').value = 0;
      document.getElementById('initialDisplacementSlider').value = 0;
      document.getElementById('initialVelocity').value = 0;
      document.getElementById('initialVelocitySlider').value = 0;
      document.getElementById('forcingFunction').value = '5*cos(2.98*t)';
      resetSimulation();
    }
    function setResonanceUndamped() {
      document.getElementById('mass').value = 1;
      document.getElementById('massSlider').value = 1;
      document.getElementById('springConstant').value = 9;
      document.getElementById('springConstantSlider').value = 9;
      document.getElementById('damping').value = 0;
      document.getElementById('dampingSlider').value = 0;
      document.getElementById('initialDisplacement').value = 0;
      document.getElementById('initialDisplacementSlider').value = 0;
      document.getElementById('initialVelocity').value = 0;
      document.getElementById('initialVelocitySlider').value = 0;
      document.getElementById('forcingFunction').value = '0.25*cos(3*t)';
      resetSimulation();
    }
    function setBeats() {
      document.getElementById('mass').value = 4;
      document.getElementById('massSlider').value = 4;
      document.getElementById('springConstant').value = 36;
      document.getElementById('springConstantSlider').value = 36;
      document.getElementById('damping').value = 0;
      document.getElementById('dampingSlider').value = 0;
      document.getElementById('initialDisplacement').value = 0;
      document.getElementById('initialDisplacementSlider').value = 0;
      document.getElementById('initialVelocity').value = 0;
      document.getElementById('initialVelocitySlider').value = 0;
      document.getElementById('forcingFunction').value = '10*cos(3.4*t)';
      resetSimulation();
    }
    function resetSimulation() {
      m = parseFloat(document.getElementById('mass').value) || 1;
      k = parseFloat(document.getElementById('springConstant').value) || 4;
      const userC = parseFloat(document.getElementById('damping').value) || 0;
      c = (userC === 0) ? 0.000001 : userC;
      y0 = parseFloat(document.getElementById('initialDisplacement').value) || 0;
      v0 = parseFloat(document.getElementById('initialVelocity').value) || 0;
      forcingFunction = document.getElementById('forcingFunction').value;
      graphMaxTime = parseFloat(document.getElementById('endTime').value) || 60;
      const equationElement = document.getElementById('equation');
      if (equationElement) {
        try {
          let displayForcing = forcingFunction
            .replace(/u\(t(?:\s*-\s*([\d.]+))?\)/gi, (match, a) => a ? `u_{${a}}(t)` : `u(t)`)
            .replace(/heaviside\(t(?:\s*-\s*([\d.]+))?\)/gi, (match, a) => a ? `u_{${a}}(t)` : `u(t)`)
            .replace(/delta/gi, '\\delta')
            .replace(/\*/g, ' \\cdot ')
            .replace(/(cos|sin|tan|exp|log|sqrt)/g, '\\$1');
          katex.render(`${m.toFixed(1)}\\ddot{y} + ${userC.toFixed(1)}\\dot{y} + ${k.toFixed(1)}y = ${displayForcing}`, equationElement, { throwOnError: false });
        } catch (error) {
          console.error('KaTeX error:', error);
          equationElement.textContent = `${m.toFixed(1)}\\ddot{y} + ${userC.toFixed(1)}\\dot{y} + ${k.toFixed(1)}y = ${forcingFunction}`;
        }
      }
      y = y0;
      v = v0;
      t = 0;
      graphData.length = 0;
      graphData.push({ t, y });
      isSimulationRunning = true;
      isPaused = false;
      document.getElementById('pauseButton').textContent = 'Pause';
      firstStep = true;
      prevState = [y, v];
      currentState = [y, v];
      drawSpringMass();
      drawGraph();
      hideAlert();
    }
    function animate() {
      if (isSimulationRunning && !isPaused) {
        for (let i = 0; i < stepsPerFrame; i++) {
          updatePhysics();
          graphData.push({ t, y });
          if (t > graphMaxTime) {
            isSimulationRunning = false;
            break;
          }
        }
        drawSpringMass();
        drawGraph();
      }
      requestAnimationFrame(animate);
    }
    document.addEventListener('DOMContentLoaded', () => {
      const equationGeneral = document.getElementById('equationGeneral');
      if (equationGeneral) {
        katex.render("m\\ddot{y} + c\\dot{y} + ky = F(t)", equationGeneral, {
          throwOnError: false,
          displayMode: true
        });
      }
      // Render all .katex elements (inline)
      document.querySelectorAll('.katex').forEach(el => {
        katex.render(el.textContent, el, { throwOnError: false });
      });
      setupInputLinks();
      updateSimulationParameters();
      y = y0;
      v = v0;
      resetSimulation();
      animate();
    });
  </script>
</body>
</html>
