<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="description" content="Nonlinear Phase Diagram, Phase Portrait, System Trajectories, Direction Fields">
  <meta name="keywords" content="Nonlinear, Direction Fields, Phase Portraits, Phase Diagrams, Phase Plane Plotter, Phase Spaces, Phase Portrait Plotter, 2D Phase Plane, Systems of Differential Equations, Trajectories, Limit Cycles, Nonlinear Systems">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5B8PRB2WZT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments) }
    gtag('js', new Date());
    gtag('config', 'G-5B8PRB2WZT');
  </script>
  <title>Nonlinear Phase Plane Plotter</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f5f7fb; overflow-x: hidden; min-height: 100vh; }
    .page-container { max-width: 1800px; margin: 0 auto; padding-top: 80px; }
    .main-content { display: grid; grid-template-columns: 380px 1fr 380px; gap: 25px; align-items: start; }
    /* Left Panel: Controls */
    .controls-panel { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08); height: fit-content; position: sticky; top: 90px; }
    /* Center Panel: Graph */
    .graph-panel { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; align-items: center; }
    /* Right Panel: Examples */
    .examples-panel { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08); height: fit-content; position: sticky; top: 90px; }
    h1 { color: #1e293b; text-align: center; margin-bottom: 1.5rem; font-size: 2rem; grid-column: 1 / -1; margin-top: 0; }
    h2 { color: #1e293b; font-size: 1.5rem; margin-bottom: 1.2rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
    .system-equations { font-size: 0.9rem; margin: 0.5rem 0; min-height: 40px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb; }
    /* Compact input sections */
    .input-section { margin-bottom: 1.5rem; }
    .input-section-title { font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 0.8rem; display: flex; align-items: center; gap: 8px; }
    .input-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    .input-group label { font-size: 0.85rem; color: #4b5563; font-weight: 500; white-space: nowrap; }
    .input-group input { width: 100%; padding: 0.5rem 0.75rem; border: 1.5px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; }
    .input-group input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .range-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 0.5rem; }
    /* Arrow controls */
    .arrow-controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 0.5rem; }
    /* Checkbox and color grid */
    .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 0.5rem; }
    .checkbox-group { display: flex; align-items: center; gap: 8px; }
    .checkbox-group input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
    .checkbox-group label { font-size: 0.85rem; color: #4b5563; font-weight: 500; cursor: pointer; }
    .color-selector { display: flex; align-items: center; gap: 8px; }
    .color-selector label { font-size: 0.85rem; color: #4b5563; font-weight: 500; white-space: nowrap; }
    .color-selector select { width: 100%; padding: 0.4rem 0.6rem; border: 1.5px solid #d1d5db; border-radius: 6px; font-size: 0.85rem; background: white; cursor: pointer; }
    /* Buttons */
    .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1.5rem; }
    button { background: #3b82f6; color: white; border: none; padding: 0.6rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px; }
    button:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
    button.clear { background: #ef4444; }
    button.clear:hover { background: #dc2626; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
    button.download-btn { background: #10b981; width: 100%; margin-top: 10px; }
    button.download-btn:hover { background: #059669; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    /* Graph area */
    .equation-display { width: 100%; background: white; padding: 12px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border: 2px solid #3b82f6; text-align: center; margin-bottom: 15px; min-height: 60px; display: flex; align-items: center; justify-content: center; }
    #plot-container { position: relative; width: 700px; height: 500px; margin: 0 auto; }
    #field-canvas, #traj-canvas { position: absolute; top: 0; left: 0; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa; }
    #traj-canvas { pointer-events: none; background: transparent !important; }
    #instruction { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); width: 90%; max-width: 400px; padding: 0.6rem 1.5rem; border-radius: 30px; font-size: 0.85rem; font-weight: 600; color: #1e40af; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); z-index: 10; animation: float 3s ease-in-out infinite; border: 1px solid rgba(59, 130, 246, 0.3); text-align: center; }
    @keyframes float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-3px); } }
    .graph-footer { margin-top: 20px; padding-top: 15px; text-align: center; color: #6b7280; font-size: 0.8rem; width: 100%; max-width: 700px; border-top: 1px solid #e5e7eb; }
    /* Examples grid */
    .examples-grid { display: grid; grid-template-columns: 1fr; gap: 12px; max-height: 620px; overflow-y: auto; padding-right: 8px; }
    .examples-grid::-webkit-scrollbar { width: 6px; }
    .examples-grid::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .examples-grid::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    .example { cursor: pointer; padding: 12px; border-radius: 8px; transition: all 0.2s; border: 1px solid #e5e7eb; background: #f8fafc; }
    .example:hover { background-color: #f0f9ff; border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
    .example h3 { margin-bottom: 0.5rem; color: #1e293b; font-weight: 600; font-size: 0.95rem; }
    .example-equations { font-size: 0.8rem; margin: 0.3rem 0; }
    .domain { font-size: 0.7rem; color: #6b7280; margin-top: 0.3rem; font-style: italic; }
    /* Navbar */
    .nav-container { width: 100%; background: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); position: fixed; top: 0; left: 0; z-index: 100; }
    .nav-content { max-width: 1800px; margin: 0 auto; padding: 0.75rem 1.5rem; }
    .nav-links { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; }
    .nav-link { color: #4f46e5; font-weight: 600; font-size: 0.95rem; text-decoration: none; transition: color 0.2s; white-space: nowrap; }
    .nav-link:hover { color: #3730a3; }
    /* Responsive adjustments */
    @media (max-width: 1400px) { .main-content { grid-template-columns: 340px 1fr 340px; gap: 20px; } #plot-container { width: 600px; height: 450px; } }
    @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; grid-template-rows: auto auto auto; gap: 25px; } .controls-panel, .examples-panel { position: static; max-width: 800px; margin: 0 auto; width: 100%; } .examples-grid { max-height: 400px; grid-template-columns: repeat(2, 1fr); } #plot-container { width: 700px; height: 500px; } }
    @media (max-width: 768px) { body { padding: 10px; } .page-container { padding-top: 70px; } .main-content { gap: 20px; } .controls-panel, .graph-panel, .examples-panel { padding: 1rem; } .examples-grid { grid-template-columns: 1fr; max-height: 500px; } #plot-container { width: 100%; height: 400px; max-width: 500px; } .arrow-controls, .checkbox-grid { grid-template-columns: 1fr; } .nav-links { gap: 1rem; } .nav-link { font-size: 0.85rem; } }
    @media (max-width: 480px) { .range-grid { grid-template-columns: 1fr; } .button-group { grid-template-columns: 1fr; } #plot-container { height: 350px; } }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div class="nav-container">
    <div class="nav-content">
      <div class="nav-links">
        <a href="index.html" class="nav-link">Home</a>
        <a href="teaching.html" class="nav-link">Teaching</a>
        <a href="projects.html" class="nav-link">Diff Eq</a>
        <a href="linear.html" class="nav-link">Linear Algebra</a>
        <a href="numerical.html" class="nav-link">Numerical Methods</a>
      </div>
    </div>
  </div>

  <div class="page-container">
    <h1>Phase Portraits of Nonlinear Systems</h1>
    <div class="main-content">
      <!-- Left Panel: Controls -->
      <div class="controls-panel">
        <h2>Enter System </h2>
        <div class="input-section">
          <div class="input-grid">
            <div class="input-group">
              <label for="fInput">f(x, y) = dx/dt</label>
              <input type="text" id="fInput" placeholder="Enter expression for dx/dt" value="-x + y + x*y">
            </div>
            <div class="input-group">
              <label for="gInput">g(x, y) = dy/dt</label>
              <input type="text" id="gInput" placeholder="Enter expression for dy/dt" value="-x - y + y^2">
            </div>
          </div>
        </div>

        <h2>Enter Domain </h2>
        <div class="input-section">
          <div class="range-grid">
            <div class="input-group">
              <label for="xMin">X Min</label>
              <input type="number" id="xMin" value="-3">
            </div>
            <div class="input-group">
              <label for="xMax">X Max</label>
              <input type="number" id="xMax" value="3">
            </div>
            <div class="input-group">
              <label for="yMin">Y Min</label>
              <input type="number" id="yMin" value="-3">
            </div>
            <div class="input-group">
              <label for="yMax">Y Max</label>
              <input type="number" id="yMax" value="3">
            </div>
          </div>
        </div>

        <h2>Vector Field Settings</h2>
        <div class="input-section">
          <div class="arrow-controls">
            <div class="input-group">
              <label for="arrowCount">Arrows/Axis</label>
              <input type="number" id="arrowCount" value="30" min="10" max="40">
            </div>
            <div class="input-group">
              <label for="arrowLength">Arrow Length</label>
              <input type="number" id="arrowLength" value="20" min="5" max="50" step="1">
            </div>
            <div class="input-group">
              <label for="arrowThickness">Thickness</label>
              <input type="number" id="arrowThickness" value="0.75" min="0.5" max="3" step="0.1">
            </div>
          </div>
          <div class="checkbox-grid">
            <div class="checkbox-group">
              <input type="checkbox" id="variableArrows" checked>
              <label for="variableArrows">Variable length</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="showGrid" checked>
              <label for="showGrid">Show grid</label>
            </div>
          </div>
        </div>

        <h2>Trajectory Settings</h2>
        <div class="input-section">
          <div class="color-selector">
            <label for="trajColor">Trajectory Color:</label>
            <select id="trajColor">
              <option value="multicolor">Multicolor</option>
              <option value="blue">Blue</option>
              <option value="black">Black</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <button onclick="drawPhasePlane(true)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"></path>
              <line x1="16" y1="5" x2="22" y2="5"></line>
              <line x1="19" y1="2" x2="19" y2="8"></line>
              <circle cx="9" cy="9" r="2"></circle>
              <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
            </svg>
            Generate
          </button>
          <button class="clear" onclick="clearTrajectories()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Clear Traces
          </button>
        </div>
        <button class="download-btn" onclick="downloadImage()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download Image
        </button>
      </div>

      <!-- Center Panel: Graph -->
      <div class="graph-panel">
        <div class="equation-display" id="equation-display"></div>
        <div id="plot-container">
          <canvas id="field-canvas" width="700" height="500"></canvas>
          <canvas id="traj-canvas" width="700" height="500"></canvas>
          <div id="instruction">✨ Click anywhere on the graph to add trajectories</div>
        </div>
        <div class="graph-footer">
          <p>© 2025 Shelvean Kapita • kapita@tamu.edu • All code released under the <a href="https://opensource.org/licenses/MIT" target="_blank" class="text-blue-600 hover:underline">MIT License</a>. Last modified December 20, 2025</p>
        </div>
      </div>

      <!-- Right Panel: Examples -->
      <div class="examples-panel">
        <h2>Example Systems</h2>
        <div class="examples-grid">
          <div class="example" data-f="y" data-g="-0.1*y - sin(x)" data-xmin="-6.25" data-xmax="6.25" data-ymin="-5" data-ymax="5">
            <h3>Damped Pendulum</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y \\ \dot{y} = -0.1 y - \sin(x) \end{cases}</div>
            <div class="domain">Domain: [-6.25, 6.25] × [-5, 5]</div>
          </div>

          <div class="example" data-f="y" data-g="(1 - x^2)*y - x" data-xmin="-3.75" data-xmax="3.75" data-ymin="-3" data-ymax="3">
            <h3>Van der Pol Oscillator</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y \\ \dot{y} = (1 - x^2) y - x \end{cases}</div>
            <div class="domain">Domain: [-3.75, 3.75] × [-3, 3]</div>
          </div>

          <div class="example" data-f="1*x - 0.1*x*y" data-g="0.075*x*y - 1.5*y" data-xmin="0" data-xmax="50" data-ymin="0" data-ymax="30">
            <h3>Lotka-Volterra (Predator-Prey)</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x - 0.1 x y \\ \dot{y} = 0.075 x y - 1.5 y \end{cases}</div>
            <div class="domain">Domain: [0, 50] × [0, 30]</div>
          </div>

          <div class="example" data-f="y" data-g="x - x^3 - 0.15*y" data-xmin="-2" data-xmax="2" data-ymin="-2" data-ymax="2">
            <h3>Duffing Oscillator</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y \\ \dot{y} = x - x^3 - 0.15 y \end{cases}</div>
            <div class="domain">Domain: [-2, 2] × [-2, 2]</div>
          </div>

          <div class="example" data-f="2*x-y+3*(x^2-y^2)+2*x*y" data-g="x-3*y-3*(x^2-y^2)+3*x*y" data-xmin="-5" data-xmax="5" data-ymin="-5" data-ymax="5">
            <h3>Simple Nonlinear</h3>
            <div class="example-equations">\begin{cases} \dot{x} = 2x-y+3(x^2-y^2)+2xy \\ \dot{y} = x-3y-3(x^2-y^2)+3xy \end{cases}</div>
            <div class="domain">Domain: [-5, 5] × [-5, 5]</div>
          </div>

          <div class="example" data-f="-y + x*(1 - x^2 - y^2)" data-g="x + y*(1 - x^2 - y^2)" data-xmin="-2.5" data-xmax="2.5" data-ymin="-2" data-ymax="2">
            <h3>Limit Cycle (Polar)</h3>
            <div class="example-equations">\begin{cases} \dot{x} = -y + x(1 - x^2 - y^2) \\ \dot{y} = x + y(1 - x^2 - y^2) \end{cases}</div>
            <div class="domain">Domain: [-2.5, 2.5] × [-2, 2]</div>
          </div>

          <div class="example" data-f="y" data-g="-0.1*y-x*(1-x)" data-xmin="-2.5" data-xmax="2.5" data-ymin="-2" data-ymax="2">
            <h3>Escape Equation</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y \\ \dot{y} = -0.1y - x(1-x) \end{cases}</div>
            <div class="domain">Domain: [-2.5, 2.5] × [-2, 2]</div>
          </div>

          <div class="example" data-f="-x + y + x*y" data-g="-x - y + y^2" data-xmin="-3" data-xmax="3" data-ymin="-3" data-ymax="3">
            <h3>Nonlinear Focus</h3>
            <div class="example-equations">\begin{cases} \dot{x} = -x + y + xy \\ \dot{y} = -x - y + y^2 \end{cases}</div>
            <div class="domain">Domain: [-3, 3] × [-3, 3]</div>
          </div>

          <div class="example" data-f="x*(1 - x) - 0.5*x*y" data-g="y*(0.5*x - 0.8)" data-xmin="0" data-xmax="4" data-ymin="0" data-ymax="3">
            <h3>Competitive Lotka-Volterra</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x(1 - x) - 0.5 x y \\ \dot{y} = y(0.5 x - 0.8) \end{cases}</div>
            <div class="domain">Domain: [0, 4] × [0, 3]</div>
          </div>

          <div class="example" data-f="x - (x^3)/3 - y" data-g="0.08*(x + 0.7 - 0.8*y)" data-xmin="-2.5" data-xmax="2.5" data-ymin="-1" data-ymax="2.5">
            <h3>FitzHugh-Nagumo Model</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x - \frac{x^3}{3} - y \\ \dot{y} = 0.08 (x + 0.7 - 0.8 y) \end{cases}</div>
            <div class="domain">Domain: [-2.5, 2.5] × [-1, 2.5]</div>
          </div>

          <div class="example" data-f="1 + x^2*y - 4*x" data-g="3*x - x^2*y" data-xmin="0" data-xmax="4" data-ymin="0" data-ymax="5">
            <h3>Brusselator</h3>
            <div class="example-equations">\begin{cases} \dot{x} = 1 + x^2 y - 4 x \\ \dot{y} = 3 x - x^2 y \end{cases}</div>
            <div class="domain">Domain: [0, 4] × [0, 5]</div>
          </div>

          <div class="example" data-f="-x + 0.08*y + x^2*y" data-g="0.6 - 0.08*y - x^2*y" data-xmin="0" data-xmax="2" data-ymin="0" data-ymax="3">
            <h3>Selkov Glycolysis Model</h3>
            <div class="example-equations">\begin{cases} \dot{x} = -x + 0.08 y + x^2 y \\ \dot{y} = 0.6 - 0.08 y - x^2 y \end{cases}</div>
            <div class="domain">Domain: [0, 2] × [0, 3]</div>
          </div>

          <div class="example" data-f="y*(x - 1)" data-g="-x + y*(1 - 2*x)" data-xmin="-2" data-xmax="2" data-ymin="-2" data-ymax="2">
            <h3>Hopf Bifurcation (Supercritical)</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y(x - 1) \\ \dot{y} = -x + y(1 - 2x) \end{cases}</div>
            <div class="domain">Domain: [-2, 2] × [-2, 2]</div>
          </div>

          <div class="example" data-f="y + x*(x^2 + y^2 - 1)" data-g="-x + y*(x^2 + y^2 - 1)" data-xmin="-1.5" data-xmax="1.5" data-ymin="-1.5" data-ymax="1.5">
            <h3>Unstable Limit Cycle</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y + x(x^2 + y^2 - 1) \\ \dot{y} = -x + y(x^2 + y^2 - 1) \end{cases}</div>
            <div class="domain">Domain: [-1.5, 1.5] × [-1.5, 1.5]</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.min.js"></script>
  <script>
    // ------------------------------------------------------------------
    // Globals
    // ------------------------------------------------------------------
    let userPoints = [];
    let fCompiled, gCompiled;
    const fieldCanvas = document.getElementById("field-canvas");
    const trajCanvas = document.getElementById("traj-canvas");
    const fieldCtx = fieldCanvas.getContext("2d");
    const trajCtx = trajCanvas.getContext("2d");
    let instruction = document.getElementById("instruction");
    let trajectories = [];

    // ------------------------------------------------------------------
    // Init
    // ------------------------------------------------------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Render main equation
      katex.render('\\begin{cases}\n \\dot{x} = f(x, y) \\\\\n \\dot{y} = g(x, y)\n \\end{cases}', document.getElementById('equation-display'), { throwOnError: false, displayMode: true });

      // Setup example click handlers
      document.querySelectorAll('.example').forEach(example => {
        example.addEventListener('click', () => {
          userPoints = [];
          trajectories = [];
          trajCtx.clearRect(0, 0, trajCanvas.width, trajCanvas.height);
          document.getElementById('fInput').value = example.dataset.f;
          document.getElementById('gInput').value = example.dataset.g;
          document.getElementById('xMin').value = example.dataset.xmin;
          document.getElementById('xMax').value = example.dataset.xmax;
          document.getElementById('yMin').value = example.dataset.ymin;
          document.getElementById('yMax').value = example.dataset.ymax;
          instruction.style.display = 'block';
          drawPhasePlane(true);
        });

        // Render KaTeX for each example
        katex.render(example.querySelector('.example-equations').textContent, example.querySelector('.example-equations'), { throwOnError: false, displayMode: false });
      });

      // Canvas click handler for adding trajectories
      fieldCanvas.addEventListener("click", e => {
        const rect = fieldCanvas.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        const PADDING = 50;
        if (clickX < PADDING || clickX > fieldCanvas.width - PADDING || clickY < PADDING || clickY > fieldCanvas.height - PADDING) return;

        const xMin = +document.getElementById("xMin").value;
        const xMax = +document.getElementById("xMax").value;
        const yMin = +document.getElementById("yMin").value;
        const yMax = +document.getElementById("yMax").value;

        const normX = clickX / fieldCanvas.width;
        const normY = clickY / fieldCanvas.height;
        const sysX = xMin + normX * (xMax - xMin);
        const sysY = yMax - normY * (yMax - yMin);

        userPoints.push({ x: sysX, y: sysY });
        const trajPoints = computeTrajectory(fCompiled, gCompiled, sysX, sysY, xMin, xMax, yMin, yMax);
        trajectories.push(trajPoints);
        drawTrajectoryOnTrajCanvas(trajPoints, xMin, xMax, yMin, yMax);
        instruction.style.display = "none";
      });

      // Setup input change listeners for auto-update
      const setupInputListener = (id, eventType) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener(eventType, () => {
          userPoints = [];
          trajectories = [];
          trajCtx.clearRect(0, 0, trajCanvas.width, trajCanvas.height);
          drawPhasePlane(false);
        });
      };

      ['fInput', 'gInput', 'xMin', 'xMax', 'yMin', 'yMax', 'arrowCount', 'arrowLength', 'arrowThickness'].forEach(id => setupInputListener(id, 'input'));
      ['trajColor', 'showGrid', 'variableArrows'].forEach(id => setupInputListener(id, 'change'));

      // Initial draw
      drawPhasePlane(true);
    });

    // ------------------------------------------------------------------
    // Core Functions
    // ------------------------------------------------------------------
    function clearTrajectories() {
      userPoints = [];
      trajectories = [];
      trajCtx.clearRect(0, 0, trajCanvas.width, trajCanvas.height);
      instruction.style.display = "block";
    }

    function drawPhasePlane(clearTrajectoriesOnGenerate) {
      if (clearTrajectoriesOnGenerate) {
        clearTrajectories();
      }

      // Clear and setup canvas
      fieldCtx.fillStyle = '#fafafa';
      fieldCtx.fillRect(0, 0, fieldCanvas.width, fieldCanvas.height);

      // Compile functions
      const f = document.getElementById("fInput").value;
      const g = document.getElementById("gInput").value;
      try {
        fCompiled = math.compile(f);
        gCompiled = math.compile(g);
      } catch(e) {
        console.error("Error compiling functions:", e);
        fieldCtx.fillStyle = '#ef4444';
        fieldCtx.font = '16px Arial';
        fieldCtx.fillText('Error in function expressions', 20, 50);
        return;
      }

      // Get settings
      const xMin = +document.getElementById("xMin").value;
      const xMax = +document.getElementById("xMax").value;
      const yMin = +document.getElementById("yMin").value;
      const yMax = +document.getElementById("yMax").value;
      const arrowCount = +document.getElementById("arrowCount").value;
      const arrowLength = +document.getElementById("arrowLength").value || 20;
      const arrowThickness = +document.getElementById("arrowThickness").value || 0.75;
      const variableArrows = document.getElementById("variableArrows").checked;
      const showGrid = document.getElementById("showGrid").checked;

      // Render equation and draw
      renderEquationToCanvas(f, g);
      drawAxes(xMin, xMax, yMin, yMax, showGrid);
      drawVectorField(fCompiled, gCompiled, xMin, xMax, yMin, yMax, arrowCount, arrowLength, arrowThickness, variableArrows);

      // Redraw existing trajectories
      trajectories.forEach(traj => {
        drawTrajectoryOnTrajCanvas(traj, xMin, xMax, yMin, yMax);
      });
    }

    function drawVectorField(f, g, xMin, xMax, yMin, yMax, arrowCount, arrowLength, arrowThickness, variableArrows) {
      fieldCtx.lineWidth = arrowThickness;
      fieldCtx.strokeStyle = '#2563eb';
      fieldCtx.fillStyle = '#2563eb';

      const scope = { x: 0, y: 0 };
      const gridSpacingX = (xMax - xMin) / arrowCount;
      const gridSpacingY = (yMax - yMin) / arrowCount;
      const width = fieldCanvas.width;
      const height = fieldCanvas.height;
      const scaleX = width / (xMax - xMin);
      const scaleY = height / (yMax - yMin);
      const fixedArrowLength = arrowLength;

      for (let i = 0; i <= arrowCount; i++) {
        for (let j = 0; j <= arrowCount; j++) {
          const sysX = xMin + i * gridSpacingX;
          const sysY = yMin + j * gridSpacingY;
          let dx = 0, dy = 0;
          try {
            scope.x = sysX;
            scope.y = sysY;
            dx = f.evaluate(scope) || 0;
            dy = g.evaluate(scope) || 0;
          } catch (e) { continue; }

          const len = Math.sqrt(dx * dx + dy * dy);
          if (len === 0) continue;

          let drawLength = fixedArrowLength;
          if (variableArrows) {
            drawLength = fixedArrowLength * Math.min(1, 5 / len);
            drawLength = Math.max(drawLength, 5);
          }

          const deltaCanvasX = dx * scaleX * (drawLength / fixedArrowLength);
          const deltaCanvasY = -dy * scaleY * (drawLength / fixedArrowLength);
          const lenCanvas = Math.sqrt(deltaCanvasX ** 2 + deltaCanvasY ** 2);
          if (lenCanvas === 0) continue;

          const normDx = deltaCanvasX / lenCanvas;
          const normDy = deltaCanvasY / lenCanvas;

          const canvasX = (sysX - xMin) / (xMax - xMin) * width;
          const canvasY = (yMax - sysY) / (yMax - yMin) * height;

          const startX = canvasX - normDx * drawLength / 2;
          const startY = canvasY - normDy * drawLength / 2;
          const endX = canvasX + normDx * drawLength / 2;
          const endY = canvasY + normDy * drawLength / 2;

          // Draw shaft
          fieldCtx.beginPath();
          fieldCtx.moveTo(startX, startY);
          fieldCtx.lineTo(endX, endY);
          fieldCtx.stroke();

          // Draw filled arrowhead
          const headSize = Math.min(8, drawLength / 3 + 2);
          const angle = Math.atan2(normDy, normDx);
          fieldCtx.beginPath();
          fieldCtx.moveTo(endX, endY);
          fieldCtx.lineTo(endX - headSize * Math.cos(angle - Math.PI / 6), endY - headSize * Math.sin(angle - Math.PI / 6));
          fieldCtx.lineTo(endX - headSize * Math.cos(angle + Math.PI / 6), endY - headSize * Math.sin(angle + Math.PI / 6));
          fieldCtx.closePath();
          fieldCtx.fill();
        }
      }
    }

    function computeTrajectory(f, g, x0, y0, xMin, xMax, yMin, yMax) {
      const dt = 0.01;
      const maxSteps = 4000;
      const points = [{ x: x0, y: y0 }];
      const scope = { x: 0, y: 0 };

      // Forward integration (RK4)
      let x = x0, y = y0;
      scope.x = x; scope.y = y;
      for (let i = 0; i < maxSteps; i++) {
        try {
          const k1x = f.evaluate(scope), k1y = g.evaluate(scope);
          scope.x = x + k1x * dt / 2; scope.y = y + k1y * dt / 2;
          const k2x = f.evaluate(scope), k2y = g.evaluate(scope);
          scope.x = x + k2x * dt / 2; scope.y = y + k2y * dt / 2;
          const k3x = f.evaluate(scope), k3y = g.evaluate(scope);
          scope.x = x + k3x * dt; scope.y = y + k3y * dt;
          const k4x = f.evaluate(scope), k4y = g.evaluate(scope);

          x += (k1x + 2 * k2x + 2 * k3x + k4x) / 6 * dt;
          y += (k1y + 2 * k2y + 2 * k3y + k4y) / 6 * dt;

          if (x < xMin - 1 || x > xMax + 1 || y < yMin - 1 || y > yMax + 1) break;
          points.push({ x, y });
          scope.x = x; scope.y = y;
        } catch(e) { break; }
      }

      // Backward integration
      x = x0; y = y0;
      scope.x = x; scope.y = y;
      const backwardPoints = [];
      for (let i = 0; i < maxSteps; i++) {
        try {
          const k1x = f.evaluate(scope), k1y = g.evaluate(scope);
          scope.x = x - k1x * dt / 2; scope.y = y - k1y * dt / 2;
          const k2x = f.evaluate(scope), k2y = g.evaluate(scope);
          scope.x = x - k2x * dt / 2; scope.y = y - k2y * dt / 2;
          const k3x = f.evaluate(scope), k3y = g.evaluate(scope);
          scope.x = x - k3x * dt; scope.y = y - k3y * dt;
          const k4x = f.evaluate(scope), k4y = g.evaluate(scope);

          x -= (k1x + 2 * k2x + 2 * k3x + k4x) / 6 * dt;
          y -= (k1y + 2 * k2y + 2 * k3y + k4y) / 6 * dt;

          if (x < xMin - 1 || x > xMax + 1 || y < yMin - 1 || y > yMax + 1) break;
          backwardPoints.unshift({ x, y });
          scope.x = x; scope.y = y;
        } catch(e) { break; }
      }

      return [...backwardPoints, ...points];
    }

    function drawTrajectoryOnTrajCanvas(points, xMin, xMax, yMin, yMax) {
      if (points.length < 2) return;

      const trajColor = document.getElementById("trajColor").value;
      let color;
      if (trajColor === "multicolor") {
        const colors = ['#dc2626', '#ea580c', '#ca8a04', '#16a34a', '#0891b2', '#7c3aed', '#db2777', '#4b5563'];
        color = colors[trajectories.length % colors.length];
      } else if (trajColor === "blue") {
        color = '#3b82f6';
      } else if (trajColor === "black") {
        color = '#000000';
      }

      trajCtx.strokeStyle = color;
      trajCtx.lineWidth = 1.8;
      trajCtx.lineJoin = 'round';
      trajCtx.lineCap = 'round';
      trajCtx.beginPath();
      points.forEach((p, i) => {
        const cx = ((p.x - xMin) / (xMax - xMin)) * fieldCanvas.width;
        const cy = ((yMax - p.y) / (yMax - yMin)) * fieldCanvas.height;
        if (i === 0) trajCtx.moveTo(cx, cy);
        else trajCtx.lineTo(cx, cy);
      });
      trajCtx.stroke();
    }

    function renderEquationToCanvas(f, g) {
      const eqContainer = document.getElementById('equation-display');
      eqContainer.innerHTML = '';
      const formatExpr = (expr) => {
        return expr
          .replace(/\*/g, '·')
          .replace(/sin\(/g, '\\sin(')
          .replace(/cos\(/g, '\\cos(')
          .replace(/tan\(/g, '\\tan(')
          .replace(/\^/g, '^');
      };
      const eqString = `\\begin{cases} \\dot{x} = ${formatExpr(f)} \\\\ \\dot{y} = ${formatExpr(g)} \\end{cases}`;
      katex.render(eqString, eqContainer, { throwOnError: false, displayMode: true });
    }

    function drawAxes(xMin, xMax, yMin, yMax, showGrid) {
      if (showGrid) {
        fieldCtx.strokeStyle = 'rgba(200, 200, 200, 0.5)';
        fieldCtx.lineWidth = 0.5;
        const xStep = getNiceStep(xMax - xMin);
        for (let i = Math.ceil(xMin / xStep) * xStep; i < xMax; i += xStep) {
          const x = ((i - xMin) / (xMax - xMin)) * fieldCanvas.width;
          fieldCtx.beginPath();
          fieldCtx.moveTo(x, 0);
          fieldCtx.lineTo(x, fieldCanvas.height);
          fieldCtx.stroke();
        }
        const yStep = getNiceStep(yMax - yMin);
        for (let i = Math.ceil(yMin / yStep) * yStep; i < yMax; i += yStep) {
          const y = ((yMax - i) / (yMax - yMin)) * fieldCanvas.height;
          fieldCtx.beginPath();
          fieldCtx.moveTo(0, y);
          fieldCtx.lineTo(fieldCanvas.width, y);
          fieldCtx.stroke();
        }
      }

      // Draw axes
      fieldCtx.strokeStyle = '#000';
      fieldCtx.lineWidth = 2;
      if (yMin <= 0 && yMax >= 0) {
        const y0 = ((yMax - 0) / (yMax - yMin)) * fieldCanvas.height;
        fieldCtx.beginPath();
        fieldCtx.moveTo(0, y0);
        fieldCtx.lineTo(fieldCanvas.width, y0);
        fieldCtx.stroke();
      }
      if (xMin <= 0 && xMax >= 0) {
        const x0 = ((0 - xMin) / (xMax - xMin)) * fieldCanvas.width;
        fieldCtx.beginPath();
        fieldCtx.moveTo(x0, 0);
        fieldCtx.lineTo(x0, fieldCanvas.height);
        fieldCtx.stroke();
      }

      drawAxisLabels(xMin, xMax, yMin, yMax);
    }

    function getNiceStep(range) {
      const rough = range / 8;
      const exp = Math.pow(10, Math.floor(Math.log10(rough)));
      const frac = rough / exp;
      return (frac <= 1.5 ? 1 : frac <= 3.5 ? 2 : frac <= 7 ? 5 : 10) * exp;
    }

    function drawAxisLabels(xMin, xMax, yMin, yMax) {
      fieldCtx.font = 'bold 14px Arial';
      fieldCtx.fillStyle = '#111';
      fieldCtx.textAlign = 'center';
      fieldCtx.textBaseline = 'top';
      const xStep = getNiceStep(xMax - xMin);
      for (let i = Math.ceil(xMin / xStep) * xStep; i <= xMax + 1e-9; i += xStep) {
        const x = ((i - xMin) / (xMax - xMin)) * fieldCanvas.width;
        const y = fieldCanvas.height - 20;
        fieldCtx.fillText(i.toFixed(2).replace(/\.00$/, ''), x, y);
      }

      fieldCtx.textAlign = 'right';
      fieldCtx.textBaseline = 'middle';
      const yStep = getNiceStep(yMax - yMin);
      for (let i = Math.ceil(yMin / yStep) * yStep; i <= yMax + 1e-9; i += yStep) {
        const y = ((yMax - i) / (yMax - yMin)) * fieldCanvas.height;
        const x = 25;
        fieldCtx.fillText(i.toFixed(2).replace(/\.00$/, ''), x, y);
      }

      // Axis titles
      fieldCtx.textAlign = 'center';
      fieldCtx.textBaseline = 'top';
      fieldCtx.fillText('x', fieldCanvas.width / 2, fieldCanvas.height - 40);
      fieldCtx.save();
      fieldCtx.textAlign = 'center';
      fieldCtx.textBaseline = 'middle';
      fieldCtx.translate(15, fieldCanvas.height / 2);
      fieldCtx.rotate(-Math.PI / 2);
      fieldCtx.fillText('y', 0, 0);
      fieldCtx.restore();
    }

    function downloadImage() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = fieldCanvas.width;
      tempCanvas.height = fieldCanvas.height + 120;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.fillStyle = '#fafafa';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

      const f = document.getElementById("fInput").value;
      const g = document.getElementById("gInput").value;
      const xMin = +document.getElementById("xMin").value;
      const xMax = +document.getElementById("xMax").value;
      const yMin = +document.getElementById("yMin").value;
      const yMax = +document.getElementById("yMax").value;

      tempCtx.fillStyle = '#4f46e5';
      tempCtx.font = 'bold 16px Arial';
      tempCtx.textAlign = 'center';
      tempCtx.textBaseline = 'middle';
      tempCtx.fillText('Nonlinear Phase Portrait', tempCanvas.width / 2, 20);

      tempCtx.fillStyle = 'white';
      tempCtx.strokeStyle = '#3b82f6';
      tempCtx.lineWidth = 2;
      tempCtx.beginPath();
      tempCtx.roundRect(tempCanvas.width / 2 - 200, 40, 400, 40, 10);
      tempCtx.fill();
      tempCtx.stroke();

      tempCtx.fillStyle = '#1e293b';
      tempCtx.font = 'bold 14px Arial';
      const eqText = `x' = ${f}, y' = ${g}`;
      tempCtx.fillText(eqText, tempCanvas.width / 2, 60);

      tempCtx.font = '12px Arial';
      tempCtx.fillStyle = '#6b7280';
      tempCtx.fillText(`Domain: [${xMin}, ${xMax}] × [${yMin}, ${yMax}]`, tempCanvas.width / 2, 85);

      const graphCanvas = document.createElement('canvas');
      graphCanvas.width = fieldCanvas.width;
      graphCanvas.height = fieldCanvas.height;
      const graphCtx = graphCanvas.getContext('2d');
      graphCtx.fillStyle = '#fafafa';
      graphCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);
      graphCtx.drawImage(fieldCanvas, 0, 0);
      graphCtx.drawImage(trajCanvas, 0, 0);

      tempCtx.drawImage(graphCanvas, 0, 110);

      const link = document.createElement('a');
      link.download = 'nonlinear-phase-portrait.png';
      link.href = tempCanvas.toDataURL('image/png');
      link.click();
    }
  </script>
</body>
</html>
