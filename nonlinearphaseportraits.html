<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="description" content="Nonlinear Phase Diagram, Phase Portrait, System Trajectories, Direction Fields">
  <meta name="keywords" content="Nonlinear, Direction Fields, Phase Portraits, Phase Diagrams, Phase Plane Plotter, Phase Spaces, Phase Portrait Plotter, 2D Phase Plane, Systems of Differential Equations, Trajectories, Limit Cycles, Nonlinear Systems">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LEQE004C92"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LEQE004C92');
</script>
  <title>Nonlinear Phase Plane Plotter (Performance Optimized)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f5f7fb; overflow-x: hidden; min-height: 100vh; }
    .page-container { max-width: 1800px; margin: 0 auto; padding-top: 80px; }
    .main-content { display: grid; grid-template-columns: 380px 1fr 380px; gap: 25px; align-items: start; }
    .controls-panel { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08); height: fit-content; position: sticky; top: 90px; }
    .graph-panel { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; align-items: center; }
    .examples-panel { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08); height: fit-content; position: sticky; top: 90px; }
    h1 { color: #1e293b; text-align: center; margin-bottom: 1.5rem; font-size: 2rem; grid-column: 1 / -1; margin-top: 0; }
    h2 { color: #1e293b; font-size: 1.5rem; margin-bottom: 1.2rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
    .input-section { margin-bottom: 1.5rem; }
    .input-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    .input-group label { font-size: 0.85rem; color: #4b5563; font-weight: 500; white-space: nowrap; }
    .input-group input { width: 100%; padding: 0.5rem 0.75rem; border: 1.5px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; }
    .input-group input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .range-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 0.5rem; }
    .arrow-controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 0.5rem; }
    .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 0.5rem; }
    .checkbox-group { display: flex; align-items: center; gap: 8px; }
    .checkbox-group input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
    .checkbox-group label { font-size: 0.85rem; color: #4b5563; font-weight: 500; cursor: pointer; }
    .color-selector { display: flex; align-items: center; gap: 8px; }
    .color-selector label { font-size: 0.85rem; color: #4b5563; font-weight: 500; white-space: nowrap; }
    .color-selector select { width: 100%; padding: 0.4rem 0.6rem; border: 1.5px solid #d1d5db; border-radius: 6px; font-size: 0.85rem; background: white; cursor: pointer; }
    .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1.5rem; }
    button { background: #3b82f6; color: white; border: none; padding: 0.6rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px; }
    button:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
    button.clear { background: #ef4444; }
    button.clear:hover { background: #dc2626; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
    button.download-btn { background: #10b981; width: 100%; margin-top: 10px; }
    button.download-btn:hover { background: #059669; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .equation-display { width: 100%; background: white; padding: 12px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border: 2px solid #3b82f6; text-align: center; margin-bottom: 15px; min-height: 60px; display: flex; align-items: center; justify-content: center; }
    #plot-wrapper { position: relative; width: 700px; margin: 0 auto; }
    #plot-container { position: relative; width: 700px; height: 500px; }
    #field-canvas, #traj-canvas { position: absolute; top: 0; left: 0; border: 1px solid #e5e7eb; border-radius: 8px; background: #fafafa; }
    #traj-canvas { pointer-events: none; background: transparent !important; }
    #instruction { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); width: 90%; max-width: 400px; padding: 0.6rem 1.5rem; border-radius: 30px; font-size: 0.85rem; font-weight: 600; color: #1e40af; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); z-index: 10; animation: float 3s ease-in-out infinite; border: 1px solid rgba(59, 130, 246, 0.3); text-align: center; }
    @keyframes float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-3px); } }
    #x-labels { height: 40px; position: relative; margin-top: 10px; }
    #y-labels-container { position: absolute; left: -80px; top: 0; width: 70px; height: 500px; }
    .graph-footer { margin-top: 20px; padding-top: 15px; text-align: center; color: #6b7280; font-size: 0.8rem; width: 100%; max-width: 700px; border-top: 1px solid #e5e7eb; }
    .examples-grid { display: grid; grid-template-columns: 1fr; gap: 12px; max-height: 620px; overflow-y: auto; padding-right: 8px; }
    .examples-grid::-webkit-scrollbar { width: 6px; }
    .examples-grid::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .examples-grid::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    .example { cursor: pointer; padding: 12px; border-radius: 8px; transition: all 0.2s; border: 1px solid #e5e7eb; background: #f8fafc; }
    .example:hover { background-color: #f0f9ff; border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
    .example h3 { margin-bottom: 0.5rem; color: #1e293b; font-weight: 600; font-size: 0.95rem; }
    .example-equations { font-size: 0.8rem; margin: 0.3rem 0; }
    .domain { font-size: 0.7rem; color: #6b7280; margin-top: 0.3rem; font-style: italic; }
    .nav-container { width: 100%; background: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); position: fixed; top: 0; left: 0; z-index: 100; }
    .nav-content { max-width: 1800px; margin: 0 auto; padding: 0.75rem 1.5rem; }
    .nav-links { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; }
    .nav-link { color: #4f46e5; font-weight: 600; font-size: 0.95rem; text-decoration: none; transition: color 0.2s; white-space: nowrap; }
    .nav-link:hover { color: #3730a3; }
    @media (max-width: 1400px) { .main-content { grid-template-columns: 340px 1fr 340px; gap: 20px; } #plot-wrapper { width: 600px; } #plot-container { width: 600px; height: 450px; } }
    @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } .controls-panel, .examples-panel { position: static; max-width: 800px; margin: 0 auto; width: 100%; } .examples-grid { max-height: 400px; grid-template-columns: repeat(2, 1fr); } #plot-wrapper { width: 700px; } #plot-container { width: 700px; height: 500px; } }
    @media (max-width: 768px) { body { padding: 10px; } .page-container { padding-top: 70px; } #plot-wrapper { width: 100%; max-width: 500px; } #plot-container { width: 100%; height: 400px; } }
    @media (max-width: 480px) { .range-grid { grid-template-columns: 1fr; } .button-group { grid-template-columns: 1fr; } #plot-container { height: 350px; } }
  </style>
</head>
<body>
  <div class="nav-container">
    <div class="nav-content">
      <div class="nav-links">
        <a href="index.html" class="nav-link">Home</a>
        <a href="teaching.html" class="nav-link">Teaching</a>
        <a href="projects.html" class="nav-link">Diff Eq</a>
        <a href="linear.html" class="nav-link">Linear Algebra</a>
        <a href="numerical.html" class="nav-link">Numerical Methods</a>
      </div>
    </div>
  </div>

  <div class="page-container">
    <h1>Phase Portraits of Nonlinear Systems</h1>

    <div class="main-content">
      <div class="controls-panel">
        <h2>Enter System</h2>
        <div class="input-section">
          <div class="input-grid">
            <div class="input-group">
              <label for="fInput">f(x, y) = dx/dt</label>
              <input type="text" id="fInput" placeholder="Enter expression for dx/dt" value="-x + y + x*y">
            </div>
            <div class="input-group">
              <label for="gInput">g(x, y) = dy/dt</label>
              <input type="text" id="gInput" placeholder="Enter expression for dy/dt" value="-x - y + y^2">
            </div>
          </div>
        </div>

        <h2>Enter Domain</h2>
        <div class="input-section">
          <div class="range-grid">
            <div class="input-group"><label for="xMin">X Min</label><input type="number" id="xMin" value="-3"></div>
            <div class="input-group"><label for="xMax">X Max</label><input type="number" id="xMax" value="3"></div>
            <div class="input-group"><label for="yMin">Y Min</label><input type="number" id="yMin" value="-3"></div>
            <div class="input-group"><label for="yMax">Y Max</label><input type="number" id="yMax" value="3"></div>
          </div>
        </div>

        <h2>Vector Field Settings</h2>
        <div class="input-section">
          <div class="arrow-controls">
            <div class="input-group"><label for="arrowCount">Arrows/Axis</label><input type="number" id="arrowCount" value="30" min="10" max="40"></div>
            <div class="input-group"><label for="arrowLength">Arrow Length</label><input type="number" id="arrowLength" value="20" min="5" max="50" step="1"></div>
            <div class="input-group"><label for="arrowThickness">Thickness</label><input type="number" id="arrowThickness" value="0.6" min="0.3" max="2" step="0.1"></div>
          </div>
          <div class="checkbox-grid">
            <div class="checkbox-group"><input type="checkbox" id="variableArrows" checked><label for="variableArrows">Variable length</label></div>
            <div class="checkbox-group"><input type="checkbox" id="showGrid" checked><label for="showGrid">Show grid</label></div>
          </div>
          <div class="color-selector" style="margin-top: 10px;">
            <label for="fieldColor">Field Color:</label>
            <select id="fieldColor">
              <option value="#3b82f6">Blue</option>
              <option value="#dc2626">Red</option>
              <option value="#059669">Green</option>
              <option value="#7c3aed">Purple</option>
              <option value="#ea580c">Orange</option>
              <option value="#000000">Black</option>
            </select>
          </div>
        </div>

        <h2>Trajectory Settings</h2>
        <div class="input-section">
          <div class="color-selector">
            <label for="trajColor">Trajectory Color:</label>
            <select id="trajColor">
              <option value="multicolor">Multicolor</option>
              <option value="#3b82f6">Blue</option>
              <option value="#dc2626">Red</option>
              <option value="#000000">Black</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <button onclick="drawPhasePlane(true)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"></path>
              <line x1="16" y1="5" x2="22" y2="5"></line>
              <line x1="19" y1="2" x2="19" y2="8"></line>
              <circle cx="9" cy="9" r="2"></circle>
              <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
            </svg>
            Generate
          </button>
          <button class="clear" onclick="clearTrajectories()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Clear Traces
          </button>
        </div>
        <button class="download-btn" onclick="downloadImage()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download Image
        </button>
      </div>

      <div class="graph-panel">
        <div class="equation-display" id="equation-display"></div>
        <div id="plot-wrapper">
          <div id="y-labels-container"></div>
          <div id="plot-container">
            <canvas id="field-canvas" width="700" height="500"></canvas>
            <canvas id="traj-canvas" width="700" height="500"></canvas>
            <div id="instruction">✨ Click anywhere on the graph to add trajectories</div>
          </div>
          <div id="x-labels"></div>
          <div style="text-align: center; margin-top: 15px; font-weight: bold; color: #111;">x</div>
          <div style="position: absolute; left: -80px; top: 250px; width: 70px; writing-mode: vertical-rl; transform: rotate(180deg); font-weight: bold; color: #111;">y</div>
        </div>
        <div class="graph-footer">
          <p>© 2025 Shelvean Kapita • kapita@tamu.edu • All code released under the <a href="https://opensource.org/licenses/MIT" target="_blank" class="text-blue-600 hover:underline">MIT License</a>. Optimized January 16, 2026</p>
        </div>
      </div>

      <div class="examples-panel">
        <h2>Example Systems</h2>
        <div class="examples-grid">
          <div class="example" data-f="y" data-g="-0.1*y - sin(x)" data-xmin="-6.25" data-xmax="6.25" data-ymin="-5" data-ymax="5">
            <h3>Damped Pendulum</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y \\ \dot{y} = -0.1 y - \sin(x) \end{cases}</div>
            <div class="domain">Domain: [-6.25, 6.25] × [-5, 5]</div>
          </div>
          <div class="example" data-f="y" data-g="(1 - x^2)*y - x" data-xmin="-3.75" data-xmax="3.75" data-ymin="-3" data-ymax="3">
            <h3>Van der Pol Oscillator</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y \\ \dot{y} = (1 - x^2) y - x \end{cases}</div>
            <div class="domain">Domain: [-3.75, 3.75] × [-3, 3]</div>
          </div>
          <div class="example" data-f="1*x - 0.1*x*y" data-g="0.075*x*y - 1.5*y" data-xmin="0" data-xmax="50" data-ymin="0" data-ymax="30">
            <h3>Lotka-Volterra (Predator-Prey)</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x - 0.1 x y \\ \dot{y} = 0.075 x y - 1.5 y \end{cases}</div>
            <div class="domain">Domain: [0, 50] × [0, 30]</div>
          </div>
          <div class="example" data-f="y" data-g="x - x^3 - 0.15*y" data-xmin="-2" data-xmax="2" data-ymin="-2" data-ymax="2">
            <h3>Duffing Oscillator</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y \\ \dot{y} = x - x^3 - 0.15 y \end{cases}</div>
            <div class="domain">Domain: [-2, 2] × [-2, 2]</div>
          </div>
          <div class="example" data-f="x^2-y^3" data-g="2*x*(x^2-y)" data-xmin="-5" data-xmax="5" data-ymin="-5" data-ymax="5">
            <h3>Simple Nonlinear</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x^2-y^3 \\ \dot{y} = 2x(x^2-y) \end{cases}</div>
            <div class="domain">Domain: [-5, 5] × [-5, 5]</div>
          </div>
          <div class="example" data-f="-y + x*(1 - x^2 - y^2)" data-g="x + y*(1 - x^2 - y^2)" data-xmin="-2.5" data-xmax="2.5" data-ymin="-2" data-ymax="2">
            <h3>Limit Cycle (Polar)</h3>
            <div class="example-equations">\begin{cases} \dot{x} = -y + x(1 - x^2 - y^2) \\ \dot{y} = x + y(1 - x^2 - y^2) \end{cases}</div>
            <div class="domain">Domain: [-2.5, 2.5] × [-2, 2]</div>
          </div>
          <div class="example" data-f="y" data-g="-0.1*y-x*(1-x)" data-xmin="-2.5" data-xmax="2.5" data-ymin="-2" data-ymax="2">
            <h3>Escape Equation</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y \\ \dot{y} = -0.1y - x(1-x) \end{cases}</div>
            <div class="domain">Domain: [-2.5, 2.5] × [-2, 2]</div>
          </div>
          <div class="example" data-f="-x + y + x*y" data-g="-x - y + y^2" data-xmin="-3" data-xmax="3" data-ymin="-3" data-ymax="3">
            <h3>Nonlinear Focus</h3>
            <div class="example-equations">\begin{cases} \dot{x} = -x + y + xy \\ \dot{y} = -x - y + y^2 \end{cases}</div>
            <div class="domain">Domain: [-3, 3] × [-3, 3]</div>
          </div>
          <div class="example" data-f="x*(1 - x) - 0.5*x*y" data-g="y*(0.5*x - 0.8)" data-xmin="0" data-xmax="4" data-ymin="0" data-ymax="3">
            <h3>Competitive Lotka-Volterra</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x(1 - x) - 0.5 x y \\ \dot{y} = y(0.5 x - 0.8) \end{cases}</div>
            <div class="domain">Domain: [0, 4] × [0, 3]</div>
          </div>
          <div class="example" data-f="x*(1 - x - 0.5*y)" data-g="y*(1 - y - 0.6*x)" data-xmin="0" data-xmax="2" data-ymin="0" data-ymax="2">
            <h3>Competitive LV: Coexistence</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x(1 - x - 0.5 y) \\ \dot{y} = y(1 - y - 0.6 x) \end{cases}</div>
            <div class="domain">Domain: [0, 2] × [0, 2]</div>
          </div>
          <div class="example" data-f="x*(1 - x - 0.4*y)" data-g="y*(1 - y - 1.5*x)" data-xmin="0" data-xmax="2" data-ymin="-1" data-ymax="1">
            <h3>Competitive LV: Species 1 Wins</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x(1 - x - 0.4 y) \\ \dot{y} = y(1 - y - 1.5 x) \end{cases}</div>
            <div class="domain">Domain: [0, 2] × [-1, 1]</div>
          </div>
          <div class="example" data-f="x*(1 - x - 1.5*y)" data-g="y*(1 - y - 0.4*x)" data-xmin="-1" data-xmax="1" data-ymin="0" data-ymax="2">
            <h3>Competitive LV: Species 2 Wins</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x(1 - x - 1.5 y) \\ \dot{y} = y(1 - y - 0.4 x) \end{cases}</div>
            <div class="domain">Domain: [-1, 1] × [0, 2]</div>
          </div>
          <div class="example" data-f="x*(-0.2 - x - 0.5*y)" data-g="y*(-0.2 - y - 0.5*x)" data-xmin="-1" data-xmax="1" data-ymin="-1" data-ymax="1">
            <h3>Competitive LV: Both Extinct</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x(-0.2 - x - 0.5 y) \\ \dot{y} = y(-0.2 - y - 0.5 x) \end{cases}</div>
            <div class="domain">Domain: [-1, 1] × [-1, 1]</div>
          </div>
          <div class="example" data-f="x - (x^3)/3 - y" data-g="0.08*(x + 0.7 - 0.8*y)" data-xmin="-2.5" data-xmax="2.5" data-ymin="-1" data-ymax="2.5">
            <h3>FitzHugh-Nagumo Model</h3>
            <div class="example-equations">\begin{cases} \dot{x} = x - \frac{x^3}{3} - y \\ \dot{y} = 0.08 (x + 0.7 - 0.8 y) \end{cases}</div>
            <div class="domain">Domain: [-2.5, 2.5] × [-1, 2.5]</div>
          </div>
          <div class="example" data-f="1 + x^2*y - 4*x" data-g="3*x - x^2*y" data-xmin="0" data-xmax="4" data-ymin="0" data-ymax="5">
            <h3>Brusselator</h3>
            <div class="example-equations">\begin{cases} \dot{x} = 1 + x^2 y - 4 x \\ \dot{y} = 3 x - x^2 y \end{cases}</div>
            <div class="domain">Domain: [0, 4] × [0, 5]</div>
          </div>
          <div class="example" data-f="-x + 0.08*y + x^2*y" data-g="0.6 - 0.08*y - x^2*y" data-xmin="0" data-xmax="2" data-ymin="0" data-ymax="3">
            <h3>Selkov Glycolysis Model</h3>
            <div class="example-equations">\begin{cases} \dot{x} = -x + 0.08 y + x^2 y \\ \dot{y} = 0.6 - 0.08 y - x^2 y \end{cases}</div>
            <div class="domain">Domain: [0, 2] × [0, 3]</div>
          </div>
          <div class="example" data-f="y*(x - 1)" data-g="-x + y*(1 - 2*x)" data-xmin="-2" data-xmax="2" data-ymin="-2" data-ymax="2">
            <h3>Hopf Bifurcation</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y(x - 1) \\ \dot{y} = -x + y(1 - 2x) \end{cases}</div>
            <div class="domain">Domain: [-2, 2] × [-2, 2]</div>
          </div>
          <div class="example" data-f="y + x*(x^2 + y^2 - 1)" data-g="-x + y*(x^2 + y^2 - 1)" data-xmin="-2.0" data-xmax="2.0" data-ymin="-1.5" data-ymax="1.5">
            <h3>Unstable Limit Cycle</h3>
            <div class="example-equations">\begin{cases} \dot{x} = y + x(x^2 + y^2 - 1) \\ \dot{y} = -x + y(x^2 + y^2 - 1) \end{cases}</div>
            <div class="domain">Domain: [-2.0, 2.0] × [-1.5, 1.5]</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.min.js"></script>
  <script>
    // ========================================
    // PERFORMANCE OPTIMIZATION: Utility Functions
    // ========================================

    /**
     * Debounce function - prevents function from being called too frequently
     * Waits for 'delay' ms of inactivity before executing the function
     */
    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }

    /**
     * Throttle function - limits function execution to once per 'limit' ms
     * Ensures function runs at most once per time period
     */
    function throttle(func, limit) {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }

    let userPoints = [];
    let fCompiled, gCompiled;
    const fieldCanvas = document.getElementById("field-canvas");
    const trajCanvas = document.getElementById("traj-canvas");
    const fieldCtx = fieldCanvas.getContext("2d");
    const trajCtx = trajCanvas.getContext("2d");
    let instruction = document.getElementById("instruction");
    let trajectories = [];

    document.addEventListener("DOMContentLoaded", () => {
      // OPTIMIZATION: Render to specific element only
      katex.render('\\begin{cases} \\dot{x} = f(x, y) \\\\ \\dot{y} = g(x, y) \\end{cases}', document.getElementById('equation-display'), { throwOnError: false, displayMode: true });

      document.querySelectorAll('.example').forEach(example => {
        example.addEventListener('click', () => {
          userPoints = [];
          trajectories = [];
          trajCtx.clearRect(0, 0, trajCanvas.width, trajCanvas.height);
          document.getElementById('fInput').value = example.dataset.f;
          document.getElementById('gInput').value = example.dataset.g;
          document.getElementById('xMin').value = example.dataset.xmin;
          document.getElementById('xMax').value = example.dataset.xmax;
          document.getElementById('yMin').value = example.dataset.ymin;
          document.getElementById('yMax').value = example.dataset.ymax;
          instruction.style.display = 'block';
          drawPhasePlane(true);
        });
        // OPTIMIZATION: Render to specific element only
        katex.render(example.querySelector('.example-equations').textContent, example.querySelector('.example-equations'), { throwOnError: false, displayMode: false });
      });

      fieldCanvas.addEventListener("click", e => {
        const rect = fieldCanvas.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        const PADDING = 5;
        if (clickX < PADDING || clickX > fieldCanvas.width - PADDING || clickY < PADDING || clickY > fieldCanvas.height - PADDING) return;

        const xMin = +document.getElementById("xMin").value;
        const xMax = +document.getElementById("xMax").value;
        const yMin = +document.getElementById("yMin").value;
        const yMax = +document.getElementById("yMax").value;

        const normX = clickX / fieldCanvas.width;
        const normY = clickY / fieldCanvas.height;
        const sysX = xMin + normX * (xMax - xMin);
        const sysY = yMax - normY * (yMax - yMin);

        userPoints.push({ x: sysX, y: sysY });
        const trajPoints = computeTrajectory(fCompiled, gCompiled, sysX, sysY, xMin, xMax, yMin, yMax);
        trajectories.push(trajPoints);
        drawTrajectoryOnTrajCanvas(trajPoints, xMin, xMax, yMin, yMax);
        instruction.style.display = "none";
      });

      // OPTIMIZATION: Debounced redraw function for equation and domain inputs
      const debouncedRedraw = debounce(() => {
        userPoints = [];
        trajectories = [];
        trajCtx.clearRect(0, 0, trajCanvas.width, trajCanvas.height);
        drawPhasePlane(false);
      }, 300);

      // OPTIMIZATION: Throttled redraw for arrow controls
      const throttledRedraw = throttle(() => {
        drawPhasePlane(false);
      }, 100);

      // OPTIMIZATION: Separate handler for field color (doesn't need to clear trajectories)
      const fieldColorRedraw = () => {
        drawPhasePlane(false); // Redraw field without clearing trajectories
      };

      // Apply debounced listeners to equation inputs and domain inputs
      ['fInput', 'gInput', 'xMin', 'xMax', 'yMin', 'yMax'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', debouncedRedraw);
      });

      // Apply throttled listeners to arrow controls
      ['arrowCount', 'arrowLength', 'arrowThickness'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', throttledRedraw);
      });

      // Field color - separate handler that doesn't clear trajectories
      const fieldColorEl = document.getElementById('fieldColor');
      if (fieldColorEl) fieldColorEl.addEventListener('change', fieldColorRedraw);

      // Trajectory color and checkboxes - use throttled redraw
      const trajColorEl = document.getElementById('trajColor');
      if (trajColorEl) trajColorEl.addEventListener('change', throttledRedraw);

      ['showGrid', 'variableArrows'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', throttledRedraw);
      });

      drawPhasePlane(true);
    });

    function clearTrajectories() {
      userPoints = [];
      trajectories = [];
      trajCtx.clearRect(0, 0, trajCanvas.width, trajCanvas.height);
      instruction.style.display = "block";
    }

    function drawPhasePlane(clearTrajectoriesOnGenerate) {
      if (clearTrajectoriesOnGenerate) clearTrajectories();

      fieldCtx.fillStyle = '#fafafa';
      fieldCtx.fillRect(0, 0, fieldCanvas.width, fieldCanvas.height);

      const f = document.getElementById("fInput").value;
      const g = document.getElementById("gInput").value;
      try {
        fCompiled = math.compile(f);
        gCompiled = math.compile(g);
      } catch(e) {
        console.error("Error compiling functions:", e);
        fieldCtx.fillStyle = '#ef4444';
        fieldCtx.font = '16px Arial';
        fieldCtx.fillText('Error in function expressions', 20, 50);
        return;
      }

      const xMin = +document.getElementById("xMin").value;
      const xMax = +document.getElementById("xMax").value;
      const yMin = +document.getElementById("yMin").value;
      const yMax = +document.getElementById("yMax").value;
      const arrowCount = +document.getElementById("arrowCount").value;
      const arrowLength = +document.getElementById("arrowLength").value || 20;
      const arrowThickness = +document.getElementById("arrowThickness").value || 0.75;
      const variableArrows = document.getElementById("variableArrows").checked;
      const showGrid = document.getElementById("showGrid").checked;
      const fieldColor = document.getElementById("fieldColor").value;

      renderEquationToCanvas(f, g);
      drawAxes(xMin, xMax, yMin, yMax, showGrid);
      drawVectorField(fCompiled, gCompiled, xMin, xMax, yMin, yMax, arrowCount, arrowLength, arrowThickness, variableArrows, fieldColor);

      trajectories.forEach(traj => drawTrajectoryOnTrajCanvas(traj, xMin, xMax, yMin, yMax));
    }

    function drawVectorField(f, g, xMin, xMax, yMin, yMax, arrowCount, arrowLength, arrowThickness, variableArrows, color) {
      fieldCtx.lineWidth = arrowThickness;
      fieldCtx.strokeStyle = color;
      fieldCtx.fillStyle = color;
      const scope = { x: 0, y: 0 };
      const gridSpacingX = (xMax - xMin) / arrowCount;
      const gridSpacingY = (yMax - yMin) / arrowCount;
      const width = fieldCanvas.width;
      const height = fieldCanvas.height;
      const scaleX = width / (xMax - xMin);
      const scaleY = height / (yMax - yMin);
      const fixedArrowLength = arrowLength;

      // OPTIMIZATION: Collect all arrow data before drawing
      const arrowShafts = [];
      const arrowHeads = [];

      for (let i = 0; i <= arrowCount; i++) {
        for (let j = 0; j <= arrowCount; j++) {
          const sysX = xMin + i * gridSpacingX;
          const sysY = yMin + j * gridSpacingY;
          let dx = 0, dy = 0;
          try {
            scope.x = sysX; scope.y = sysY;
            dx = f.evaluate(scope) || 0;
            dy = g.evaluate(scope) || 0;
          } catch (e) { continue; }

          const len = Math.sqrt(dx * dx + dy * dy);
          if (len === 0) continue;

          let drawLength = fixedArrowLength;
          if (variableArrows) {
            drawLength = fixedArrowLength * Math.min(1, 5 / len);
            drawLength = Math.max(drawLength, 5);
          }

          const deltaCanvasX = dx * scaleX * (drawLength / fixedArrowLength);
          const deltaCanvasY = -dy * scaleY * (drawLength / fixedArrowLength);
          const lenCanvas = Math.sqrt(deltaCanvasX ** 2 + deltaCanvasY ** 2);
          if (lenCanvas === 0) continue;

          const normDx = deltaCanvasX / lenCanvas;
          const normDy = deltaCanvasY / lenCanvas;

          const canvasX = (sysX - xMin) / (xMax - xMin) * width;
          const canvasY = (yMax - sysY) / (yMax - yMin) * height;

          const startX = canvasX - normDx * drawLength / 2;
          const startY = canvasY - normDy * drawLength / 2;
          const endX = canvasX + normDx * drawLength / 2;
          const endY = canvasY + normDy * drawLength / 2;

          // Store shaft data
          arrowShafts.push({ startX, startY, endX, endY });

          // Store arrowhead data - refined design with smaller, narrower heads
          const headSize = Math.min(4, drawLength / 5);
          const angle = Math.atan2(normDy, normDx);
          arrowHeads.push({ endX, endY, headSize, angle });
        }
      }

      // OPTIMIZATION: Draw all shafts in a single path
      fieldCtx.beginPath();
      arrowShafts.forEach(shaft => {
        fieldCtx.moveTo(shaft.startX, shaft.startY);
        fieldCtx.lineTo(shaft.endX, shaft.endY);
      });
      fieldCtx.stroke();

      // OPTIMIZATION: Draw all arrowheads - refined with narrower angle
      arrowHeads.forEach(head => {
        fieldCtx.beginPath();
        fieldCtx.moveTo(head.endX, head.endY);
        // Narrower arrowhead angle (Math.PI / 8 = 22.5° instead of 30°)
        fieldCtx.lineTo(head.endX - head.headSize * Math.cos(head.angle - Math.PI / 8), head.endY - head.headSize * Math.sin(head.angle - Math.PI / 8));
        fieldCtx.lineTo(head.endX - head.headSize * Math.cos(head.angle + Math.PI / 8), head.endY - head.headSize * Math.sin(head.angle + Math.PI / 8));
        fieldCtx.closePath();
        fieldCtx.fill();
      });
    }

    function computeTrajectory(f, g, x0, y0, xMin, xMax, yMin, yMax) {
      const dt = 0.001;
      // OPTIMIZATION: Reduced from 15000 to 5000
      const maxSteps = 5000;
      const points = [{ x: x0, y: y0 }];
      const scope = { x: 0, y: 0 };

      // Forward integration
      let x = x0, y = y0;
      scope.x = x; scope.y = y;
      for (let i = 0; i < maxSteps; i++) {
        try {
          const k1x = f.evaluate(scope), k1y = g.evaluate(scope);
          scope.x = x + k1x * dt / 2; scope.y = y + k1y * dt / 2;
          const k2x = f.evaluate(scope), k2y = g.evaluate(scope);
          scope.x = x + k2x * dt / 2; scope.y = y + k2y * dt / 2;
          const k3x = f.evaluate(scope), k3y = g.evaluate(scope);
          scope.x = x + k3x * dt; scope.y = y + k3y * dt;
          const k4x = f.evaluate(scope), k4y = g.evaluate(scope);

          x += (k1x + 2*k2x + 2*k3x + k4x)/6 * dt;
          y += (k1y + 2*k2y + 2*k3y + k4y)/6 * dt;

          if (x < xMin - 1 || x > xMax + 1 || y < yMin - 1 || y > yMax + 1) break;

          // OPTIMIZATION: Early termination for near-equilibrium
          const speed = Math.sqrt(k1x * k1x + k1y * k1y);
          if (points.length > 10 && speed < 1e-4) break;

          points.push({ x, y });
          scope.x = x; scope.y = y;

          // OPTIMIZATION: Stop if we have enough points
          if (points.length > 2000) break;
        } catch(e) { break; }
      }

      // Backward integration
      x = x0; y = y0;
      scope.x = x; scope.y = y;
      const backwardPoints = [];
      for (let i = 0; i < maxSteps; i++) {
        try {
          const k1x = f.evaluate(scope), k1y = g.evaluate(scope);
          scope.x = x - k1x * dt / 2; scope.y = y - k1y * dt / 2;
          const k2x = f.evaluate(scope), k2y = g.evaluate(scope);
          scope.x = x - k2x * dt / 2; scope.y = y - k2y * dt / 2;
          const k3x = f.evaluate(scope), k3y = g.evaluate(scope);
          scope.x = x - k3x * dt; scope.y = y - k3y * dt;
          const k4x = f.evaluate(scope), k4y = g.evaluate(scope);

          x -= (k1x + 2*k2x + 2*k3x + k4x)/6 * dt;
          y -= (k1y + 2*k2y + 2*k3y + k4y)/6 * dt;

          if (x < xMin - 1 || x > xMax + 1 || y < yMin - 1 || y > yMax + 1) break;

          // OPTIMIZATION: Early termination for near-equilibrium
          const speed = Math.sqrt(k1x * k1x + k1y * k1y);
          if (backwardPoints.length > 10 && speed < 1e-4) break;

          backwardPoints.unshift({ x, y });
          scope.x = x; scope.y = y;

          // OPTIMIZATION: Stop if we have enough points
          if (backwardPoints.length > 1000) break;
        } catch(e) { break; }
      }

      return [...backwardPoints, ...points];
    }

    function drawTrajectoryOnTrajCanvas(points, xMin, xMax, yMin, yMax) {
      if (points.length < 2) return;

      const trajColor = document.getElementById("trajColor").value;
      let color = trajColor === "multicolor" ?
        ['#dc2626', '#ea580c', '#ca8a04', '#16a34a', '#0891b2', '#7c3aed', '#db2777', '#4b5563'][trajectories.length % 8] :
        trajColor;

      trajCtx.strokeStyle = color;
      trajCtx.lineWidth = 1.8;
      trajCtx.lineJoin = 'round';
      trajCtx.lineCap = 'round';
      trajCtx.beginPath();
      points.forEach((p, i) => {
        const cx = ((p.x - xMin) / (xMax - xMin)) * fieldCanvas.width;
        const cy = ((yMax - p.y) / (yMax - yMin)) * fieldCanvas.height;
        i === 0 ? trajCtx.moveTo(cx, cy) : trajCtx.lineTo(cx, cy);
      });
      trajCtx.stroke();
    }

    function renderEquationToCanvas(f, g) {
      const eqContainer = document.getElementById('equation-display');
      eqContainer.innerHTML = '';
      const formatExpr = expr => expr.replace(/\*/g, '·').replace(/\^/g, '^');
      const eqString = `\\begin{cases} \\dot{x} = ${formatExpr(f)} \\\\ \\dot{y} = ${formatExpr(g)} \\end{cases}`;
      // OPTIMIZATION: Render to specific element
      katex.render(eqString, eqContainer, { throwOnError: false, displayMode: true });
    }

    function getNiceStep(range) {
      const rough = range / 8;
      const exp = Math.pow(10, Math.floor(Math.log10(rough)));
      const frac = rough / exp;
      return (frac <= 1.5 ? 1 : frac <= 3.5 ? 2 : frac <= 7 ? 5 : 10) * exp;
    }

    function drawAxes(xMin, xMax, yMin, yMax, showGrid) {
      if (showGrid) {
        fieldCtx.strokeStyle = 'rgba(200, 200, 200, 0.5)';
        fieldCtx.lineWidth = 0.5;
        const xStep = getNiceStep(xMax - xMin);
        for (let i = Math.ceil(xMin / xStep) * xStep; i < xMax + 1e-9; i += xStep) {
          const x = ((i - xMin) / (xMax - xMin)) * fieldCanvas.width;
          fieldCtx.beginPath(); fieldCtx.moveTo(x, 0); fieldCtx.lineTo(x, fieldCanvas.height); fieldCtx.stroke();
        }
        const yStep = getNiceStep(yMax - yMin);
        for (let i = Math.ceil(yMin / yStep) * yStep; i < yMax + 1e-9; i += yStep) {
          const y = ((yMax - i) / (yMax - yMin)) * fieldCanvas.height;
          fieldCtx.beginPath(); fieldCtx.moveTo(0, y); fieldCtx.lineTo(fieldCanvas.width, y); fieldCtx.stroke();
        }
      }

      fieldCtx.strokeStyle = '#000';
      fieldCtx.lineWidth = 2;
      if (yMin <= 0 && yMax >= 0) {
        const y0 = ((yMax - 0) / (yMax - yMin)) * fieldCanvas.height;
        fieldCtx.beginPath(); fieldCtx.moveTo(0, y0); fieldCtx.lineTo(fieldCanvas.width, y0); fieldCtx.stroke();
      }
      if (xMin <= 0 && xMax >= 0) {
        const x0 = ((0 - xMin) / (xMax - xMin)) * fieldCanvas.width;
        fieldCtx.beginPath(); fieldCtx.moveTo(x0, 0); fieldCtx.lineTo(x0, fieldCanvas.height); fieldCtx.stroke();
      }

      drawExternalAxisLabels(xMin, xMax, yMin, yMax);
    }

    function drawExternalAxisLabels(xMin, xMax, yMin, yMax) {
      const xLabels = document.getElementById('x-labels');
      const yLabels = document.getElementById('y-labels-container');
      xLabels.innerHTML = '';
      yLabels.innerHTML = '';

      const xStep = getNiceStep(xMax - xMin);
      for (let i = Math.ceil(xMin / xStep) * xStep; i <= xMax + 1e-9; i += xStep) {
        const pos = ((i - xMin) / (xMax - xMin)) * fieldCanvas.width;
        const div = document.createElement('div');
        div.textContent = i.toFixed(2).replace(/\.00$/, '');
        div.style.position = 'absolute';
        div.style.left = `${pos}px`;
        div.style.transform = 'translateX(-50%)';
        div.style.font = 'bold 14px Arial';
        div.style.color = '#111';
        xLabels.appendChild(div);
      }

      const yStep = getNiceStep(yMax - yMin);
      for (let i = Math.ceil(yMin / yStep) * yStep; i <= yMax + 1e-9; i += yStep) {
        const posY = ((yMax - i) / (yMax - yMin)) * fieldCanvas.height;
        const div = document.createElement('div');
        div.textContent = i.toFixed(2).replace(/\.00$/, '');
        div.style.position = 'absolute';
        div.style.right = '8px';
        div.style.top = `${posY}px`;
        div.style.transform = 'translateY(-50%)';
        div.style.font = 'bold 14px Arial';
        div.style.color = '#111';
        yLabels.appendChild(div);
      }
    }

    function downloadImage() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = fieldCanvas.width;
      tempCanvas.height = fieldCanvas.height + 120;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.fillStyle = '#fafafa';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

      const f = document.getElementById("fInput").value;
      const g = document.getElementById("gInput").value;
      const xMin = +document.getElementById("xMin").value;
      const xMax = +document.getElementById("xMax").value;
      const yMin = +document.getElementById("yMin").value;
      const yMax = +document.getElementById("yMax").value;

      tempCtx.fillStyle = '#4f46e5';
      tempCtx.font = 'bold 16px Arial';
      tempCtx.textAlign = 'center';
      tempCtx.fillText('Nonlinear Phase Portrait', tempCanvas.width / 2, 20);

      tempCtx.fillStyle = 'white';
      tempCtx.strokeStyle = '#3b82f6';
      tempCtx.lineWidth = 2;
      tempCtx.beginPath();
      tempCtx.roundRect(tempCanvas.width / 2 - 200, 40, 400, 40, 10);
      tempCtx.fill();
      tempCtx.stroke();

      tempCtx.fillStyle = '#1e293b';
      tempCtx.font = 'bold 14px Arial';
      tempCtx.fillText(`x' = ${f}, y' = ${g}`, tempCanvas.width / 2, 60);

      tempCtx.font = '12px Arial';
      tempCtx.fillStyle = '#6b7280';
      tempCtx.fillText(`Domain: [${xMin}, ${xMax}] × [${yMin}, ${yMax}]`, tempCanvas.width / 2, 85);

      const graphCanvas = document.createElement('canvas');
      graphCanvas.width = fieldCanvas.width;
      graphCanvas.height = fieldCanvas.height;
      const gCtx = graphCanvas.getContext('2d');
      gCtx.fillStyle = '#fafafa';
      gCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);
      gCtx.drawImage(fieldCanvas, 0, 0);
      gCtx.drawImage(trajCanvas, 0, 0);
      tempCtx.drawImage(graphCanvas, 0, 110);

      const link = document.createElement('a');
      link.download = 'nonlinear-phase-portrait.png';
      link.href = tempCanvas.toDataURL('image/png');
      link.click();
    }
  </script>
</body>
</html>
